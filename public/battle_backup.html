<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BeatNexus â€“ Battle</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <style>
    :root { --accent: #55dde0; --accent-dark: #33b5b8; }
    body {
      margin: 0;
      background: var(--bg-1);
      color: var(--text-1);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #111111, #222222);
    }
    
    /* ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
    #page-title {
      font-family: 'Russo One', sans-serif;
      text-align: center;
      color: var(--accent);
      font-size: 3rem;
      margin: 0;
      padding: 0.5rem 0;
      text-shadow: 0 2px 10px rgba(85, 221, 224, 0.4);
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 50;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(5px);
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’å°ã•ã */
    @media (max-width: 767px) {
      #page-title {
        font-size: 2rem;
        padding: 0.3rem 0;
      }
      
      #battle-wrap {
        margin-top: 3rem;
      }
    }
    
    #overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Russo One', sans-serif;
      font-size: 5rem;
      color: var(--accent);
      background: rgba(0, 0, 0, .8);
      z-index: 100;
    }
    #battle-wrap {
      text-align: center;
      padding: 1rem;
      width: 100%;
      max-width: 1280px;
    }
    #phase {
      font-family: 'Russo One', sans-serif;
      font-size: 1.6rem;
      margin-bottom: 0.5rem;
      color: var(--accent);
    }
    .timer-container { 
      margin: 1rem 0; 
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      position: relative;
    }
    #timer {
      font-family: 'Russo One', sans-serif;
      font-size: 6rem;
      color: var(--accent);
      display: inline-block;
      text-shadow: 0 2px 12px rgba(85, 221, 224, 0.4);
    }
    .unit {
      font-family: 'Russo One', sans-serif;
      font-size: 2rem;
      color: var(--accent);
      display: inline-block;
      margin-left: 0.2rem;
    }
    #videos {
      display: flex;
      gap: 1.5rem;
      justify-content: center;
      width: 100%;
    }
    .video-wrap {
      position: relative;
      width: 45%;
      min-width: 280px;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
      border: 2px solid rgba(255,255,255,0.1);
    }
    video {
      width: 100%;
      height: 100%;
      border-radius: var(--radius);
      object-fit: cover;
      background-color: var(--bg-2);
    }
    .nameTag {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 0.9rem;
      font-weight: 600;
      z-index: 2;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* PCç‰ˆã§ã®åå‰ã‚¿ã‚°ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    @media (min-width: 768px) {
      .nameTag {
        font-size: 1rem;
        padding: 6px 16px;
      }
    }
    
    /* ã‚«ãƒ¡ãƒ©ç„¡ã—ã®å ´åˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .video-wrap.no-camera {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background-color: rgba(0,0,0,0.4);
      /* æ ã®ã‚µã‚¤ã‚ºã¯ç¶­æŒ */
      width: 100%;
      min-width: 280px;
      aspect-ratio: 16/9; /* 16:9ã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒ */
    }
    .video-wrap.no-camera .camera-placeholder {
      font-size: 2.8rem;
      margin-bottom: 0.5rem;
      font-weight: bold;
      text-align: center;
      padding: 0 1rem;
      color: var(--accent);
      text-shadow: 0 2px 8px rgba(85, 221, 224, 0.5);
    }
    
    /* PCã§æ ã®å¤§ãã•ã‚’ç¶­æŒ */
    @media (min-width: 768px) {
      .video-wrap.no-camera {
        width: 48%;
        max-width: none;
        aspect-ratio: 16/9;
      }
      
      .video-wrap.no-camera .camera-placeholder {
        font-size: 3.5rem;
      }
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®èª¿æ•´ */
    @media (max-width: 767px) {
      #battle-wrap {
        padding: 0.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
      }
      
      /* ãƒ“ãƒ‡ã‚ªã¨ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚³ãƒ³ãƒ†ãƒŠã§å›²ã‚€ */
      #videos {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        width: 100%;
        max-width: 500px;
      }
      
      .video-wrap {
        width: 100%;
        min-width: auto;
        max-height: 40vh; /* é«˜ã•ã‚’å¢—ã‚„ã—ã¦è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’å¤§ãã */
      }
      
      /* PCç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’éè¡¨ç¤º */
      .pc-timer {
        display: none !important;
      }
      
      /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’è¡¨ç¤º */
      .mobile-timer {
        display: flex !important;
        background: rgba(0,0,0,0.4);
        padding: 0.8rem;
        border-radius: var(--radius);
        border: 1px solid rgba(255,255,255,0.05);
        backdrop-filter: blur(8px);
        margin: 0.5rem 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        position: relative;
        max-width: 320px; /* ã‚¿ã‚¤ãƒãƒ¼ã‚’å¤§ãã */
        width: 100%;
        align-self: center;
        flex-direction: row;
        align-items: center;
        justify-content: center;
      }
      
      /* ã‚¿ã‚¤ãƒãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
      .timer-content {
        flex: 0 0 auto;
        text-align: center;
      }
      
      #mobile-phase {
        font-family: 'Russo One', sans-serif;
        font-size: 1.2rem; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºå¤§ãã */
        margin-bottom: 0.2rem;
        color: var(--accent);
      }
      
      #mobile-timer-box {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      #mobile-timer {
        font-family: 'Russo One', sans-serif;
        font-size: 4rem; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºå¤§ãã */
        color: var(--accent);
        display: inline-block;
        text-shadow: 0 2px 8px rgba(85, 221, 224, 0.4);
      }
      
      .mobile-unit {
        font-family: 'Russo One', sans-serif;
        font-size: 1.5rem; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºå¤§ãã */
        color: var(--accent);
        margin-left: 0.1rem;
      }
      
      /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ */
      .desktop-reaction {
        display: none !important; /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ã¯éè¡¨ç¤º */
      }
      
      /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ */
      .mobile-reaction {
        display: flex !important;
        position: relative;
        margin: 10px auto 15px;
        max-width: 320px; /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚’å¤§ãã */
        width: 100%;
        flex-direction: row;
        justify-content: center;
        gap: 12px; /* ãƒœã‚¿ãƒ³é–“ã®ä½™ç™½ã‚’å¢—ã‚„ã™ */
        background: rgba(0, 0, 0, 0.4);
        padding: 10px 20px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¢—ã‚„ã™ */
        border-radius: 24px;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255,255,255,0.05);
        z-index: 50;
        left: 50%;
        transform: translateX(-50%);
      }
      
      .mobile-reaction button {
        width: 48px; /* ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºã‚’å¤§ãã */
        height: 48px; /* ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºã‚’å¤§ãã */
        border: none;
        border-radius: 50%;
        background: rgba(0,0,0,0.2);
        color: white;
        font-size: 1.4rem; /* æ–‡å­—ã‚µã‚¤ã‚ºã‚’å¤§ãã */
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 -2px 5px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.4);
        cursor: pointer;
        transition: transform 0.2s, background-color 0.2s;
      }
      
      .mobile-reaction button:active {
        transform: scale(0.95);
        background: var(--accent);
      }
      
      /* ä¸­æ–­ãƒœã‚¿ãƒ³ */
      #abortBtn {
        top: 4px;
        left: 10px;
        right: auto;
        width: 36px;
        height: 36px;
        font-size: 1.1rem;
      }
      
      /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒãƒˆãƒ«çµ‚äº†ãƒœã‚¿ãƒ³è¡¨ç¤º */
      .mobile-battle-nav {
        display: block;
        position: absolute;
      }
      
      /* ãƒãƒˆãƒ«çµ‚äº†æ™‚ã®ãƒ¢ãƒã‚¤ãƒ«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º */
      #mobileBackToLobby {
        left: -110px;
      }
      
      #mobileNextBattle {
        right: -110px;
      }
      
      /* PCç”¨ã®ãƒãƒˆãƒ«çµ‚äº†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º */
      #battleEndButtons {
        display: none !important;
      }
    }
    
    /* è¶…å°å‹ãƒ‡ãƒã‚¤ã‚¹ï¼ˆiPhone SEç­‰ï¼‰ç”¨ */
    @media (max-width: 380px) {
      .video-wrap {
        max-height: 35vh; /* é«˜ã•ã‚’å¤§ããã™ã‚‹ */
      }
      
      .mobile-timer {
        max-width: 280px;
        padding: 0.7rem;
      }
      
      #mobile-timer {
        font-size: 3.2rem; /* ã‚¿ã‚¤ãƒãƒ¼ã‚’å¤§ãã */
      }
      
      #mobile-phase {
        font-size: 1.1rem; /* ãƒ•ã‚§ãƒ¼ã‚ºãƒ†ã‚­ã‚¹ãƒˆã‚’å¤§ãã */
      }
      
      .mobile-reaction button {
        width: 42px; /* å°å‹ç”»é¢ã§ã‚‚ãƒœã‚¿ãƒ³ã‚’å¤§ãã‚ã« */
        height: 42px;
        font-size: 1.3rem;
      }
      
      /* ã‚¿ã‚¤ãƒãƒ¼æ¨ªã®ãƒœã‚¿ãƒ³ã‚‚å°ã•ã */
      .mobile-battle-nav button {
        padding: 0.5rem;
        font-size: 0.8rem;
      }
      
      #mobileBackToLobby {
        left: -90px;
      }
      
      #mobileNextBattle {
        right: -90px;
      }
    }
    
    /* PCç‰¹æœ‰ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ - æ¨ªä¸¦ã³ã¨ã‚¿ã‚¤ãƒãƒ¼ä½ç½®å¤‰æ›´ */
    @media (min-width: 768px) {
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        overflow-x: hidden;
      }
      
      #battle-wrap {
        width: 100%;
        max-width: 1280px;
        padding: 1rem;
        margin-top: 5rem; /* ã‚¿ã‚¤ãƒˆãƒ«åˆ†ã®ä½™ç™½ */
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      
      /* PCç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’è¡¨ç¤º */
      .pc-timer {
        display: block !important;
        margin: 0 0 1.5rem 0;
        width: 100%;
        text-align: center;
      }
      
      /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’éè¡¨ç¤º */
      .mobile-timer {
        display: none !important;
      }
      
      /* PCç‰ˆã§ã¯æ˜ åƒã‚’æ¨ªä¸¦ã³ã®é…ç½®ã«å¤‰æ›´ */
      #videos {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        gap: 0; /* ãã£ã¤ã„ãŸçŠ¶æ…‹ */
        width: 100%;
      }
      
      .video-wrap {
        width: 48%;
        max-width: none;
        aspect-ratio: 16/9;
        margin: 0;
      }
      
      .video-wrap:first-child {
        border-radius: var(--radius) 0 0 var(--radius); /* å·¦å´ã®è§’ã ã‘ä¸¸ã */
      }
      
      .video-wrap:last-child {
        border-radius: 0 var(--radius) var(--radius) 0; /* å³å´ã®è§’ã ã‘ä¸¸ã */
      }
      
      /* PCç‰ˆã§ã¯ç›¸æ‰‹ã®ãƒŸãƒ¥ãƒ¼ãƒˆUIã‚’å³ä¸‹ã«é…ç½® */
      .video-wrap:last-child .audio-status {
        left: auto;
        right: 14px;
      }
      
      /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ã®è¡¨ç¤º */
      .desktop-reaction {
        display: flex !important; /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ã¯è¡¨ç¤º */
      }
      
      .mobile-reaction {
        display: none !important; /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã¯éè¡¨ç¤º */
      }
      
      /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ã‚¿ã‚¤ãƒãƒ¼æ¨ªãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º */
      .mobile-battle-nav {
        display: none !important;
      }
      
      /* ãƒãƒˆãƒ«çµ‚äº†æ™‚ã®ãƒœã‚¿ãƒ³ */
      #battleEndButtons {
        bottom: 40px;
      }
    }
    
    #timer-box {
      height: 7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* æ¥ç¶šçŠ¶æ…‹è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .connection-status {
      position: fixed;
      top: 16px;
      left: 16px;
      font-size: 0.75rem;
      padding: 4px 8px;
      background: rgba(0,0,0,0.7);
      color: white;
      border-radius: 12px;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #777;
    }
    .status-connecting { background-color: #ffcc00; }
    .status-connected { background-color: #22cc44; }
    .status-error { background-color: #ff3333; }

    /* ãƒŸãƒ¥ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ */
    .mute-icon {
      position: absolute;
      left: 10px;
      bottom: 10px;
      font-size: 1.1rem;
      color: #fff;
      text-shadow: 0 1px 4px rgba(0,0,0,0.5);
      user-select: none;
      z-index: 3;
      pointer-events: none;
    }
    @media (max-width: 767px) {
      .mute-icon { font-size: 1rem; left: 6px; bottom: 6px; }
    }
    
    /* ===== â˜…NEW: ãƒã‚¤ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå·¦ä¸‹ï¼‰ ===== */
    .audio-status{
      position:absolute;bottom:14px;left:14px;
      width:42px;height:42px;border-radius:50%;
      backdrop-filter:blur(6px);
      display:flex;align-items:center;justify-content:center;
      transition:.3s ease;
      box-shadow:0 0 6px transparent;
      z-index: 5;
    }
    .audio-status svg{width:22px;height:22px;fill:var(--accent);transition:.3s;}
    .audio-status.unmuted{
      background:rgba(85,221,224,0.2);
      animation:pulseMic 1.4s infinite;
    }
    .audio-status.muted{
      background:rgba(255,47,79,0.2);box-shadow:0 0 10px rgba(255,47,79,0.6);
    }
    .audio-status.muted svg{fill:#ff2f4f;}
    @keyframes pulseMic{
      0%{box-shadow:0 0 4px rgba(85,221,224,0.2);}
      50%{box-shadow:0 0 10px rgba(85,221,224,0.8);}
      100%{box-shadow:0 0 4px rgba(85,221,224,0.2);}
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã§ã®èª¿æ•´ */
    @media (max-width: 767px) {
      .audio-status {
        width: 36px;
        height: 36px;
        bottom: 10px;
        left: 10px;
      }
      .audio-status svg {
        width: 18px;
        height: 18px;
      }
    }
    
    /* éŸ³ã«åå¿œã™ã‚‹èƒŒæ™¯ãƒ©ã‚¤ãƒˆ */
    .audio-reactive-bg {
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(circle at center, rgba(85,221,224,0) 30%, rgba(85,221,224,0) 70%);
      z-index: 0;
      opacity: 0;
      transition: opacity 0.1s, background 0.1s;
      pointer-events: none;
    }
    
    /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®ãƒã‚ªãƒ³åŠ¹æœãŒå¢—å¹… */
    .video-wrap.active-turn .audio-reactive-bg.active {
      box-shadow: 0 0 30px 5px rgba(85,221,224,0.7);
    }
    
    /* ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆãƒœãƒªãƒ¥ãƒ¼ãƒ è¡¨ç¤ºç”¨ï¼‰ */
    .volume-indicator {
      position: absolute;
      right: 10px;
      bottom: 10px;
      font-size: 1.2rem;
      color: #55dde0;
      text-shadow: 0 0 10px rgba(85,221,224,0.8);
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 3;
    }
    .volume-indicator.active {
      opacity: 1;
    }
    
    /* å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ  */
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* åœ°çƒå„€ãƒ­ãƒ¼ãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ */
    .earth-loader {
      position: relative;
      width: 80px;
      height: 80px;
      margin: 0 auto 1.5rem;
    }
    .earth-loader svg {
      position: absolute;
    }
    .earth-loader svg:first-child {
      animation: rotate 8s linear infinite;
    }
    .earth-loader svg:nth-child(2) {
      animation: rotate 12s linear reverse infinite;
    }
    .earth-loader svg:nth-child(3) {
      animation: rotate 15s linear infinite;
    }
    .earth-loader svg:nth-child(4) {
      animation: rotate 10s linear reverse infinite;
    }
    
    /* ãƒãƒƒãƒãƒ³ã‚°ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
    #cancelConfirmDialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      border: 1px solid rgba(85,221,224,0.5);
      border-radius: 12px;
      padding: 1.5rem;
      z-index: 10000;
      box-shadow: 0 0 20px rgba(0,0,0,0.8), 0 0 30px rgba(85,221,224,0.2);
      text-align: center;
      max-width: 90%;
      width: 320px;
      display: none;
    }
    
    #cancelConfirmDialog h3 {
      color: #55dde0;
      margin-top: 0;
      font-size: 1.4rem;
    }
    
    #cancelConfirmDialog p {
      color: white;
      margin-bottom: 1.5rem;
    }
    
    .dialog-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }
    
    .dialog-buttons button {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      min-width: 100px;
    }
    
    .confirm-btn {
      background: #ff3a3a;
      color: white;
    }
    
    .cancel-btn {
      background: #555;
      color: white;
    }

    /* æ–°ã—ã„3Dãƒ‰ãƒƒãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .dot-loader {
      width: 200px;
      height: 200px;
      perspective: 200px;
      position: relative;
      margin: 0 auto 1.5rem;
    }

    .dot {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 120px;
      height: 120px;
      margin-top: -60px;
      margin-left: -60px;
      border-radius: 100px;
      border: 40px outset #1e3f57;
      transform-origin: 50% 50%;
      transform: rotateX(24deg) rotateY(20deg) rotateZ(0deg) translateZ(-25px);
      background-color: transparent;
      animation: dot1 1000ms cubic-bezier(.49,.06,.43,.85) infinite;
    }

    .dot:nth-child(2) {
      width: 140px;
      height: 140px;
      margin-top: -70px;
      margin-left: -70px;
      border-width: 30px;
      border-color: #447891;
      animation-name: dot2;
      animation-delay: 75ms;
      box-shadow: inset 0 0 15px 0 rgba(0, 0, 0, 0.1);
      transform: rotateX(24deg) rotateY(20deg) rotateZ(0deg) translateZ(-25px);
    }

    .dot:nth-child(3) {
      width: 160px;
      height: 160px;
      margin-top: -80px;
      margin-left: -80px;
      border-width: 20px;
      border-color: #6bb2cd;
      animation-name: dot3;
      animation-delay: 150ms;
      box-shadow: inset 0 0 15px 0 rgba(0, 0, 0, 0.1);
      transform: rotateX(24deg) rotateY(20deg) rotateZ(0deg) translateZ(-25px);
    }

    @keyframes dot1 {
      0% {
        border-color: #1e3f57;
        transform: rotateX(24deg) rotateY(20deg) rotateZ(0deg) translateZ(-25px);
      }

      50% {
        border-color: #1e574f;
        transform: rotateX(20deg) rotateY(20deg) rotateZ(50deg) translateZ(0px);
      }

      100% {
        border-color: #1e3f57;
        transform: rotateX(24deg) rotateY(20deg) rotateZ(0deg) translateZ(-25px);
      }
    }

    @keyframes dot2 {
      0% {
        border-color: #447891;
        box-shadow: inset 0 0 15px 0 rgba(255, 255, 255, 0.2);
        transform: rotateX(24deg) rotateY(20deg) rotateZ(0deg) translateZ(-25px);
      }

      50% {
        border-color: #449180;
        box-shadow: inset 0 0 15px 0 rgba(0, 0, 0, 0.8);
        transform: rotateX(20deg) rotateY(20deg) rotateZ(50deg) translateZ(0px);
      }

      100% {
        border-color: #447891;
        box-shadow: inset 0 0 15px 0 rgba(255, 255, 255, 0.2);
        transform: rotateX(24deg) rotateY(20deg) rotateZ(0deg) translateZ(-25px);
      }
    }

    @keyframes dot3 {
      0% {
        border-color: #6bb2cd;
        box-shadow: inset 0 0 15px 0 rgba(0, 0, 0, 0.1);
        transform: rotateX(24deg) rotateY(20deg) rotateZ(0deg) translateZ(-25px);
      }

      50% {
        border-color: #6bcdb2;
        box-shadow: inset 0 0 15px 0 rgba(0, 0, 0, 0.8);
        transform: rotateX(20deg) rotateY(20deg) rotateZ(50deg) translateZ(0px);
      }

      100% {
        border-color: #6bb2cd;
        box-shadow: inset 0 0 15px 0 rgba(0, 0, 0, 0.1);
        transform: rotateX(24deg) rotateY(20deg) rotateZ(0deg) translateZ(-25px);
      }
    }
  </style>
</head>
<body>
  <div id="overlay" hidden></div>
  <button id="abortBtn" title="é€€å‡º" onclick="window.location.href='/lobby.html';">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="3" y="3" width="13" height="18" rx="2" ry="2" stroke="#fff" stroke-width="2" fill="none"/>
      <path d="M16 17l5-5-5-5" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M21 12H9" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
  
  <!-- ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ã‚’è¿½åŠ  -->
  <h1 id="page-title">BeatNexus</h1>
  
  <div id="battle-wrap">
    <!-- PCç‰ˆã§ã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’ä¸Šã«é…ç½®ã€ãƒ¢ãƒã‚¤ãƒ«ã§ã¯é †ç•ªã‚’å¤‰ãˆã‚‹ -->
    <div class="timer-container pc-timer">
      <h2 id="phase">Waitingâ€¦</h2>
      <div id="timer-box">
        <span id="timer">60</span><span class="unit">s</span>
      </div>
    </div>
    
    <div id="videos">
      <div class="video-wrap">
        <video id="localVideo" autoplay muted playsinline></video>
        <div id="localName" class="nameTag"></div>
        <!-- ãƒŸãƒ¥ãƒ¼ãƒˆè¡¨ç¤ºï¼ˆæ–°ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ -->
        <div class="audio-status muted" id="localMuteIcon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M12,2A3,3,0,0,0,9,5V12a3,3,0,0,0,6,0V5A3,3,0,0,0,12,2Z"/>
            <path d="M19,11a1,1,0,0,0-2,0,5,5,0,0,1-10,0,1,1,0,0,0-2,0,7,7,0,0,0,6,6.92V20H8a1,1,0,0,0,0,2h8a1,1,0,0,0,0-2H13V17.92A7,7,0,0,0,19,11Z"/>
          </svg>
      </div>
        </div>
        
      <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚¿ã‚¤ãƒãƒ¼ï¼ˆã‚«ãƒ¡ãƒ©é–“ã«é…ç½®ï¼‰ -->
      <div class="timer-container mobile-timer">
        <div class="timer-content">
          <h2 id="mobile-phase">Waitingâ€¦</h2>
          <div id="mobile-timer-box">
            <span id="mobile-timer">60</span><span class="mobile-unit">s</span>
        </div>
        </div>
      </div>
      
      <div class="video-wrap">
        <video id="remoteVideo" autoplay playsinline></video>
        <div id="remoteName" class="nameTag"></div>
        <!-- ç›¸æ‰‹ã®ãƒŸãƒ¥ãƒ¼ãƒˆè¡¨ç¤ºï¼ˆæ–°ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ -->
        <div class="audio-status muted" id="remoteMuteIcon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M12,2A3,3,0,0,0,9,5V12a3,3,0,0,0,6,0V5A3,3,0,0,0,12,2Z"/>
            <path d="M19,11a1,1,0,0,0-2,0,5,5,0,0,1-10,0,1,1,0,0,0-2,0,7,7,0,0,0,6,6.92V20H8a1,1,0,0,0,0,2h8a1,1,0,0,0,0-2H13V17.92A7,7,0,0,0,19,11Z"/>
          </svg>
      </div>
        <!-- éŸ³ã«åå¿œã™ã‚‹ãƒãƒƒã‚¯ãƒ©ã‚¤ãƒˆ -->
        <div class="audio-reactive-bg" id="remoteAudioBg"></div>
        <!-- éŸ³é‡ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ï¼‰ -->
        <span class="volume-indicator" id="volumeIndicator">ğŸ”Š</span>
    </div>
  </div>

    <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆæ˜ åƒã®ä¸‹ã«é…ç½®ï¼‰ -->
    <div class="reaction-bar mobile-reaction">
    <button data-emoji="ğŸ”¥">ğŸ”¥</button>
    <button data-emoji="ğŸ‘">ğŸ‘</button>
    <button data-emoji="ğŸ‘">ğŸ‘</button>
    <button data-emoji="â¤ï¸">â¤ï¸</button>
  </div>
  </div>

  <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
  <div class="reaction-bar desktop-reaction">
    <button data-emoji="ğŸ”¥">ğŸ”¥</button>
    <button data-emoji="ğŸ‘">ğŸ‘</button>
    <button data-emoji="ğŸ‘">ğŸ‘</button>
    <button data-emoji="â¤ï¸">â¤ï¸</button>
  </div>
  <div class="reaction-overlay" id="reactionOverlay"></div>
  
  <!-- å†ãƒãƒƒãƒãƒ³ã‚°ç”¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
  <div id="rematchPopup">
    <div class="lobby-container">
      <button id="closeRematchBtn">Ã—</button>
      <h2>ğŸ¤ æ¬¡ã®å¯¾æˆ¦</h2>
      <div id="matchControls">
        <button id="startRematchBtn">ğŸš€ ãƒãƒƒãƒãƒ³ã‚°é–‹å§‹</button>
        <button id="cancelRematchBtn" style="display:none">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <div class="earth-loader" id="rematchLoader" style="display:none">
          <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="var(--landcolor)"/></svg>
          <svg viewBox="0 0 100 100"><circle cx="30" cy="30" r="15" fill="var(--watercolor)"/></svg>
          <svg viewBox="0 0 100 100"><circle cx="70" cy="70" r="20" fill="var(--landcolor)"/></svg>
          <svg viewBox="0 0 100 100"><circle cx="50" cy="20" r="10" fill="var(--watercolor)"/></svg>
        </div>
        <p id="matchStatus" class="status">ãƒãƒƒãƒãƒ³ã‚°é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã‚’æ¢ã™</p>
      </div>
    </div>
  </div>

  <!-- ãƒãƒƒãƒãƒ³ã‚°ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <div id="cancelConfirmDialog">
    <h3>ãƒãƒƒãƒãƒ³ã‚°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«</h3>
    <p>ãƒãƒƒãƒãƒ³ã‚°å‡¦ç†ã‚’ä¸­æ­¢ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
    <div class="dialog-buttons">
      <button class="cancel-btn" id="cancelDialogNo">ã„ã„ãˆ</button>
      <button class="confirm-btn" id="cancelDialogYes">ã¯ã„</button>
    </div>
  </div>

  <!-- Next Battleãƒœã‚¿ãƒ³ï¼ˆãƒãƒˆãƒ«çµ‚äº†æ™‚ã®ã¿å³ä¸Šã«è¡¨ç¤ºï¼‰ -->
  <button id="nextBattleBtn" style="display:none; position:absolute; top:10px; right:16px; z-index:61;">æ¬¡ã®å¯¾æˆ¦ã¸</button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // å¤šè¨€èªå¯¾å¿œ
    const i18n = {
      en: {
        waiting: "Waitingâ€¦",
        abortBtn: "Exit",
        ready: "Are you ready..?",
        battleFinished: "ğŸ‰ Battle Finished!",
        chatEnabled: "Mic is now enabled. Enjoy the conversation!",
        opponentAborted: "Opponent aborted. Returning to lobby.",
        switch: "Switch!!",
        you: "You",
        opponent: "Opponent",
        turnText: "{name}'s turn (Round {round}/2)",
        backToLobby: "Back to Lobby",
        nextBattle: "Next Battle",
        cancelMatch: "Cancel",
        cancelMatchTitle: "Cancel Matching",
        cancelMatchConfirm: "Are you sure you want to cancel the matching process?",
        yes: "Yes",
        no: "No",
        matchingTitle: "Matching...",
        matchingSubtext: "Looking for your next opponent"
      },
      ja: {
        waiting: "å¾…æ©Ÿä¸­â€¦",
        abortBtn: "é€€å‡º",
        ready: "æº–å‚™ã¯ã„ã„ï¼Ÿ",
        battleFinished: "ğŸ‰ ãƒãƒˆãƒ«çµ‚äº†ï¼",
        chatEnabled: "ãƒã‚¤ã‚¯ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚ä¼šè©±ã‚’æ¥½ã—ã‚“ã§ãã ã•ã„ï¼",
        opponentAborted: "ç›¸æ‰‹ãŒä¸­æ–­ã—ã¾ã—ãŸã€‚ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã™ã€‚",
        switch: "äº¤ä»£ï¼ï¼",
        you: "ã‚ãªãŸ",
        opponent: "ç›¸æ‰‹",
        turnText: "{name}ã®ã‚¿ãƒ¼ãƒ³ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰{round}/2ï¼‰",
        backToLobby: "ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹",
        nextBattle: "æ¬¡ã®å¯¾æˆ¦ã¸",
        cancelMatch: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
        cancelMatchTitle: "ãƒãƒƒãƒãƒ³ã‚°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
        cancelMatchConfirm: "ãƒãƒƒãƒãƒ³ã‚°å‡¦ç†ã‚’ä¸­æ­¢ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
        yes: "ã¯ã„",
        no: "ã„ã„ãˆ",
        matchingTitle: "ãƒãƒƒãƒãƒ³ã‚°ä¸­â€¦",
        matchingSubtext: "æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã‚’æ¢ã—ã¦ã„ã¾ã™"
      },
      es: {
        waiting: "Esperandoâ€¦",
        abortBtn: "Salir",
        ready: "Â¿EstÃ¡s listo..?",
        battleFinished: "ğŸ‰ Â¡Batalla Terminada!",
        chatEnabled: "Â¡MicrÃ³fono activado! Disfruta la conversaciÃ³n.",
        opponentAborted: "El oponente cancelÃ³. Volviendo al lobby.",
        switch: "Â¡Â¡Cambio!!",
        you: "TÃº",
        opponent: "Oponente",
        turnText: "Turno de {name} (Ronda {round}/2)",
        backToLobby: "Volver al Lobby",
        nextBattle: "Siguiente Batalla",
        cancelMatch: "Cancelar",
        cancelMatchTitle: "Cancelar BÃºsqueda",
        cancelMatchConfirm: "Â¿EstÃ¡s seguro de que quieres cancelar la bÃºsqueda de oponente?",
        yes: "SÃ­",
        no: "No",
        matchingTitle: "Buscando...",
        matchingSubtext: "Buscando tu prÃ³ximo oponente"
      },
      fr: {
        waiting: "En attenteâ€¦",
        abortBtn: "Quitter",
        ready: "Es-tu prÃªt..?",
        battleFinished: "ğŸ‰ Combat TerminÃ© !",
        chatEnabled: "Micro activÃ©. Profitez de la conversation !",
        opponentAborted: "L'adversaire a abandonnÃ©. Retour au lobby.",
        switch: "Changement !!",
        you: "Vous",
        opponent: "Adversaire",
        turnText: "Tour de {name} (Manche {round}/2)",
        backToLobby: "Retour au Lobby",
        nextBattle: "Combat Suivant",
        cancelMatch: "Annuler",
        cancelMatchTitle: "Annuler la Recherche",
        cancelMatchConfirm: "ÃŠtes-vous sÃ»r de vouloir annuler la recherche d'adversaire ?",
        yes: "Oui",
        no: "Non",
        matchingTitle: "Recherche en cours...",
        matchingSubtext: "Recherche de votre prochain adversaire"
      },
      zh: {
        waiting: "ç­‰å¾…ä¸­â€¦",
        abortBtn: "é€€å‡º",
        ready: "å‡†å¤‡å¥½äº†å—..?",
        battleFinished: "ğŸ‰ å¯¹æˆ˜ç»“æŸï¼",
        chatEnabled: "éº¦å…‹é£å·²å¯ç”¨ã€‚å¼€å§‹ç•…è°ˆå§ï¼",
        opponentAborted: "å¯¹æ‰‹å·²ä¸­æ­¢ã€‚è¿”å›å¤§å…ã€‚",
        switch: "äº¤æ¢!!",
        you: "ä½ ",
        opponent: "å¯¹æ‰‹",
        turnText: "{name}çš„å›åˆï¼ˆç¬¬{round}/2è½®ï¼‰",
        backToLobby: "è¿”å›å¤§å…",
        nextBattle: "ä¸‹ä¸€åœºå¯¹æˆ˜",
        cancelMatch: "å–æ¶ˆ",
        cancelMatchTitle: "å–æ¶ˆåŒ¹é…",
        cancelMatchConfirm: "ç¡®å®šè¦å–æ¶ˆåŒ¹é…è¿‡ç¨‹å—ï¼Ÿ",
        yes: "æ˜¯",
        no: "å¦",
        matchingTitle: "åŒ¹é…ä¸­...",
        matchingSubtext: "æ­£åœ¨å¯»æ‰¾æ‚¨çš„ä¸‹ä¸€ä½å¯¹æ‰‹"
      },
      ko: {
        waiting: "ëŒ€ê¸° ì¤‘â€¦",
        abortBtn: "ë‚˜ê°€ê¸°",
        ready: "ì¤€ë¹„ëë‚˜ìš”..?",
        battleFinished: "ğŸ‰ ë°°í‹€ ì¢…ë£Œ!",
        chatEnabled: "ë§ˆì´í¬ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ëŒ€í™”ë¥¼ ì¦ê¸°ì„¸ìš”!",
        opponentAborted: "ìƒëŒ€ë°©ì´ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤. ë¡œë¹„ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.",
        switch: "êµì²´!!",
        you: "ë‚˜",
        opponent: "ìƒëŒ€ë°©",
        turnText: "{name}ì˜ í„´ (ë¼ìš´ë“œ {round}/2)",
        backToLobby: "ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°",
        nextBattle: "ë‹¤ìŒ ë°°í‹€",
        cancelMatch: "ì·¨ì†Œ",
        cancelMatchTitle: "ë§¤ì¹­ ì·¨ì†Œ",
        cancelMatchConfirm: "ë§¤ì¹­ í”„ë¡œì„¸ìŠ¤ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
        yes: "ì˜ˆ",
        no: "ì•„ë‹ˆì˜¤",
        matchingTitle: "ë§¤ì¹­ ì¤‘...",
        matchingSubtext: "ë‹¤ìŒ ìƒëŒ€ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤"
      }
    };
    
    // è¨€èªè¨­å®š
    let lang = localStorage.getItem('locale') || 'en';
    
    function updateTexts() {
      const texts = i18n[lang] || i18n.en;
      document.getElementById('phase').textContent = texts.waiting;
      // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ãƒ•ã‚§ãƒ¼ã‚ºãƒ†ã‚­ã‚¹ãƒˆã‚‚æ›´æ–°
      if (document.getElementById('mobile-phase')) {
        document.getElementById('mobile-phase').textContent = texts.waiting;
      }
      document.documentElement.lang = lang;
    }
    
    updateTexts();

    const TURN_TIME = 60;
    const overlay = document.getElementById('overlay');
    const phaseEl = document.getElementById('phase');
    const timerEl = document.getElementById('timer');
    const localVid = document.getElementById('localVideo');
    const remoteVid = document.getElementById('remoteVideo');
    const localName = document.getElementById('localName');
    const remoteName = document.getElementById('remoteName');
    const abortBtn = document.getElementById('abortBtn');
    const reactionOverlay = document.getElementById('reactionOverlay');
    
    // ãƒ¢ãƒã‚¤ãƒ«ç”¨è¦ç´ ã®å‚ç…§ã‚‚å–å¾—
    const mobilePhaseEl = document.getElementById('mobile-phase');
    const mobileTimerEl = document.getElementById('mobile-timer');

    let localStream, pc, countdownId;
    const socket = io();
    const roomId = new URLSearchParams(location.search).get('room');
    let order, names, countries;

    // ãƒã‚¤ã‚¯åˆ¶å¾¡é–¢æ•°
    function setMicEnabled(enabled) {
      if (!localStream) return;
      localStream.getAudioTracks().forEach(t => t.enabled = enabled);
      // localMuteIconãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚Œã°æ›´æ–°
      if (localMuteIcon) {
        updateLocalMuteIcon(!enabled);
      }
      
      // è‡ªåˆ†ã®ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ç›¸æ‰‹ã«é€ä¿¡
      socket.emit('muteStatus', roomId, !enabled);
    }

    // ãƒ¡ãƒ‡ã‚£ã‚¢ï¼†WebRTCåˆæœŸåŒ–
    (async () => {
      const cam = localStorage.getItem('cameraOn') === 'true';
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: cam });
        if (cam) {
          localVid.srcObject = localStream;
        } else {
          // ã‚«ãƒ¡ãƒ©ãªã—ã®å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼è¡¨ç¤ºã‚’æº–å‚™
          setupNoCamera(document.querySelector('.video-wrap:first-child'));
        }
      } catch (err) {
        // ã‚«ãƒ¡ãƒ©å–å¾—ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼è¡¨ç¤º
        console.error('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:', err);
        setupNoCamera(document.querySelector('.video-wrap:first-child'));
      }
      // åˆæœŸã¯ãƒŸãƒ¥ãƒ¼ãƒˆ
      setMicEnabled(false);

      // ã‚ˆã‚Šå¼·å›ºãªICEè¨­å®šï¼ˆSTUNã¨TURNã‚µãƒ¼ãƒãƒ¼ã‚’ä¸¡æ–¹è¨­å®šï¼‰
      const iceServers = [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        // ç„¡æ–™ã®TURNã‚µãƒ¼ãƒãƒ¼ï¼ˆOpenRelayã‚µãƒ¼ãƒ“ã‚¹ï¼‰
        {
          urls: 'turn:openrelay.metered.ca:80',
          username: 'openrelayproject',
          credential: 'openrelayproject'
        },
        {
          urls: 'turn:openrelay.metered.ca:443',
          username: 'openrelayproject',
          credential: 'openrelayproject'
        }
      ];

      // WebRTCæ¥ç¶šè¨­å®š
      pc = new RTCPeerConnection({ 
        iceServers: iceServers, 
        iceCandidatePoolSize: 10, // ICEå€™è£œã®ãƒ—ãƒ¼ãƒ«æ•°ã‚’å¢—ã‚„ã™
        iceTransportPolicy: 'all' // å…¨ã¦ã®ICEæ¥ç¶šæ–¹æ³•ã‚’è¨±å¯
      });
      
      // æ¥ç¶šçŠ¶æ…‹å¤‰æ›´ã®ç›£è¦–
      pc.oniceconnectionstatechange = () => {
        console.log(`ICEæ¥ç¶šçŠ¶æ…‹: ${pc.iceConnectionState}`);
        
        // æ¥ç¶šå¤±æ•—æ™‚ã®å‡¦ç†
        if (pc.iceConnectionState === 'failed' || pc.iceConnectionState === 'disconnected') {
          console.warn('WebRTCæ¥ç¶šãŒå¤±æ•—ã¾ãŸã¯åˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™...');
          
          // 5ç§’å¾Œã«å†æ¥ç¶šã‚’è©¦ã¿ã‚‹
          setTimeout(() => {
            if (pc.iceConnectionState !== 'connected' && pc.iceConnectionState !== 'completed') {
              console.log('å†æ¥ç¶šã‚’é–‹å§‹ã—ã¾ã™...');
              // å†æ¥ç¶šè¦æ±‚ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
              socket.emit('requestReconnect', roomId);
            }
          }, 5000);
        }
        
        // æ¥ç¶šæˆåŠŸæ™‚
        if (pc.iceConnectionState === 'connected' || pc.iceConnectionState === 'completed') {
          console.log('WebRTCæ¥ç¶šãŒæˆåŠŸã—ã¾ã—ãŸ');
        }
      };
      
      // ICEã®åé›†çŠ¶æ…‹ç›£è¦–
      pc.onicegatheringstatechange = () => {
        console.log(`ICEåé›†çŠ¶æ…‹: ${pc.iceGatheringState}`);
      };
      
      // ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°çŠ¶æ…‹ç›£è¦–
      pc.onsignalingstatechange = () => {
        console.log(`ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°çŠ¶æ…‹: ${pc.signalingState}`);
      };
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®è¿½åŠ 
      if (localStream) {
        localStream.getTracks().forEach(track => {
          console.log(`ãƒ­ãƒ¼ã‚«ãƒ«ãƒˆãƒ©ãƒƒã‚¯ã‚’è¿½åŠ : ${track.kind}`);
          pc.addTrack(track, localStream);
        });
      }
      
      // ãƒªãƒ¢ãƒ¼ãƒˆãƒˆãƒ©ãƒƒã‚¯ã‚’å—ã‘å–ã£ãŸæ™‚ã®å‡¦ç†
      pc.ontrack = (event) => {
        console.log(`ãƒªãƒ¢ãƒ¼ãƒˆãƒˆãƒ©ãƒƒã‚¯ã‚’å—ä¿¡: ${event.track.kind}`);
        
        // ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ãƒ“ãƒ‡ã‚ªã«è¨­å®š
        if (event.streams && event.streams[0]) {
          const remoteStream = event.streams[0];
          
          // æ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          if (remoteVid.srcObject !== remoteStream) {
            console.log('ãƒªãƒ¢ãƒ¼ãƒˆãƒ“ãƒ‡ã‚ªã«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è¨­å®šã—ã¦ã„ã¾ã™');
            remoteVid.srcObject = remoteStream;
            
            // ãƒªãƒ¢ãƒ¼ãƒˆæ˜ åƒèª­ã¿è¾¼ã¿ç¢ºèª
            remoteVid.onloadedmetadata = () => {
              console.log('ãƒªãƒ¢ãƒ¼ãƒˆãƒ“ãƒ‡ã‚ªã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
            };
            
            // ãƒªãƒ¢ãƒ¼ãƒˆæ˜ åƒå†ç”Ÿé–‹å§‹ç¢ºèª
            remoteVid.onplaying = () => {
              console.log('ãƒªãƒ¢ãƒ¼ãƒˆãƒ“ãƒ‡ã‚ªã®å†ç”ŸãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ');
              // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹
              const remotePlaceholder = document.querySelector('.video-wrap:last-child .camera-placeholder');
              if (remotePlaceholder) {
                remotePlaceholder.style.display = 'none';
              }
              
              // videoã‚’è¡¨ç¤ºã™ã‚‹
              remoteVid.style.display = 'block';
              
              // no-cameraã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
              const remoteVideoWrap = document.querySelector('.video-wrap:last-child');
              if (remoteVideoWrap) {
                remoteVideoWrap.classList.remove('no-camera');
              }
              
              // ç›¸æ‰‹ã®éŸ³å£°ãŒæ¥ãŸã‚‰ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’é–‹å§‹
              startAudioReactiveLight();
            };
          }
        } else {
          console.error('ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“');
          setupNoCamera(document.querySelector('.video-wrap:last-child'));
        }
      };
      
      // ICEå€™è£œç”Ÿæˆæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          console.log('ICEå€™è£œã‚’é€ä¿¡ã—ã¾ã™');
          socket.emit('ice', roomId, event.candidate);
        } else {
          console.log('ã™ã¹ã¦ã®ICEå€™è£œã®åé›†ãŒå®Œäº†ã—ã¾ã—ãŸ');
        }
      };
      
      // éƒ¨å±‹ã«å‚åŠ 
      socket.emit('joinRoom', roomId);
    })();

    // ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°
    socket.on('ready', async id => {
      if (socket.id === id) {
        console.log('ã‚ªãƒ•ã‚¡ãƒ¼ã‚’ä½œæˆã—ã¾ã™');
        try {
          const offer = await pc.createOffer({
            offerToReceiveAudio: true,
            offerToReceiveVideo: true
          });
          console.log('ãƒ­ãƒ¼ã‚«ãƒ«è¨˜è¿°ã‚’ã‚»ãƒƒãƒˆã—ã¾ã™');
        await pc.setLocalDescription(offer);
          console.log('ã‚ªãƒ•ã‚¡ãƒ¼ã‚’é€ä¿¡ã—ã¾ã™');
        socket.emit('offer', roomId, offer);
        } catch (err) {
          console.error('ã‚ªãƒ•ã‚¡ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', err);
        }
      }
    });
    
    socket.on('offer', async o => {
      console.log('ã‚ªãƒ•ã‚¡ãƒ¼ã‚’å—ä¿¡ã—ã¾ã—ãŸ');
      try {
        console.log('ãƒªãƒ¢ãƒ¼ãƒˆè¨˜è¿°ã‚’ã‚»ãƒƒãƒˆã—ã¾ã™');
      await pc.setRemoteDescription(o);
        console.log('ã‚¢ãƒ³ã‚µãƒ¼ã‚’ä½œæˆã—ã¾ã™');
      const ans = await pc.createAnswer();
        console.log('ãƒ­ãƒ¼ã‚«ãƒ«è¨˜è¿°ã‚’ã‚»ãƒƒãƒˆã—ã¾ã™');
      await pc.setLocalDescription(ans);
        console.log('ã‚¢ãƒ³ã‚µãƒ¼ã‚’é€ä¿¡ã—ã¾ã™');
      socket.emit('answer', roomId, ans);
      } catch (err) {
        console.error('ã‚¢ãƒ³ã‚µãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', err);
      }
    });
    
    socket.on('answer', async a => {
      console.log('ã‚¢ãƒ³ã‚µãƒ¼ã‚’å—ä¿¡ã—ã¾ã—ãŸ');
      try {
        if (pc.signalingState !== 'stable') {
          await pc.setRemoteDescription(a);
          console.log('ãƒªãƒ¢ãƒ¼ãƒˆè¨˜è¿°ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
        }
      } catch (err) {
        console.error('ã‚¢ãƒ³ã‚µãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:', err);
      }
    });
    
    socket.on('ice', async c => {
      if (c) {
        console.log('ICEå€™è£œã‚’å—ä¿¡ã—ã¾ã—ãŸ');
        try {
          await pc.addIceCandidate(c);
          console.log('ICEå€™è£œã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        } catch (err) {
          console.error('ICEå€™è£œè¿½åŠ ã‚¨ãƒ©ãƒ¼:', err);
        }
      }
    });
    
    // å†æ¥ç¶šè¦æ±‚ã‚’å—ä¿¡
    socket.on('requestReconnect', async () => {
      console.log('å†æ¥ç¶šè¦æ±‚ã‚’å—ä¿¡ã—ã¾ã—ãŸ');
      
      // æ—¢å­˜ã®PeerConnectionæ¥ç¶šã‚’é–‰ã˜ã‚‹
      if (pc) {
        pc.close();
      }
      
      // æ–°ã—ã„æ¥ç¶šã‚’é–‹å§‹ã™ã‚‹
      // (WebRTCåˆæœŸåŒ–ã®å‡¦ç†ã‚’å†åº¦å‘¼ã³å‡ºã™ãªã©)
      // ã“ã“ã§ã¯ç°¡ç•¥åŒ–ã®ãŸã‚ã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹
      window.location.reload();
    });

    // ã‚«ãƒ¡ãƒ©ãŒãªã„å ´åˆã®å‡¦ç†
    function setupNoCamera(videoWrap) {
      if (!videoWrap) return;
      
      // videoè¦ç´ ã‚’éè¡¨ç¤ºã«
      const videoEl = videoWrap.querySelector('video');
      if (videoEl) videoEl.style.display = 'none';
      
      // å°ã•ã„åå‰ã‚¿ã‚°ã‚’éè¡¨ç¤ºã«
      const nameTag = videoWrap.querySelector('.nameTag');
      if (nameTag) nameTag.style.display = 'none';
      
      // ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      videoWrap.classList.add('no-camera');
      
      // ã™ã§ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒã‚ã‚Œã°ä½•ã‚‚ã—ãªã„
      if (videoWrap.querySelector('.camera-placeholder')) return;
      
      // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼è¦ç´ ã‚’ä½œæˆ
      const placeholder = document.createElement('div');
      placeholder.className = 'camera-placeholder';
      
      // åå‰ã‚¿ã‚°ã®å†…å®¹ã‚’å–å¾— (å¾Œã§setNameTagsã§è¨­å®šã•ã‚Œã‚‹)
      placeholder.textContent = nameTag ? nameTag.textContent : '';
      
      // å‹•çš„ã«æ›´æ–°ã™ã‚‹ãŸã‚ã€ç›£è¦–ã™ã‚‹
      if (nameTag) {
        const observer = new MutationObserver((mutations) => {
          placeholder.textContent = nameTag.textContent;
        });
        observer.observe(nameTag, { childList: true, subtree: true, characterData: true });
      }
      
      // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¿½åŠ 
      videoWrap.appendChild(placeholder);
    }

    // ãƒãƒˆãƒ«ã‚·ãƒ¼ã‚±ãƒ³ã‚¹åˆ¶å¾¡
    socket.on('startSequence', async data => {
      console.log('ãƒãƒˆãƒ«é–‹å§‹ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å—ä¿¡:', data);
      order = data.order; 
      names = data.names; 
      countries = data.countries || {};
      console.log('åå‰ã¨ã‚ªãƒ¼ãƒ€ãƒ¼:', names, order);
      setNameTags();
      const texts = i18n[lang] || i18n.en;
      console.log('ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹...');
      try {
      await showSequence(texts.ready, 1000, ['3','2','1'], 1000, 'BEATBOX!!!!', 500);
        console.log('ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³å®Œäº†!');
      startTurn(1);
      } catch (err) {
        console.error('ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¨ãƒ©ãƒ¼:', err);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ç¶šè¡Œ
        overlay.style.display = 'none';
        overlay.hidden = true;
        startTurn(1);
      }
    });
    socket.on('switchTurn', data => {
      order = data.order; 
      names = data.names;
      countries = data.countries || {};
      const texts = i18n[lang] || i18n.en;
      showSequence(texts.switch, 1000).then(() => {
        startTurn(data.turn);
        // ã‚¿ãƒ¼ãƒ³åˆ‡ã‚Šæ›¿ãˆæ™‚ã«åå‰ã‚¿ã‚°ã‚‚æ›´æ–°ï¼ˆã‚«ãƒ¡ãƒ©ãªã—ã®è¡¨ç¤ºã‚‚æ›´æ–°ã•ã‚Œã‚‹ï¼‰
        setNameTags();
      });
    });
    socket.on('battleFinished', () => {
      clearInterval(countdownId);
      // ãƒãƒˆãƒ«çµ‚äº†æ™‚ã¯ãƒã‚¤ã‚¯ã‚’ã‚ªãƒ³ã«ã—ã¦ä¼šè©±ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
      setMicEnabled(true);
      const texts = i18n[lang] || i18n.en;
      phaseEl.textContent = texts.battleFinished;
      if (mobilePhaseEl) {
        mobilePhaseEl.textContent = texts.battleFinished;
      }
      
      // ãƒãƒˆãƒ«çµ‚äº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¾Œã«ã€ä¼šè©±å¯èƒ½ãªã“ã¨ã‚’è¡¨ç¤º
      setTimeout(() => {
        const chatText = texts.chatEnabled || "ãƒã‚¤ã‚¯ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚ä¼šè©±ã‚’æ¥½ã—ã‚“ã§ãã ã•ã„ï¼";
        const chatNotice = document.createElement('div');
        chatNotice.textContent = chatText;
        chatNotice.style.color = '#55dde0';
        chatNotice.style.fontSize = '1rem';
        chatNotice.style.marginTop = '0.5rem';
        
        // PCç”¨ã¨ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ä¸¡æ–¹ã«é€šçŸ¥ã‚’è¿½åŠ 
        phaseEl.insertAdjacentElement('afterend', chatNotice.cloneNode(true));
        if (mobilePhaseEl) {
          mobilePhaseEl.insertAdjacentElement('afterend', chatNotice);
        }
      }, 1500);
      
      document.querySelectorAll('.video-wrap').forEach(wrap => {
        wrap.classList.remove('active-turn');
      });
      const nextBtn = document.getElementById('nextBattleBtn');
      nextBtn.textContent = texts.nextBattle;
      nextBtn.style.display = 'block';
      nextBtn.onclick = () => {
        // ãƒ­ãƒ“ãƒ¼ç”»é¢ã¨åŒã˜UIã‚’è¡¨ç¤º
        showMatchingUI();
        // ã‚µãƒ¼ãƒãƒ¼ã«ãƒãƒƒãƒãƒ³ã‚°è¦æ±‚ã‚’é€ä¿¡
        socket.emit('joinBattleQueue');
      };
      window.battleEnded = true;
    });
    
    // ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°ã‚’å—ä¿¡ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°
    socket.on('timerTick', sec => { 
      timerEl.textContent = Math.max(sec, 0); 
      // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚¿ã‚¤ãƒãƒ¼ã‚‚æ›´æ–°
      if (mobileTimerEl) {
        mobileTimerEl.textContent = Math.max(sec, 0);
      }
    });

    // ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¸­æ–­ã—ãŸã¨ã
    socket.on('battleAborted', () => {
      clearInterval(countdownId);
      setMicEnabled(false);
      const texts = i18n[lang] || i18n.en;
      alert(texts.opponentAborted);
      window.location.href = '/lobby.html';
    });

    function setNameTags() {
      const texts = i18n[lang] || i18n.en;
      const myCountry = countries[socket.id] || '';
      const countryFlag = myCountry ? `${getCountryFlag(myCountry)} ` : '';
      localName.innerHTML = `${countryFlag}${names[socket.id] || texts.you}`;
      
      const opp = Object.keys(names).find(id => id !== socket.id);
      const oppCountry = countries[opp] || '';
      const oppFlag = oppCountry ? `${getCountryFlag(oppCountry)} ` : '';
      remoteName.innerHTML = `${oppFlag}${names[opp] || texts.opponent}`;
      
      // ã‚«ãƒ¡ãƒ©ãŒãªã„å ´åˆã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚‚æ›´æ–°
      const localPlaceholder = document.querySelector('.video-wrap:first-child .camera-placeholder');
      const remotePlaceholder = document.querySelector('.video-wrap:last-child .camera-placeholder');
      
      if (localPlaceholder) {
        localPlaceholder.textContent = localName.innerHTML;
      }
      
      if (remotePlaceholder) {
        remotePlaceholder.textContent = remoteName.innerHTML;
      }
    }

    // å›½ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å›½æ——ã®çµµæ–‡å­—ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getCountryFlag(countryCode) {
      // å›½ã‚³ãƒ¼ãƒ‰ã‚’åœ°åŸŸè­˜åˆ¥å­ã«å¤‰æ›ï¼ˆUnicodeå›½æ——çµµæ–‡å­—ç”¨ï¼‰
      const codePoints = countryCode
        .toUpperCase()
        .split('')
        .map(char => 127397 + char.charCodeAt(0));
      return String.fromCodePoint(...codePoints);
    }

    function startTurn(turn) {
      clearInterval(countdownId);
      let sec = TURN_TIME;
      
      // åˆæœŸå€¤ã‚’è¡¨ç¤ºï¼ˆPCç”¨ã¨ãƒ¢ãƒã‚¤ãƒ«ç”¨ä¸¡æ–¹ï¼‰
      timerEl.textContent = sec;
      if (mobileTimerEl) {
        mobileTimerEl.textContent = sec;
      }
      
      // ã‚¿ãƒ¼ãƒ³ã®è¨­å®š
      const actor = order[(turn - 1) % 2];
      const isMine = actor === socket.id;
      
      // ãƒã‚ªãƒ³åŠ¹æœã®é©ç”¨
      updateActiveUserHighlight(isMine);
      
      // ã‚¿ãƒ¼ãƒ³ã”ã¨ã«ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡æ›¿
      setMicEnabled(isMine);
      const texts = i18n[lang] || i18n.en;
      const turnText = texts.turnText
        .replace('{name}', names[actor])
        .replace('{round}', Math.ceil(turn/2));
      
      // PCç”¨ã¨ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ãƒ•ã‚§ãƒ¼ã‚ºãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
      phaseEl.textContent = turnText;
      if (mobilePhaseEl) {
        mobilePhaseEl.textContent = turnText;
      }
      
      // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã®å ´åˆã ã‘ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’ç®¡ç†
      if (isMine) {
        countdownId = setInterval(() => {
          sec--;
          // è‡ªåˆ†ã®ç”»é¢ã«ã¯ç›´æ¥è¡¨ç¤ºï¼ˆPCç”¨ã¨ãƒ¢ãƒã‚¤ãƒ«ç”¨ä¸¡æ–¹ï¼‰
          timerEl.textContent = Math.max(sec, 0);
          if (mobileTimerEl) {
            mobileTimerEl.textContent = Math.max(sec, 0);
          }
          
          // ä»–ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã®ã¿å€¤ã‚’é€ä¿¡
          socket.emit('timerTick', roomId, sec);
          
          if (sec <= 0) {
            clearInterval(countdownId);
            socket.emit('turnEnd', roomId);
          }
        }, 1000);
      }
    }
    
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
    function updateActiveUserHighlight(isMyTurn) {
      // ä¸€åº¦ã™ã¹ã¦ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã‚¯ãƒªã‚¢
      document.querySelectorAll('.video-wrap').forEach(wrap => {
        wrap.classList.remove('active-turn');
      });
      
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è¿½åŠ 
      if (isMyTurn) {
        // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ãªã‚‰è‡ªåˆ†ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        document.querySelector('.video-wrap:first-child').classList.add('active-turn');
      } else {
        // ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ãªã‚‰ç›¸æ‰‹ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        document.querySelector('.video-wrap:last-child').classList.add('active-turn');
      }
    }

    async function showSequence(first, ms1, list = [], ms2 = 0, last = null, ms3 = 0) {
      console.log('ã‚·ãƒ¼ã‚±ãƒ³ã‚¹è¡¨ç¤º:', first);
      overlay.hidden = false;
      overlay.style.display = 'flex';
      overlay.textContent = first;
      await delay(ms1);
      for (const t of list) {
        console.log('ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³:', t);
        overlay.textContent = t;
        await delay(ms2);
      }
      if (last) {
        console.log('æœ€çµ‚è¡¨ç¤º:', last);
        overlay.textContent = last;
        await delay(ms3);
      }
      console.log('ã‚·ãƒ¼ã‚±ãƒ³ã‚¹çµ‚äº†ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤éè¡¨ç¤ºåŒ–');
      overlay.style.display = 'none';
      overlay.hidden = true;
    }
    const delay = ms => new Promise(r => setTimeout(r, ms));

    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºï¼†é€å—ä¿¡
    function showReaction(e) {
      reactionOverlay.textContent = e;
      reactionOverlay.style.opacity = '1';
      setTimeout(() => reactionOverlay.style.opacity = '0', 600);
    }
    
    // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ã®ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    document.querySelectorAll('.desktop-reaction button').forEach(btn => {
      btn.addEventListener('click', () => {
        const em = btn.getAttribute('data-emoji');
        showReaction(em);
        socket.emit('reaction', roomId, em);
      });
    });
    
    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã«ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    document.querySelectorAll('.mobile-reaction button').forEach(btn => {
      btn.addEventListener('click', () => {
        const em = btn.getAttribute('data-emoji');
        showReaction(em);
        socket.emit('reaction', roomId, em);
      });
    });
    
    socket.on('reaction', showReaction);

    // ãƒãƒˆãƒ«çµ‚äº†å¾Œã®ãƒœã‚¿ãƒ³é–¢é€£ã®å‡¦ç†
    const battleEndButtons = document.getElementById('battleEndButtons');
    const backToLobbyBtn = document.getElementById('backToLobbyBtn');
    const rematchPopup = document.getElementById('rematchPopup');
    const closeRematchBtn = document.getElementById('closeRematchBtn');
    const startRematchBtn = document.getElementById('startRematchBtn');
    const cancelRematchBtn = document.getElementById('cancelRematchBtn');
    const rematchLoader = document.getElementById('rematchLoader');
    const matchStatus = document.getElementById('matchStatus');
    
    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
    closeRematchBtn.addEventListener('click', () => {
      rematchPopup.style.display = 'none';
    });
    
    // ãƒãƒƒãƒãƒ³ã‚°é–‹å§‹ãƒœã‚¿ãƒ³
    startRematchBtn.addEventListener('click', () => {
      startRematchBtn.style.display = 'none';
      cancelRematchBtn.style.display = 'block';
      rematchLoader.style.display = 'flex';
      matchStatus.textContent = texts.statusMatch || 'ãƒãƒƒãƒãƒ³ã‚°ä¸­...';
      
      // ã‚µãƒ¼ãƒãƒ¼ã«ãƒãƒƒãƒãƒ³ã‚°è¦æ±‚ã‚’é€ä¿¡
      socket.emit('joinBattleQueue');
    });
    
    // ãƒãƒƒãƒãƒ³ã‚°ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
    cancelRematchBtn.addEventListener('click', () => {
      cancelRematchBtn.style.display = 'none';
      startRematchBtn.style.display = 'block';
      rematchLoader.style.display = 'none';
      matchStatus.textContent = texts.statusReady || 'å†åº¦ãƒãƒƒãƒãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ';
      
      // ãƒãƒƒãƒãƒ³ã‚°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      socket.emit('cancelBattleQueue');
    });
    
    // ãƒãƒƒãƒãƒ³ã‚°æˆåŠŸæ™‚ã®å‡¦ç†ã‚’è¿½åŠ 
    socket.on('matched', ({ roomId }) => {
      rematchLoader.style.display = 'none';
      // æ–°ã—ã„éƒ¨å±‹ã¸ç§»å‹•
      location.href = `/battle.html?room=${encodeURIComponent(roomId)}`;
      // ãƒãƒƒãƒãƒ³ã‚°UIã‚’æ¶ˆã™
      const overlay = document.getElementById('matchingOverlay');
      if (overlay) overlay.remove();
    });

    // ãƒ­ãƒ“ãƒ¼ç”»é¢ã¨åŒã˜UIã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showMatchingUI() {
      // ç”»é¢å…¨ä½“ã‚’ãƒ­ãƒ“ãƒ¼é¢¨ã®åŠé€æ˜ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã§è¦†ã†
      let overlay = document.getElementById('matchingOverlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'matchingOverlay';
        overlay.style.position = 'fixed';
        overlay.style.inset = '0';
        overlay.style.background = 'rgba(0,0,0,0.85)';
        overlay.style.zIndex = '9999';
        overlay.style.display = 'flex';
        overlay.style.flexDirection = 'column';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        
        const texts = i18n[lang] || i18n.en;
        const cancelText = texts.cancelMatch || "ã‚­ãƒ£ãƒ³ã‚»ãƒ«";
        const matchingTitle = texts.matchingTitle || "ãƒãƒƒãƒãƒ³ã‚°ä¸­â€¦";
        const matchingSubtext = texts.matchingSubtext || "æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã‚’æ¢ã—ã¦ã„ã¾ã™";
        
        overlay.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;gap:2rem;">
            <div class="dot-loader">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
            <h2 style="color:#fff;font-size:2rem;font-family:'Russo One',sans-serif;">${matchingTitle}</h2>
            <p style="color:#fff;font-size:1.1rem;">${matchingSubtext}</p>
            <button id="cancelMatchingBtn" style="margin-top:2rem;padding:0.7rem 2rem;background:#ff3a3a;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.3);font-size:1.1rem;">${cancelText}</button>
          </div>
        `;
      }
      document.body.appendChild(overlay);
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      const cancelBtn = document.getElementById('cancelMatchingBtn');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
          showCancelConfirmDialog();
        });
      }
    }
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤º
    function showCancelConfirmDialog() {
      const dialog = document.getElementById('cancelConfirmDialog');
      if (!dialog) return;
      
      // å¤šè¨€èªå¯¾å¿œ
      const texts = i18n[lang] || i18n.en;
      dialog.querySelector('h3').textContent = texts.cancelMatchTitle || "ãƒãƒƒãƒãƒ³ã‚°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«";
      dialog.querySelector('p').textContent = texts.cancelMatchConfirm || "ãƒãƒƒãƒãƒ³ã‚°å‡¦ç†ã‚’ä¸­æ­¢ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";
      dialog.querySelector('#cancelDialogNo').textContent = texts.no || "ã„ã„ãˆ";
      dialog.querySelector('#cancelDialogYes').textContent = texts.yes || "ã¯ã„";
      
      // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      dialog.style.display = 'block';
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      document.getElementById('cancelDialogNo').onclick = () => {
        dialog.style.display = 'none';
      };
      
      document.getElementById('cancelDialogYes').onclick = () => {
        // ãƒãƒƒãƒãƒ³ã‚°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        socket.emit('cancelBattleQueue');
        
        // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤º
        dialog.style.display = 'none';
        const overlay = document.getElementById('matchingOverlay');
        if (overlay) overlay.remove();
      };
    }

    // --- éŸ³é‡ãƒãƒ¼ï¼†ãƒŸãƒ¥ãƒ¼ãƒˆè¡¨ç¤º ---
    let audioContext, analyser, micSource, volumeInterval;
    let localMuteIcon, remoteMuteIcon, remoteAudioBg, volumeIndicator;
    
    // ãƒŸãƒ¥ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
    function updateLocalMuteIcon(isMuted) {
      if (!localMuteIcon) return;
      if (isMuted) {
        localMuteIcon.classList.remove('unmuted');
        localMuteIcon.classList.add('muted');
      } else {
        localMuteIcon.classList.remove('muted');
        localMuteIcon.classList.add('unmuted');
      }
    }
    
    // ç›¸æ‰‹ã®éŸ³å£°å‡ºåŠ›ã®éŸ³é‡æ¸¬å®šï¼†ãƒ©ã‚¤ãƒˆåŠ¹æœ
    function startAudioReactiveLight() {
      if (!remoteVid.srcObject) return;
      
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      
      if (!analyser) {
        // ç›¸æ‰‹ã®éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‹ã‚‰éŸ³é‡ã‚’åˆ†æ
        const remoteStream = remoteVid.srcObject;
        const source = audioContext.createMediaStreamSource(remoteStream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        source.connect(analyser);
      }
      
      const dataArray = new Uint8Array(analyser.fftSize);
      
      function update() {
        analyser.getByteTimeDomainData(dataArray);
        // éŸ³é‡ï¼ˆæŒ¯å¹…ã®æœ€å¤§å€¤ï¼‰ã‚’è¨ˆç®—
        let max = 0;
        for (let i = 0; i < dataArray.length; i++) {
          const v = Math.abs(dataArray[i] - 128);
          if (v > max) max = v;
        }
        // 0ã€œ100%ã§è¡¨ç¤º
        const percent = Math.min(100, Math.round((max / 128) * 100));
        if (remoteAudioBg) {
          // éŸ³é‡ã«å¿œã˜ã¦ãƒãƒƒã‚¯ãƒ©ã‚¤ãƒˆã®å¼·åº¦ã‚’å¤‰ãˆã‚‹
          const intensity = percent / 100;
          // 15%ä»¥ä¸Šã®éŸ³é‡ã§ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º
          if (intensity > 0.15) {
            // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚µã‚¤ã‚ºã¨æ˜ã‚‹ã•ã‚’éŸ³é‡ã«å¿œã˜ã¦å¤‰æ›´
            const size = 70 + (intensity * 30); // 70%ã€œ100%ã®ã‚µã‚¤ã‚º
            const opacity = Math.min(0.7, intensity * 1.2); // æœ€å¤§70%ã®ä¸é€æ˜åº¦
            
            // èƒŒæ™¯ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ä¸é€æ˜åº¦ã‚’æ›´æ–°
            remoteAudioBg.style.background = `radial-gradient(circle at center, rgba(85,221,224,${opacity * 0.5}) ${size/3}%, rgba(85,221,224,${opacity * 0.2}) ${size}%)`;
            remoteAudioBg.style.opacity = '1';
            
            // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
            if (volumeIndicator) {
              volumeIndicator.classList.add('active');
            }
          } else {
            // éŸ³ãŒå°ã•ã„å ´åˆã¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’æ¶ˆã™
            remoteAudioBg.style.opacity = '0';
            
            // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’éè¡¨ç¤º
            if (volumeIndicator) {
              volumeIndicator.classList.remove('active');
            }
          }
        }
        
        if (volumeInterval) requestAnimationFrame(update);
      }
      
      if (!volumeInterval) {
        volumeInterval = true;
        update();
      }
    }
    function stopAudioReactiveLight() {
      volumeInterval = false;
      if (remoteAudioBg) {
        remoteAudioBg.style.opacity = '0';
      }
    }

    // DOMã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå¾Œã«å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded - ãƒªã‚»ãƒƒãƒˆå‡¦ç†é–‹å§‹');
      
      // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ
      const overlay = document.getElementById('overlay');
      if (overlay) {
        console.log('ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ãƒªã‚»ãƒƒãƒˆ');
        overlay.style.display = 'none';
        overlay.hidden = true;
      }
      
      // éŸ³é‡ãƒãƒ¼ï¼†ãƒŸãƒ¥ãƒ¼ãƒˆé–¢é€£ã®è¦ç´ åˆæœŸåŒ–
      localMuteIcon = document.getElementById('localMuteIcon');
      remoteMuteIcon = document.getElementById('remoteMuteIcon');
      remoteAudioBg = document.getElementById('remoteAudioBg');
      volumeIndicator = document.getElementById('volumeIndicator');
      
      // åˆæœŸãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã‚’è¨­å®š
      if (localMuteIcon) {
        updateLocalMuteIcon(true);
      }
      
      // ç›¸æ‰‹ã®éŸ³é‡ãƒãƒ¼åˆæœŸè¨­å®š
      if (remoteAudioBg) {
        remoteAudioBg.style.opacity = '0';
      }
      
      // é€€å‡ºãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤šè¨€èªå¯¾å¿œ
      const abortBtn = document.getElementById('abortBtn');
      if (abortBtn) {
        const texts = i18n[lang] || i18n.en;
        abortBtn.title = texts.abortBtn;
      }
    });

    // socket.ioé€šä¿¡ãƒ‡ãƒãƒƒã‚°
    socket.on('connect', () => {
      console.log('Socket.IOæ¥ç¶šæˆåŠŸ!', socket.id);
    });
    socket.on('connect_error', (error) => {
      console.error('Socket.IOæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
    });
    socket.on('disconnect', (reason) => {
      console.warn('Socket.IOåˆ‡æ–­:', reason);
    });

    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®éƒ¨å±‹å‚åŠ å¿œç­”ç¢ºèª
    socket.on('joinedRoom', (data) => {
      console.log('éƒ¨å±‹ã«å‚åŠ ã—ã¾ã—ãŸ:', data);
    });
    
    // ç›¸æ‰‹ã®ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã‚’å—ä¿¡
    socket.on('muteStatus', (isMuted) => {
      updateRemoteMuteIcon(isMuted);
    });

    // ç›¸æ‰‹ã®ãƒŸãƒ¥ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
    function updateRemoteMuteIcon(isMuted) {
      if (!remoteMuteIcon) return;
      if (isMuted) {
        remoteMuteIcon.classList.remove('unmuted');
        remoteMuteIcon.classList.add('muted');
      } else {
        remoteMuteIcon.classList.remove('muted');
        remoteMuteIcon.classList.add('unmuted');
      }
    }
  </script>
</body>
</html>
