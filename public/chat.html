<!-- public/battle.html â€“ Battle ï¼‹ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆå¯¾å¿œ -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>BeatNexus â€“ Battle</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    body { margin:0; font-family:sans-serif; background: linear-gradient(135deg, #111111, #222222); color: white; }
    #overlay {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      font-family:'Russo One',sans-serif; font-size:5rem; color:#00d26a;
      background:rgba(0,0,0,.8); z-index:100;
    }
    #battle-wrap { text-align:center; padding:2rem; }
    .video-wrap {
      position:relative; width:45%;
    }
    .nameTag {
      position:absolute; bottom:8px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.6); color:#fff; padding:2px 8px; border-radius:4px;
      font-size:1rem; font-family:'Inter',sans-serif;
    }
    #chat-wrap {
      position:fixed; right:1rem; top:1rem; width:300px; bottom:1rem;
      display:flex; flex-direction:column; border:1px solid #ccc; background:#fff;
      z-index:50;
    }
    #chat-messages {
      flex:1; overflow-y:auto; padding:0.5rem; font-size:0.9rem;
    }
    #chat-form {
      display:flex; border-top:1px solid #ccc;
    }
    #chat-form input {
      flex:1; padding:0.5rem; border:none; outline:none;
    }
    #chat-form button {
      padding:0.5rem 1rem; border:none; background:#00d26a; color:#fff; cursor:pointer;
    }
    #langSelect {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 60;
      padding: 0.3rem 0.5rem;
      border-radius: 4px;
      background: rgba(40, 40, 40, 0.85);
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.3);
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    /* ãƒãƒˆãƒ«çµ‚äº†æ™‚ã®ãƒœã‚¿ãƒ³ */
    #battleEndButtons {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
      flex-direction: row;
      gap: 1rem;
      z-index: 150;
    }
    #battleEndButtons button {
      padding: 0.8rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: transform 0.2s, background-color 0.2s;
    }
    #backToLobbyBtn {
      background-color: #555;
      color: white;
    }
    #backToLobbyBtn:hover {
      background-color: #666;
      transform: translateY(-2px);
    }
    #rematchBtn {
      background-color: #00d26a;
      color: black;
    }
    #rematchBtn:hover {
      background-color: #00b25a;
      transform: translateY(-2px);
    }

    /* ãƒªãƒãƒƒãƒç”¨ã®ãƒ­ãƒ“ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    #rematchPopup {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 200;
      background: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
    }
    #rematchPopup .lobby-container {
      position: relative;
      width: 90vw;
      max-width: 450px;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(12px);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      border: 1px solid rgba(255,255,255,0.1);
    }
    #closeRematchBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      color: white;
      border: none;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    #closeRematchBtn:hover {
      background: rgba(255,255,255,0.2);
    }
    .earth-loader {
      --watercolor: #4aa4e0;
      --landcolor: #6dbf4b;
      display: none;
      width: 3rem;
      height: 3rem;
      background-color: var(--watercolor);
      position: relative;
      overflow: hidden;
      border-radius: 50%;
      border: .15em solid white;
      box-shadow: inset 0 .4em rgba(255,255,255,0.25), inset 0 -.4em rgba(0,0,0,0.25);
      align-items: center;
      justify-content: center;
    }
    .earth-loader svg { position: absolute; width: 2.5rem; height: auto; }
    .earth-loader svg:nth-child(1) { bottom: -0.8rem; animation: round1 5s infinite linear .6s; }
    .earth-loader svg:nth-child(2) { top: -1.2rem; animation: round1 5s infinite linear; }
    .earth-loader svg:nth-child(3) { top: -1rem; animation: round2 5s infinite linear; }
    .earth-loader svg:nth-child(4) { bottom: -0.9rem; animation: round2 5s infinite linear .6s; }
    @keyframes round1 { 0%{left:-.8rem;}30%{left:-2rem;opacity:1;}31%{opacity:0;}35%{left:3rem;}45%{opacity:1;}100%{left:-.8rem;} }
    @keyframes round2 { 0%{left:1rem;}75%{left:-3rem;opacity:1;}76%{opacity:0;}80%{opacity:1;}100%{left:1rem;} }
  </style>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div id="overlay" hidden></div>
  <select id="langSelect">
    <option value="en">EN</option>
    <option value="ja">æ—¥æœ¬èª</option>
    <option value="es">ES</option>
    <option value="fr">FR</option>
    <option value="zh">ä¸­æ–‡</option>
    <option value="ko">í•œêµ­ì–´</option>
  </select>

  <div id="battle-wrap">
    <h2 id="phase">Waitingâ€¦</h2>
    <div style="font-size:3rem;margin:1rem;">
      <span id="timer">60</span>s
    </div>
    <div id="videos" style="display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;">
      <div class="video-wrap">
        <video id="localVideo" autoplay muted playsinline style="width:100%;border-radius:12px;"></video>
        <div id="localName" class="nameTag"></div>
      </div>
      <div class="video-wrap">
        <video id="remoteVideo" autoplay playsinline style="width:100%;border-radius:12px;"></video>
        <div id="remoteName" class="nameTag"></div>
      </div>
    </div>
  </div>

  <div id="chat-wrap">
    <div id="chat-messages"></div>
    <form id="chat-form">
      <input id="chat-input" autocomplete="off" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›â€¦" />
      <button type="submit" id="sendButton">é€ä¿¡</button>
    </form>
  </div>
  
  <!-- ãƒãƒˆãƒ«çµ‚äº†æ™‚ã«è¡¨ç¤ºã™ã‚‹ãƒœã‚¿ãƒ³ -->
  <div id="battleEndButtons">
    <button id="backToLobbyBtn">ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
    <button id="rematchBtn">å†åº¦ãƒãƒƒãƒãƒ³ã‚°</button>
  </div>
  
  <!-- å†ãƒãƒƒãƒãƒ³ã‚°ç”¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
  <div id="rematchPopup">
    <div class="lobby-container">
      <button id="closeRematchBtn">Ã—</button>
      <h2>ğŸ¤ å†ãƒãƒƒãƒãƒ³ã‚°</h2>
      <div id="matchControls">
        <button id="startRematchBtn" style="padding:0.8rem 1.5rem;font-size:1rem;font-weight:600;border:none;border-radius:8px;background:#00d26a;color:#000;box-shadow:0 4px 8px rgba(0,0,0,0.3);cursor:pointer;">
          ğŸš€ ãƒãƒƒãƒãƒ³ã‚°é–‹å§‹
        </button>
        <button id="cancelRematchBtn" style="display:none;padding:0.8rem 1.5rem;font-size:1rem;font-weight:600;border:none;border-radius:8px;background:#ff5555;color:#fff;box-shadow:0 4px 8px rgba(0,0,0,0.3);cursor:pointer;">
          âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <div class="earth-loader" id="rematchLoader">
          <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="var(--landcolor)"/></svg>
          <svg viewBox="0 0 100 100"><circle cx="30" cy="30" r="15" fill="var(--watercolor)"/></svg>
          <svg viewBox="0 0 100 100"><circle cx="70" cy="70" r="20" fill="var(--landcolor)"/></svg>
          <svg viewBox="0 0 100 100"><circle cx="50" cy="20" r="10" fill="var(--watercolor)"/></svg>
        </div>
        <p id="matchStatus" class="status" style="font-size:0.9rem;text-align:center;margin:0.5rem 0;">å†åº¦ãƒãƒƒãƒãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ</p>
      </div>
    </div>
  </div>

<script>
// å¤šè¨€èªå¯¾å¿œ
const i18n = {
  en: {
    waiting: "Waitingâ€¦",
    ready: "Are you ready..?",
    battleFinished: "ğŸ‰ Battle Finished!",
    switch: "Switch!!",
    you: "You",
    opponent: "Opponent",
    turnText: "{name}'s turn ({round}/2)",
    inputPlaceholder: "Type a message...",
    sendButton: "Send"
  },
  ja: {
    waiting: "å¾…æ©Ÿä¸­â€¦",
    ready: "æº–å‚™ã¯ã„ã„ï¼Ÿ",
    battleFinished: "ğŸ‰ ãƒãƒˆãƒ«çµ‚äº†ï¼",
    switch: "äº¤ä»£ï¼ï¼",
    you: "ã‚ãªãŸ",
    opponent: "ç›¸æ‰‹",
    turnText: "{name} ã®ã‚¿ãƒ¼ãƒ³ ({round}/2)",
    inputPlaceholder: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›â€¦",
    sendButton: "é€ä¿¡"
  },
  es: {
    waiting: "Esperandoâ€¦",
    ready: "Â¿EstÃ¡s listo..?",
    battleFinished: "ğŸ‰ Â¡Batalla Terminada!",
    switch: "Â¡Â¡Cambio!!",
    you: "TÃº",
    opponent: "Oponente",
    turnText: "Turno de {name} ({round}/2)",
    inputPlaceholder: "Escribe un mensaje...",
    sendButton: "Enviar"
  },
  fr: {
    waiting: "En attenteâ€¦",
    ready: "Es-tu prÃªt..?",
    battleFinished: "ğŸ‰ Combat TerminÃ© !",
    switch: "Changement !!",
    you: "Vous",
    opponent: "Adversaire",
    turnText: "Tour de {name} ({round}/2)",
    inputPlaceholder: "Tapez un message...",
    sendButton: "Envoyer"
  },
  zh: {
    waiting: "ç­‰å¾…ä¸­â€¦",
    ready: "å‡†å¤‡å¥½äº†å—..?",
    battleFinished: "ğŸ‰ å¯¹æˆ˜ç»“æŸï¼",
    switch: "äº¤æ¢!!",
    you: "ä½ ",
    opponent: "å¯¹æ‰‹",
    turnText: "{name}çš„å›åˆ ({round}/2)",
    inputPlaceholder: "è¾“å…¥æ¶ˆæ¯...",
    sendButton: "å‘é€"
  },
  ko: {
    waiting: "ëŒ€ê¸° ì¤‘â€¦",
    ready: "ì¤€ë¹„ëë‚˜ìš”..?",
    battleFinished: "ğŸ‰ ë°°í‹€ ì¢…ë£Œ!",
    switch: "êµì²´!!",
    you: "ë‚˜",
    opponent: "ìƒëŒ€ë°©",
    turnText: "{name}ì˜ í„´ ({round}/2)",
    inputPlaceholder: "ë©”ì‹œì§€ ì…ë ¥...",
    sendButton: "ë³´ë‚´ê¸°"
  }
};

// è¨€èªè¨­å®š
let lang = localStorage.getItem('locale') || 'ja';
const langSelect = document.getElementById('langSelect');
langSelect.value = lang;
langSelect.addEventListener('change', e => {
  lang = e.target.value;
  localStorage.setItem('locale', lang);
  updateTexts();
});

function updateTexts() {
  const texts = i18n[lang] || i18n.en;
  document.getElementById('phase').textContent = texts.waiting;
  document.getElementById('chat-input').placeholder = texts.inputPlaceholder;
  document.getElementById('sendButton').textContent = texts.sendButton;
  document.documentElement.lang = lang;
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯åå‰ã‚¿ã‚°ã‚’æ›´æ–°
  if (names && socket && socket.id) {
    setNameTags();
  }
}

updateTexts();

const TURN_TIME = 60;

// UI
const overlay      = document.getElementById('overlay');
const phaseEl      = document.getElementById('phase');
const timerEl      = document.getElementById('timer');
const localVid     = document.getElementById('localVideo');
const remoteVid    = document.getElementById('remoteVideo');
const localNameTag = document.getElementById('localName');
const remoteNameTag= document.getElementById('remoteName');
const chatWrap     = document.getElementById('chat-wrap');
const chatMsgs     = document.getElementById('chat-messages');
const chatForm     = document.getElementById('chat-form');
const chatInput    = document.getElementById('chat-input');

// State
let localStream=null, pc, countdownId;
const socket = io();
const roomId = new URLSearchParams(location.search).get('room');
let order, names, countries;

// 1) Media & joinRoom
(async ()=>{
  try{
    localStream = await navigator.mediaDevices.getUserMedia({audio:true,video:true});
  } catch {
    try { localStream = await navigator.mediaDevices.getUserMedia({audio:true,video:false}); }
    catch { localStream = null; }
  }
  if (localStream) localVid.srcObject = localStream;
  pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  localStream?.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack = ({streams:[s]}) => remoteVid.srcObject = s;
  pc.onicecandidate = ({candidate}) => candidate && socket.emit('ice',roomId,candidate);

  socket.emit('joinRoom', roomId);
})();

// 2) Signalling
socket.on('ready', async id => {
  if (socket.id === id) {
    const off = await pc.createOffer(); await pc.setLocalDescription(off);
    socket.emit('offer', roomId, off);
  }
});
socket.on('offer', async o => {
  await pc.setRemoteDescription(o);
  const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
  socket.emit('answer', roomId, ans);
});
socket.on('answer', a => pc.setRemoteDescription(a));
socket.on('ice', c => c && pc.addIceCandidate(c));

// 3) åˆå›ã‚·ãƒ¼ã‚±ãƒ³ã‚¹
socket.on('startSequence', async data => {
  order = data.order; 
  names = data.names; 
  countries = data.countries || {};
  setNameTags();
  const texts = i18n[lang] || i18n.en;
  await showSequence(texts.ready,1000,['3','2','1'],1000,'BEATBOX!!!!',500);
  startTurn(1);
});

// 4) ã‚¿ãƒ¼ãƒ³åˆ‡æ›¿
socket.on('switchTurn', data => {
  order = data.order; 
  names = data.names;
  countries = data.countries || {};
  setNameTags();
  const texts = i18n[lang] || i18n.en;
  showSequence(texts.switch,1000).then(()=> startTurn(data.turn));
});

// 5) Battle çµ‚äº†
socket.on('battleFinished', () => {
  clearInterval(countdownId);
  const texts = i18n[lang] || i18n.en;
  phaseEl.textContent = texts.battleFinished;
  
  // ãƒãƒˆãƒ«çµ‚äº†æ™‚ã«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  document.getElementById('battleEndButtons').style.display = 'flex';
});

// 6) å…±æœ‰ã‚¿ã‚¤ãƒãƒ¼å—ä¿¡
socket.on('timerTick', sec => {
  timerEl.textContent = Math.max(sec, 0);
});

// 7) ãƒãƒ£ãƒƒãƒˆå—ä¿¡
socket.on('chatMessage', data => {
  const div = document.createElement('div');
  div.innerHTML = `<strong>${data.name}:</strong> ${data.text}`;
  chatMsgs.appendChild(div);
  chatMsgs.scrollTop = chatMsgs.scrollHeight;
});

// ãƒãƒ£ãƒƒãƒˆé€ä¿¡
chatForm.addEventListener('submit', e => {
  e.preventDefault();
  const text = chatInput.value.trim();
  if (!text) return;
  socket.emit('chatMessage', { roomId, text });
  chatInput.value = '';
});

// ===== functions =====
function setNameTags(){
  const texts = i18n[lang] || i18n.en;
  
  const myCountry = countries[socket.id] || '';
  const countryFlag = myCountry ? `${getCountryFlag(myCountry)} ` : '';
  localNameTag.innerHTML = `${countryFlag}${names[socket.id] || texts.you}`;
  
  const oppId = Object.keys(names).find(id=>id!==socket.id);
  const oppCountry = countries[oppId] || '';
  const oppFlag = oppCountry ? `${getCountryFlag(oppCountry)} ` : '';
  remoteNameTag.innerHTML = `${oppFlag}${names[oppId] || texts.opponent}`;
}

// å›½ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å›½æ——ã®çµµæ–‡å­—ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getCountryFlag(countryCode) {
  // å›½ã‚³ãƒ¼ãƒ‰ã‚’åœ°åŸŸè­˜åˆ¥å­ã«å¤‰æ›ï¼ˆUnicodeå›½æ——çµµæ–‡å­—ç”¨ï¼‰
  const codePoints = countryCode
    .toUpperCase()
    .split('')
    .map(char => 127397 + char.charCodeAt(0));
  return String.fromCodePoint(...codePoints);
}

function startTurn(turn){
  clearInterval(countdownId);
  let sec = TURN_TIME;
  
  // åˆæœŸå€¤ã‚’è¡¨ç¤º
  timerEl.textContent = sec;
  
  const idx      = (turn-1)%2;
  const actorId  = order[idx];
  const roundNum = Math.ceil(turn/2);
  const texts = i18n[lang] || i18n.en;
  const turnText = texts.turnText
    .replace('{name}', names[actorId])
    .replace('{round}', roundNum);
  phaseEl.textContent = turnText;
  
  // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã®å ´åˆã ã‘ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’ç®¡ç†
  if (socket.id === actorId) {
    countdownId = setInterval(()=>{
      sec--;
      // è‡ªåˆ†ã®ç”»é¢ã«ã¯ç›´æ¥è¡¨ç¤º
      timerEl.textContent = Math.max(sec, 0);
      
      // ä»–ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã®ã¿å€¤ã‚’é€ä¿¡
      socket.emit('timerTick', roomId, sec);
      
      if (sec <= 0) {
        clearInterval(countdownId);
        socket.emit('turnEnd', roomId);
      }
    },1000);
  }
}

async function showSequence(firstText, firstMs, list=[], eachMs=1000, lastText='', lastMs=0){
  overlay.hidden = false; overlay.style.display = 'flex';
  overlay.textContent = firstText; await delay(firstMs);
  for(const txt of list){ overlay.textContent = txt; await delay(eachMs); }
  if(lastText){ overlay.textContent = lastText; await delay(lastMs); }
  overlay.style.display = 'none'; overlay.hidden = true;
}

const delay = ms => new Promise(r => setTimeout(r,ms));

// ãƒãƒˆãƒ«çµ‚äº†å¾Œã®ãƒœã‚¿ãƒ³é–¢é€£ã®å‡¦ç†
const battleEndButtons = document.getElementById('battleEndButtons');
const backToLobbyBtn = document.getElementById('backToLobbyBtn');
const rematchBtn = document.getElementById('rematchBtn');
const rematchPopup = document.getElementById('rematchPopup');
const closeRematchBtn = document.getElementById('closeRematchBtn');
const startRematchBtn = document.getElementById('startRematchBtn');
const cancelRematchBtn = document.getElementById('cancelRematchBtn');
const rematchLoader = document.getElementById('rematchLoader');
const matchStatus = document.getElementById('matchStatus');

// ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³
backToLobbyBtn.addEventListener('click', () => {
  window.location.href = '/lobby.html';
});

// å†åº¦ãƒãƒƒãƒãƒ³ã‚°ãƒœã‚¿ãƒ³
rematchBtn.addEventListener('click', () => {
  // ãƒªãƒãƒƒãƒç”¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
  rematchPopup.style.display = 'flex';
});

// ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
closeRematchBtn.addEventListener('click', () => {
  rematchPopup.style.display = 'none';
});

// ãƒãƒƒãƒãƒ³ã‚°é–‹å§‹ãƒœã‚¿ãƒ³
startRematchBtn.addEventListener('click', () => {
  startRematchBtn.style.display = 'none';
  cancelRematchBtn.style.display = 'block';
  rematchLoader.style.display = 'flex';
  const texts = i18n[lang] || i18n.en;
  matchStatus.textContent = texts.statusMatch || 'ãƒãƒƒãƒãƒ³ã‚°ä¸­...';
  
  // ã‚µãƒ¼ãƒãƒ¼ã«ãƒãƒƒãƒãƒ³ã‚°è¦æ±‚ã‚’é€ä¿¡
  socket.emit('joinBattleQueue');
});

// ãƒãƒƒãƒãƒ³ã‚°ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
cancelRematchBtn.addEventListener('click', () => {
  cancelRematchBtn.style.display = 'none';
  startRematchBtn.style.display = 'block';
  rematchLoader.style.display = 'none';
  const texts = i18n[lang] || i18n.en;
  matchStatus.textContent = texts.statusReady || 'å†åº¦ãƒãƒƒãƒãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ';
  
  // ãƒãƒƒãƒãƒ³ã‚°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  socket.emit('cancelBattleQueue');
});

// ãƒãƒƒãƒãƒ³ã‚°æˆåŠŸæ™‚ã®å‡¦ç†ã‚’è¿½åŠ 
socket.on('matched', ({ roomId }) => {
  rematchLoader.style.display = 'none';
  // æ–°ã—ã„éƒ¨å±‹ã¸ç§»å‹•
  location.href = `/chat.html?room=${encodeURIComponent(roomId)}`;
});
</script>
</body>
</html>
