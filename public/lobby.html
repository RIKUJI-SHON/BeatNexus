<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BeatNexus ‚Äì Lobby</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <style>
    body {
      margin: 0;
      background: var(--bg-1);
      color: var(--text-1);
      font-family: 'Inter', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #111111, #222222);
    }
    .container {
      position: relative;
      width: 90vw;
      max-width: 450px;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(12px);
      border-radius: var(--radius);
      padding: 1.2rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.6rem;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* „Åì„Åì„Åã„ÇâÊñ∞„Åó„ÅÑ„É¶„Éº„Ç∂„Éº„Ç¢„ÇØ„Ç∑„Éß„É≥„Çπ„Çø„Ç§„É´ */
    #userActions {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.3rem;
    }
    
    /* „Çª„Ç´„É≥„ÉÄ„É™„Éº„Éú„Çø„É≥ÔºàEdit Profile, SettingsÔºâ */
    #editProfileBtn, #settingsBtn {
      width: 100% !important;
      padding: .8rem !important;
      font-size: 1rem !important;
      font-weight: 600 !important;
      border: none !important;
      border-radius: var(--radius) !important;
      cursor: pointer !important;
      background: #2a2a2a !important;
      color: #fff !important;
      box-shadow: 0 0 4px rgba(85, 221, 224, 0.2), 0 4px 8px rgba(0,0,0,0.2) !important;
      border: 1px solid rgba(85, 221, 224, 0.15) !important;
      transition: transform .2s, background-color .2s, box-shadow .2s !important;
    }
    
    #editProfileBtn:hover, #settingsBtn:hover {
      transform: translateY(-2px) !important;
      background: #323232 !important;
      box-shadow: 0 0 8px rgba(85, 221, 224, 0.3), 0 6px 12px rgba(0,0,0,0.3) !important;
      border-color: rgba(85, 221, 224, 0.25) !important;
    }
    
    /* Logout „Éú„Çø„É≥ÔºàÂç±Èô∫„Å™„Ç¢„ÇØ„Ç∑„Éß„É≥Ôºâ */
    #logoutBtn {
      width: 100% !important;
      padding: .8rem !important;
      font-size: 1rem !important;
      font-weight: 600 !important;
      border: none !important;
      border-radius: var(--radius) !important;
      cursor: pointer !important;
      background: rgba(220, 53, 53, 0.15) !important;
      color: #fff !important;
      border: 1px solid rgba(220, 53, 53, 0.3) !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 0.5rem !important;
      transition: transform .2s, background-color .2s, box-shadow .2s !important;
    }
    
    #logoutBtn:hover {
      transform: translateY(-2px) !important;
      background: rgba(220, 53, 53, 0.25) !important;
      box-shadow: 0 0 8px rgba(220, 53, 53, 0.3), 0 6px 12px rgba(0,0,0,0.3) !important;
    }
    /* „Åì„Åì„Åæ„ÅßÊñ∞„Åó„ÅÑ„É¶„Éº„Ç∂„Éº„Ç¢„ÇØ„Ç∑„Éß„É≥„Çπ„Çø„Ç§„É´ */
    
    h1 {
      font-family: 'Russo One', sans-serif;
      font-size: 1.6rem;
      margin: 0;
      color: var(--accent);
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    #previewWrap {
      width: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      align-items: center;
      margin-bottom: 0.2rem;
    }
    #previewVideo {
      width: 100%;
      max-width: 320px;
      aspect-ratio: 16/9;
      border-radius: var(--radius);
      background: #000;
      object-fit: cover;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
      border: 2px solid rgba(255,255,255,0.1);
    }
    
    /* „Éá„Éê„Ç§„Çπ„Çπ„ÉÜ„Éº„Çø„Çπ„Ç§„É≥„Ç∏„Ç±„Éº„Çø */
    #deviceStatus {
      display: flex;
      gap: 0.6rem;
      margin-top: 0.5rem;
      justify-content: center;
    }
    .device-indicator {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      background: rgba(0,0,0,0.3);
      padding: 0.4rem 0.6rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      position: relative;
      cursor: help;
    }
    .indicator-dot {
      width: 0.8rem;
      height: 0.8rem;
      border-radius: 50%;
      background: #DC3535;
      transition: background-color 0.3s ease;
    }
    .indicator-dot.active {
      background: #4CD964;
    }
    .device-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(0.5rem);
      background: rgba(30, 30, 30, 0.9);
      color: #fff;
      padding: 0.5rem 0.8rem;
      border-radius: var(--radius);
      font-size: 0.75rem;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      pointer-events: none;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .device-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(30, 30, 30, 0.9);
    }
    .device-indicator:hover .device-tooltip {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }
    
    /* „Ç´„É°„É©„Éà„Ç∞„É´„Çπ„Ç§„ÉÉ„ÉÅ - „Éá„Éï„Ç©„É´„Éà„ÅØÂè≥‰∏ä„Å´ÈÖçÁΩÆ */
    #cameraToggleWrap {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(0,0,0,0.6);
      border-radius: 30px;
      padding: 5px 10px;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* „Çø„Éñ„É¨„ÉÉ„ÉàÔºàiPadÔºâË°®Á§∫Áî®„ÅÆ„É¨„Ç§„Ç¢„Ç¶„ÉàË™øÊï¥ */
    @media (min-width: 768px) and (max-width: 1024px) {
      #previewWrap {
        align-items: center;
      }
      #previewVideo {
        width: 100%;
        max-width: 600px;
        aspect-ratio: 16/9;
        height: auto;
      }
      /* „Ç´„É°„É©„Éà„Ç∞„É´„ÇíÂãïÁîª„ÅÆ‰∏ã„Å´ÈÖçÁΩÆ */
      #cameraToggleWrap {
        position: static;
        margin-top: 12px;
        justify-content: center;
        width: auto;
      }
      /* „Éá„Éê„Ç§„Çπ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ‰ΩçÁΩÆ„ÇÇË™øÊï¥ */
      #deviceStatus {
        margin-top: 12px;
      }
    }
    
    #toggleLabel {
      font-weight: 600;
      font-size: 0.8rem;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }
    .switch { --circle-dim:1.2em; position: relative; display: inline-block; width: 3em; height: 1.5em; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      inset: 0;
      background: rgba(220, 53, 53, 0.3);
      border-radius: 30px;
      transition: .3s;
      backdrop-filter: blur(4px);
    }
    .slider-card {
      position: absolute;
      bottom: .15em;
      left: .15em;
      width: var(--circle-dim);
      height: var(--circle-dim);
      background: #DC3535;
      border-radius: 50%;
      transition: .3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .switch input:checked ~ .slider-card { transform: translateX(1.5em); background: #4CD964; }
    .switch input:checked ~ .slider { background: rgba(76, 217, 100, 0.3); }
    #controls {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: .5rem;
    }
    #controls button {
      width: 100%;
      padding: .7rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      background: var(--accent);
      color: #000;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform .2s, background-color .2s;
    }
    #controls button:disabled {
      opacity: .6;
      cursor: not-allowed;
      background-color: #505050;
      color: #aaaaaa;
      box-shadow: none;
    }
    #controls button:not(:disabled):hover {
      transform: translateY(-2px);
      background-color: var(--accent-dark);
    }
    #cancelBattle { 
      background: rgba(220, 53, 53, 0.8) !important;
      color: white !important;
    }
    
    #cancelBattle:hover {
      background: rgba(220, 53, 53, 1) !important;
      transform: translateY(-2px);
    }

    .earth-loader {
      --watercolor: #4aa4e0;
      --landcolor: #6dbf4b;
      display: none;
      width: 2.5rem;
      height: 2.5rem;
      background-color: var(--watercolor);
      position: relative;
      overflow: hidden;
      border-radius: 50%;
      border: .15em solid white;
      box-shadow: inset 0 .4em rgba(255,255,255,0.25), inset 0 -.4em rgba(0,0,0,0.25);
      align-items: center;
      justify-content: center;
      margin: 0.2rem 0;
    }
    .earth-loader svg { position: absolute; width: 2rem; height: auto; }
    .earth-loader svg:nth-child(1) { bottom: -0.8rem; animation: round1 5s infinite linear .6s; }
    .earth-loader svg:nth-child(2) { top: -1.2rem; animation: round1 5s infinite linear; }
    .earth-loader svg:nth-child(3) { top: -1rem; animation: round2 5s infinite linear; }
    .earth-loader svg:nth-child(4) { bottom: -0.9rem; animation: round2 5s infinite linear .6s; }
    @keyframes round1 { 0%{left:-.8rem;}30%{left:-2rem;opacity:1;}31%{opacity:0;}35%{left:3rem;}45%{opacity:1;}100%{left:-.8rem;} }
    @keyframes round2 { 0%{left:1rem;}75%{left:-3rem;opacity:1;}76%{opacity:0;}80%{opacity:1;}100%{left:1rem;} }

    .status {
      font-size: .8rem;
      color: var(--text-2);
      text-align: center;
      height: 1rem;
      margin: 0.2rem 0;
    }
    
    /* ‰ª•Ââç„ÅÆË®≠ÂÆöÔºà‰∏ãÁ∑ö‰ªò„ÅçÔºâ„ÇíÂâäÈô§ */
    #editProfileBtn {
      background: transparent;
      border: none;
      color: var(--accent);
      cursor: pointer;
      transition: color 0.2s, transform 0.2s;
      text-decoration: none;
    }
    
    #editProfileBtn:hover {
      color: var(--accent);
      transform: translateY(-1px);
    }
    
    #logoutBtn, #editProfileBtn {
      background: transparent;
      border: none;
      color: var(--text-2);
      text-decoration: none;
      cursor: pointer;
      padding: 0.5rem 1rem;
      transition: color 0.2s, transform 0.2s;
    }
    #logoutBtn:hover, #editProfileBtn:hover {
      color: var(--text-1);
      transform: translateY(-1px);
    }
    #editProfileBtn {
      color: var(--accent);
      margin-top: 0.5rem;
      text-decoration: none;
      border: 1px solid var(--accent);
      border-radius: var(--radius);
    }
    #editProfileBtn:hover {
      background-color: rgba(85, 221, 224, 0.1);
    }

    /* Modal */
    #editModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #editModal .card {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(12px);
      padding: 2rem;
      border-radius: var(--radius);
      width: 90vw;
      max-width: 480px;
      color: var(--text-1);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
    }
    #editModal h2 {
      margin-top: 0;
      font-family: 'Russo One', sans-serif;
      color: var(--accent);
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      text-align: center;
    }
    #editModal label {
      font-weight: 600;
      margin-bottom: .3rem;
      font-size: .95rem;
    }
    #editModal input,
    #editModal select {
      width: 100%;
      padding: .75rem 1rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius);
      background: rgba(0,0,0,0.2);
      color: var(--text-1);
      font-size: 1rem;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }
    #editModal input:focus,
    #editModal select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(85, 221, 224, 0.3);
    }
    #saveProfileBtn,
    #cancelEditBtn {
      width: 100%;
      padding: .8rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: transform .2s, background-color .2s;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    #saveProfileBtn {
      background: var(--accent);
      color: #000;
    }
    #saveProfileBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      background: var(--accent-dark);
    }
    #saveProfileBtn:disabled {
      opacity: .5;
      cursor: not-allowed;
    }
    #cancelEditBtn {
      background: var(--bg-2);
      color: var(--text-1);
      border: 1px solid rgba(255,255,255,0.1);
    }
    #cancelEditBtn:hover {
      transform: translateY(-2px);
      background: rgba(255,255,255,0.1);
    }
    
    .level-selection {
      display: flex;
      align-items: center;
    }

    /* Tooltip for level guidance */
    .info-icon {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: 0.5rem;
      cursor: pointer;
      width: 1.6rem;
      height: 1.6rem;
      background: var(--accent);
      color: #000;
      border-radius: 50%;
      font-size: 1rem;
    }
    .info-icon .tooltip {
      position: absolute;
      left: calc(100% + 0.5rem);
      top: 50%;
      transform: translateY(-50%) translateX(-0.5rem);
      background: var(--bg-2);
      color: var(--text-1);
      padding: 0.8rem;
      border-radius: var(--radius);
      white-space: pre-wrap;
      font-size: 0.85rem;
      line-height: 1.4;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 100;
      pointer-events: none;
      min-width: 240px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .info-icon .tooltip::before {
      content: '';
      position: absolute;
      left: -0.5rem;
      top: 50%;
      transform: translateY(-50%);
      border: 0.5rem solid transparent;
      border-right-color: var(--bg-2);
    }
    .info-icon:hover .tooltip {
      opacity: 1;
      visibility: visible;
      transform: translateY(-50%) translateX(0);
    }

    /* Mobile styles */
    @media (max-width: 767px) {
      .container {
        padding: 1rem;
        width: 95%;
        gap: 0.5rem;
      }
      
      h1 {
        font-size: 1.4rem;
        margin-bottom: 0.3rem;
      }
      
      #previewVideo {
        max-width: 100%;
      }
      
      #controls button {
        padding: 0.6rem;
      }
      
      #controls {
        gap: 0.4rem;
      }
      
      .status {
        margin: 0;
      }
      
      #userActions {
        gap: 0.4rem;
      }
      
      #userActions button {
        padding: 0.6rem;
      }
      
      .info-icon .tooltip {
        left: 50%;
        top: 100%;
        transform: translateX(-50%) translateY(-0.5rem);
        width: 90vw;
        max-width: 300px;
      }
      
      .info-icon .tooltip::before {
        left: 50%;
        top: -0.5rem;
        transform: translateX(-50%);
        border-color: transparent;
        border-bottom-color: var(--bg-2);
      }
      
      .info-icon:hover .tooltip {
        transform: translateX(-50%) translateY(0);
      }
      
      #editModal .card {
        padding: 1.5rem;
      }
    }

    /* PCÁî®„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà */
    @media (min-width: 992px) {
      .container {
        max-width: 80%;
        width: 900px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
          "header header"
          "video controls"
          "buttons buttons";
        column-gap: 1.5rem;
        row-gap: 0.8rem;
        padding: 1.5rem;
      }
      
      h1 {
        grid-area: header;
        text-align: center;
        margin-bottom: 1rem;
      }
      
      #previewWrap {
        grid-area: video;
        width: 100%;
      }
      
      #controls {
        grid-area: controls;
        align-self: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: .5rem;
      }
      
      #cameraToggleWrap {
        align-self: flex-start;
        margin-bottom: 1rem;
      }
      
      /* PC„É¨„Ç§„Ç¢„Ç¶„Éà„Åß„ÅÆ„É¶„Éº„Ç∂„Éº„Ç¢„ÇØ„Ç∑„Éß„É≥ */
      #userActions {
        grid-area: buttons;
        flex-direction: row;
        justify-content: center;
        gap: 0.8rem;
        margin-top: 0.8rem;
      }
      
      #userActions button {
        width: auto !important;
        min-width: 150px !important;
      }
      
      #previewVideo {
        width: 100%;
        max-width: none;
      }
    }

    #userActions {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }
    
    #userActions button {
      width: 100%;
      padding: .8rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      background: var(--bg-2);
      color: var(--text-1);
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform .2s, background-color .2s;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    #userActions button:hover {
      transform: translateY(-2px);
      background: rgba(255,255,255,0.1);
    }

    /* Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ */
    #settingsModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #settingsModal .card {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(12px);
      padding: 2rem;
      border-radius: var(--radius);
      width: 90vw;
      max-width: 480px;
      color: var(--text-1);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
      max-height: 80vh;
      overflow-y: auto;
    }
    #settingsModal h2 {
      margin-top: 0;
      font-family: 'Russo One', sans-serif;
      color: var(--accent);
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      text-align: center;
    }
    #settingsModal label {
      font-weight: 600;
      margin-bottom: .3rem;
      font-size: .95rem;
    }
    #settingsModal select {
      width: 100%;
      padding: .75rem 1rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius);
      background: rgba(0,0,0,0.2);
      color: var(--text-1);
      font-size: 1rem;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }
    #settingsModal select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(85, 221, 224, 0.3);
    }
    
    /* „Éû„Ç§„ÇØ„ÉÜ„Çπ„ÉàÈñ¢ÈÄ£ */
    #micTestContainer {
      margin-bottom: 1.5rem;
    }
    .mic-test-display {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    .volume-meter {
      flex: 1;
      height: 24px;
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.05);
    }
    .meter-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, #4CD964, #55dde0);
      border-radius: 12px;
      transition: width 0.05s ease;
    }
    #micTestBtn {
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    #micTestBtn:hover {
      background: var(--accent-dark);
      transform: translateY(-2px);
    }
    #micTestBtn.testing {
      background: #DC3535;
    }
    .mic-status {
      font-size: 0.9rem;
      color: var(--text-2);
      margin-top: 0.5rem;
      text-align: center;
      min-height: 1.2rem;
    }
    
    /* „Ç´„É°„É©„Éó„É¨„Éì„É•„ÉºÈñ¢ÈÄ£ÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ */
    #cameraPreviewContainer {
      width: 100%;
      margin: 0.5rem 0 1.5rem;
      border-radius: var(--radius);
      overflow: hidden;
      position: relative;
    }
    
    #settingsCameraPreview {
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      object-fit: cover;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* „Çπ„Éî„Éº„Ç´„Éº„ÉÜ„Çπ„ÉàÈñ¢ÈÄ£ÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ */
    #speakerTestContainer {
      margin: 0.5rem 0 1.5rem;
    }
    
    #speakerTestBtn {
      width: 100%;
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    #speakerTestBtn:hover {
      background: var(--accent-dark);
      transform: translateY(-2px);
    }
    
    #speakerTestBtn:active {
      transform: scale(0.95);
    }
    
    /* Ë®ÄË™ûÈÅ∏ÊäûÈñ¢ÈÄ£ÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ */
    #settingsLangSelect {
      margin-bottom: 1.5rem;
    }
    
    #saveSettingsBtn,
    #cancelSettingsBtn {
      width: 100%;
      padding: .8rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: transform .2s, background-color .2s;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    #saveSettingsBtn {
      background: var(--accent);
      color: #000;
    }
    #saveSettingsBtn:hover {
      transform: translateY(-2px);
      background: var(--accent-dark);
    }
    #cancelSettingsBtn {
      background: var(--bg-2);
      color: var(--text-1);
      border: 1px solid rgba(255,255,255,0.1);
    }
    #cancelSettingsBtn:hover {
      transform: translateY(-2px);
      background: rgba(255,255,255,0.1);
    }

    /* „Çπ„Éû„ÉõÂêë„Åë„Å´Â∞ë„ÅóË™øÊï¥ */
    @media (max-width: 767px) {
      #settingsModal .card {
        max-height: 85vh;
        padding-right: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé§ BeatNexus</h1>

    <div id="previewWrap">
      <video id="previewVideo" autoplay muted playsinline></video>
      <div id="cameraToggleWrap">
        <label class="switch">
          <input type="checkbox" id="cameraToggle">
          <span class="slider"></span>
          <span class="slider-card"></span>
        </label>
        <span id="toggleLabel">Camera On</span>
      </div>
      <div id="deviceStatus">
        <div class="device-indicator" id="micIndicator">
          <span class="indicator-dot" id="micDot"></span>
          <span>üé§</span>
          <div class="device-tooltip" id="micTooltip">No microphone</div>
        </div>
        <div class="device-indicator" id="speakerIndicator">
          <span class="indicator-dot" id="speakerDot"></span>
          <span>üîä</span>
          <div class="device-tooltip" id="speakerTooltip">No speaker</div>
        </div>
      </div>
    </div>

    <div id="controls">
      <div class="earth-loader" id="loader">
        <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="var(--landcolor)"/></svg>
        <svg viewBox="0 0 100 100"><circle cx="30" cy="30" r="15" fill="var(--watercolor)"/></svg>
        <svg viewBox="0 0 100 100"><circle cx="70" cy="70" r="20" fill="var(--landcolor)"/></svg>
        <svg viewBox="0 0 100 100"><circle cx="50" cy="20" r="10" fill="var(--watercolor)"/></svg>
      </div>
      <p id="status" class="status">Connecting to server‚Ä¶</p>
      <button id="startBattle" disabled>üöÄ Start Battle</button>
      <button id="cancelBattle" style="display:none">‚ùå Cancel</button>
    </div>

    <div id="userActions">
      <button id="editProfileBtn">‚úèÔ∏è Edit Profile</button>
      <button id="settingsBtn">‚öô Settings</button>
      <button id="logoutBtn">üö™ Logout</button>
    </div>
  </div>

  <!-- Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
  <div id="settingsModal">
    <div class="card">
      <h2 id="settingsTitle">Settings</h2>

      <!-- „Éû„Ç§„ÇØË®≠ÂÆö -->
      <label id="micSelectLbl">Microphone</label>
      <select id="micSelect">
        <option value="">Loading microphones...</option>
      </select>

      <div id="micTestContainer">
        <label id="micTestLbl">Microphone Test</label>
        <div class="mic-test-display">
          <div class="volume-meter">
            <div class="meter-bar"></div>
          </div>
          <button id="micTestBtn">Test</button>
        </div>
        <div class="mic-status" id="micStatus"></div>
      </div>

      <!-- „Ç´„É°„É©Ë®≠ÂÆöÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ -->
      <label id="cameraSelectLbl">Camera</label>
      <select id="cameraSelect">
        <option value="">Loading cameras...</option>
      </select>

      <!-- Âá∫Âäõ„Éá„Éê„Ç§„ÇπË®≠ÂÆöÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ -->
      <label id="speakerSelectLbl">Speaker</label>
      <select id="speakerSelect">
        <option value="">Loading speakers...</option>
      </select>

      <div id="speakerTestContainer">
        <button id="speakerTestBtn">Test Speaker</button>
      </div>

      <!-- Ë®ÄË™ûË®≠ÂÆöÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ -->
      <label id="langSelectLbl">Language</label>
      <select id="settingsLangSelect">
        <option value="en">English</option>
        <option value="ja">Êó•Êú¨Ë™û</option>
        <option value="es">Espa√±ol</option>
        <option value="fr">Fran√ßais</option>
        <option value="zh">‰∏≠Êñá</option>
        <option value="ko">ÌïúÍµ≠Ïñ¥</option>
      </select>

      <button id="saveSettingsBtn">Save</button>
      <button id="cancelSettingsBtn">Cancel</button>
    </div>
  </div>

  <div id="editModal">
    <div class="card">
      <h2>Profile</h2>

      <label id="nameLbl">Name</label>
      <input type="text" id="editName">

      <label id="countryLbl">Country</label>
      <select id="editCountry">
        <option value="">--</option>
        <option value="JP">üáØüáµ Japan</option>
        <option value="US">üá∫üá∏ United States</option>
        <option value="KR">üá∞üá∑ Korea</option>
        <option value="IN">üáÆüá≥ India</option>
        <option value="FR">üá´üá∑ France</option>
        <option value="DE">üá©üá™ Germany</option>
        <option value="BR">üáßüá∑ Brazil</option>
        <option value="PH">üáµüá≠ Philippines</option>
        <option value="TH">üáπüá≠ Thailand</option>
        <option value="GB">üá¨üáß United Kingdom</option>
      </select>

      <label id="levelLbl">Beatbox Level</label>
      <div class="level-selection">
        <select id="editLevel">
          <option value="">--</option>
          <option value="beginner">üíß Beginner</option>
          <option value="middle">üå± Middle-class</option>
          <option value="advanced">üî• Advanced</option>
          <option value="top">üèÜ Top Player</option>
        </select>
        <span class="info-icon">‚ÑπÔ∏è
          <span class="tooltip"></span>
        </span>
      </div>

      <button id="saveProfileBtn" disabled>Save</button>
      <button id="cancelEditBtn">Cancel</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const texts = {
        en: {
          toggleOn: 'Camera On', toggleOff: 'Camera Off',
          start: 'üöÄ Start Battle', cancel: '‚ùå Cancel',
          statusConn: 'Connecting...', statusReady: '',
          statusMatch: 'Matching‚Ä¶', statusLeave: 'Opponent left.',
          logout: 'Logout', edit: 'Edit Profile', settings: 'Settings',
          name: 'Name', country: 'Country', level: 'Beatbox Level',
          settingsTitle: 'Settings',
          microphone: 'Microphone',
          micTest: 'Microphone Test',
          testMic: 'Test', stopTest: 'Stop',
          micDetected: 'Microphone detected',
          micNotDetected: 'No microphone detected',
          micGood: 'Microphone is working well',
          micLow: 'Microphone volume too low',
          saveSettings: 'Save', cancelSettings: 'Cancel',
          camera: 'Camera',
          cameraLoading: 'Loading cameras...',
          cameraNotDetected: 'No camera detected',
          speaker: 'Speaker',
          speakerLoading: 'Loading speakers...',
          speakerNotDetected: 'No speaker detected',
          testSpeaker: 'Test Speaker',
          language: 'Language',
          levelGuide:
`üèÖ Beginner üíß
 ‚îî only basic three sounds / <1 yr / no battle experience / mostly spectator

üèÖ Middle-class üå±
 ‚îî basics stable + some special sounds / 1‚Äì3 yrs / local battles

üèÖ Advanced üî•
 ‚îî multiple advanced techniques / 3‚Äì5 yrs / mid-level contest placements

üèÖ Top Player üèÜ
 ‚îî pro-level / 5+ yrs / national & international titles

‚Äª The above are only guidelines.`,
        },
        ja: {
          toggleOn: '„Ç´„É°„É©ON', toggleOff: '„Ç´„É°„É©OFF',
          start: 'üöÄ ÂØæÊà¶„Çπ„Çø„Éº„Éà', cancel: '‚ùå „Ç≠„É£„É≥„Çª„É´',
          statusConn: 'Êé•Á∂ö‰∏≠...', statusReady: '',
          statusMatch: '„Éû„ÉÉ„ÉÅ„É≥„Ç∞‰∏≠‚Ä¶', statusLeave: 'Áõ∏Êâã„ÅåÂàáÊñ≠„Åó„Åæ„Åó„Åü„ÄÇ',
          logout: '„É≠„Ç∞„Ç¢„Ç¶„Éà', edit: '„Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ', settings: 'Ë®≠ÂÆö',
          name: 'ÂêçÂâç', country: 'ÂõΩÁ±ç', level: '„É¨„Éô„É´',
          settingsTitle: 'Ë®≠ÂÆö',
          microphone: '„Éû„Ç§„ÇØ',
          micTest: '„Éû„Ç§„ÇØ„ÉÜ„Çπ„Éà',
          testMic: '„ÉÜ„Çπ„Éà', stopTest: 'ÂÅúÊ≠¢',
          micDetected: '„Éû„Ç§„ÇØ„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü',
          micNotDetected: '„Éû„Ç§„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì',
          micGood: '„Éû„Ç§„ÇØ„ÅØÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô',
          micLow: 'Èü≥Èáè„ÅåÂ∞è„Åï„Åô„Åé„Åæ„Åô',
          saveSettings: '‰øùÂ≠ò', cancelSettings: '„Ç≠„É£„É≥„Çª„É´',
          camera: '„Ç´„É°„É©',
          cameraLoading: '„Ç´„É°„É©„ÇíË™≠„ÅøËæº„Åø‰∏≠...',
          cameraNotDetected: '„Ç´„É°„É©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì',
          speaker: '„Çπ„Éî„Éº„Ç´„Éº',
          speakerLoading: '„Çπ„Éî„Éº„Ç´„Éº„ÇíË™≠„ÅøËæº„Åø‰∏≠...',
          speakerNotDetected: '„Çπ„Éî„Éº„Ç´„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì',
          testSpeaker: '„Çπ„Éî„Éº„Ç´„Éº„ÉÜ„Çπ„Éà',
          language: 'Ë®ÄË™û',
          levelGuide:
`üèÖ „Éì„ÇÆ„Éä„Éº üíß  
 ‚îî Âü∫Á§é3Èü≥„Åå„ÇÑ„Å£„Å® / 1Âπ¥Êú™Ê∫Ä / „Éê„Éà„É´Êú™ÁµåÈ®ì / Ë¶≥Êà¶„É°„Ç§„É≥

üèÖ „Éü„Éâ„É´„ÇØ„É©„Çπ üå±  
 ‚îî Âü∫Á§éÂÆâÂÆöÔºãÁâπÊÆäÈü≥Â∞ë„Åó / 1‚Äì3Âπ¥ / „É≠„Éº„Ç´„É´Â§ß‰ºöÁµåÈ®ì

üèÖ „Ç¢„Éâ„Éê„É≥„Çπ üî•  
 ‚îî ‰∏äÁ¥ö„ÉÜ„ÇØ„Éã„ÉÉ„ÇØË§áÊï∞ / 3‚Äì5Âπ¥ / ‰∏≠Ë¶èÊ®°Â§ß‰ºöÂÖ•Ë≥û

üèÖ „Éà„ÉÉ„Éó„Éó„É¨„Ç§„É§„Éº üèÜ  
 ‚îî „Éó„É≠Á¥ö / 5Âπ¥‰ª•‰∏ä / ÂõΩÂÜÖÂ§ñÂ§ß‰ºö‰∏ä‰ΩçÂ∏∏ÈÄ£

‚Äª ‰∏äË®ò„ÅÆÂÜÖÂÆπ„ÅØ„ÅÇ„Åè„Åæ„ÅßÁõÆÂÆâ„Åß„Åô„ÄÇ`
        },
        es: {
          toggleOn: 'C√°mara Activada', toggleOff: 'C√°mara Desactivada',
          start: 'üöÄ Comenzar Batalla', cancel: '‚ùå Cancelar',
          statusConn: 'Conectando...', statusReady: '',
          statusMatch: 'Buscando rival‚Ä¶', statusLeave: 'El oponente se ha ido.',
          logout: 'Cerrar sesi√≥n', edit: 'Editar Perfil', settings: 'Configuraci√≥n',
          name: 'Nombre', country: 'Pa√≠s', level: 'Nivel de Beatbox',
          settingsTitle: 'Configuraci√≥n',
          microphone: 'Micr√≥fono',
          micTest: 'Prueba de Micr√≥fono',
          testMic: 'Probar', stopTest: 'Parar',
          micDetected: 'Micr√≥fono detectado',
          micNotDetected: 'No se detect√≥ ning√∫n micr√≥fono',
          micGood: 'El micr√≥fono funciona bien',
          micLow: 'Volumen del micr√≥fono demasiado bajo',
          saveSettings: 'Guardar', cancelSettings: 'Cancelar',
          camera: 'C√°mara',
          cameraLoading: 'Cargando c√°maras...',
          cameraNotDetected: 'No se detect√≥ ninguna c√°mara',
          speaker: 'Altavoz',
          speakerLoading: 'Cargando altavoces...',
          speakerNotDetected: 'No se detect√≥ ning√∫n altavoz',
          testSpeaker: 'Probar Altavoz',
          language: 'Idioma',
          levelGuide:
`üèÖ Principiante üíß
 ‚îî solo tres sonidos b√°sicos / <1 a√±o / sin experiencia en batallas / principalmente espectador

üèÖ Clase media üå±
 ‚îî b√°sicos estables + algunos sonidos especiales / 1-3 a√±os / batallas locales

üèÖ Avanzado üî•
 ‚îî m√∫ltiples t√©cnicas avanzadas / 3-5 a√±os / clasificaciones en concursos de nivel medio

üèÖ Jugador Top üèÜ
 ‚îî nivel profesional / 5+ a√±os / t√≠tulos nacionales e internacionales

‚Äª Lo anterior son solo pautas.`,
        },
        fr: {
          toggleOn: 'Cam√©ra Activ√©e', toggleOff: 'Cam√©ra D√©sactiv√©e',
          start: 'üöÄ Commencer le Combat', cancel: '‚ùå Annuler',
          statusConn: 'Connexion...', statusReady: '',
          statusMatch: 'Recherche d\'adversaire‚Ä¶', statusLeave: 'L\'adversaire est parti.',
          logout: 'D√©connexion', edit: 'Modifier le Profil', settings: 'Param√®tres',
          name: 'Nom', country: 'Pays', level: 'Niveau de Beatbox',
          settingsTitle: 'Param√®tres',
          microphone: 'Microphone',
          micTest: 'Test de Microphone',
          testMic: 'Tester', stopTest: 'Arr√™ter',
          micDetected: 'Microphone d√©tect√©',
          micNotDetected: 'Aucun microphone d√©tect√©',
          micGood: 'Le microphone fonctionne bien',
          micLow: 'Volume du microphone trop bas',
          saveSettings: 'Enregistrer', cancelSettings: 'Annuler',
          camera: 'Cam√©ra',
          cameraLoading: 'Chargement des cam√©ras...',
          cameraNotDetected: 'Aucune cam√©ra d√©tect√©e',
          speaker: 'Haut-parleur',
          speakerLoading: 'Chargement des haut-parleurs...',
          speakerNotDetected: 'Aucun haut-parleur d√©tect√©',
          testSpeaker: 'Tester Haut-parleur',
          language: 'Langue',
          levelGuide:
`üèÖ D√©butant üíß
 ‚îî seulement trois sons basiques / <1 an / pas d'exp√©rience de bataille / principalement spectateur

üèÖ Classe moyenne üå±
 ‚îî bases stables + quelques sons sp√©ciaux / 1-3 ans / batailles locales

üèÖ Avanc√© üî•
 ‚îî plusieurs techniques avanc√©es / 3-5 ans / placements dans des concours de niveau interm√©diaire

üèÖ Joueur de haut niveau üèÜ
 ‚îî niveau pro / 5+ ans / titres nationaux et internationaux

‚Äª Ce qui pr√©c√®de n'est qu'un guide.`,
        },
        zh: {
          toggleOn: 'ÂºÄÂêØÊëÑÂÉèÂ§¥', toggleOff: 'ÂÖ≥Èó≠ÊëÑÂÉèÂ§¥',
          start: 'üöÄ ÂºÄÂßãÂØπÊàò', cancel: '‚ùå ÂèñÊ∂à',
          statusConn: 'ËøûÊé•‰∏≠...', statusReady: '',
          statusMatch: 'ÂåπÈÖç‰∏≠‚Ä¶', statusLeave: 'ÂØπÊâãÂ∑≤Á¶ªÂºÄ„ÄÇ',
          logout: 'ÈÄÄÂá∫ÁôªÂΩï', edit: 'ÁºñËæë‰∏™‰∫∫ËµÑÊñô', settings: 'ËÆæÁΩÆ',
          name: 'ÂßìÂêç', country: 'ÂõΩÂÆ∂', level: 'BeatboxÊ∞¥Âπ≥',
          settingsTitle: 'ËÆæÁΩÆ',
          microphone: 'È∫¶ÂÖãÈ£é',
          micTest: 'È∫¶ÂÖãÈ£éÊµãËØï',
          testMic: 'ÊµãËØï', stopTest: 'ÂÅúÊ≠¢',
          micDetected: 'Â∑≤Ê£ÄÊµãÂà∞È∫¶ÂÖãÈ£é',
          micNotDetected: 'Êú™Ê£ÄÊµãÂà∞È∫¶ÂÖãÈ£é',
          micGood: 'È∫¶ÂÖãÈ£éÂ∑•‰ΩúÊ≠£Â∏∏',
          micLow: 'È∫¶ÂÖãÈ£éÈü≥ÈáèËøá‰Ωé',
          saveSettings: '‰øùÂ≠ò', cancelSettings: 'ÂèñÊ∂à',
          camera: 'ÊëÑÂÉèÂ§¥',
          cameraLoading: 'Ê≠£Âú®Âä†ËΩΩÊëÑÂÉèÂ§¥...',
          cameraNotDetected: 'Êú™Ê£ÄÊµãÂà∞ÊëÑÂÉèÂ§¥',
          speaker: 'Êâ¨Â£∞Âô®',
          speakerLoading: 'Ê≠£Âú®Âä†ËΩΩÊâ¨Â£∞Âô®...',
          speakerNotDetected: 'Êú™Ê£ÄÊµãÂà∞Êâ¨Â£∞Âô®',
          testSpeaker: 'ÊµãËØïÊâ¨Â£∞Âô®',
          language: 'ËØ≠Ë®Ä',
          levelGuide:
`üèÖ ÂàùÂ≠¶ËÄÖ üíß
 ‚îî ‰ªÖÊéåÊè°‰∏âÁßçÂü∫Êú¨Èü≥ / ‰∏çÂà∞1Âπ¥ / Êó†ÊØîËµõÁªèÈ™å / ‰∏ªË¶ÅÊòØËßÇ‰ºó

üèÖ ‰∏≠Á∫ßÈÄâÊâã üå±
 ‚îî Âü∫Êú¨ÂäüÁ®≥ÂÆö+‰∏Ä‰∫õÁâπÊÆäÈü≥ / 1-3Âπ¥ / ÂèÇÂä†ËøáÂú∞ÊñπÊØîËµõ

üèÖ È´òÁ∫ßÈÄâÊâã üî•
 ‚îî ÊéåÊè°Â§öÁßçÈ´òÁ∫ßÊäÄÂ∑ß / 3-5Âπ¥ / ‰∏≠ÂûãÊØîËµõËé∑Â•ñÁªèÂéÜ

üèÖ È°∂Â∞ñÈÄâÊâã üèÜ
 ‚îî ‰∏ì‰∏öÁ∫ßÂà´ / 5Âπ¥‰ª•‰∏ä / ÂõΩÂÜÖÂ§ñÊØîËµõÂÜ†ÂÜõ

‚Äª ‰ª•‰∏ä‰ªÖ‰∏∫ÂèÇËÄÉÊ†áÂáÜ„ÄÇ`,
        },
        ko: {
          toggleOn: 'Ïπ¥Î©îÎùº ÏºúÍ∏∞', toggleOff: 'Ïπ¥Î©îÎùº ÎÅÑÍ∏∞',
          start: 'üöÄ Î∞∞ÌãÄ ÏãúÏûë', cancel: '‚ùå Ï∑®ÏÜå',
          statusConn: 'Ïó∞Í≤∞ Ï§ë...', statusReady: '',
          statusMatch: 'Îß§Ïπ≠ Ï§ë‚Ä¶', statusLeave: 'ÏÉÅÎåÄÎ∞©Ïù¥ ÎÇòÍ∞îÏäµÎãàÎã§.',
          logout: 'Î°úÍ∑∏ÏïÑÏõÉ', edit: 'ÌîÑÎ°úÌïÑ Ìé∏Ïßë', settings: 'ÏÑ§Ï†ï',
          name: 'Ïù¥Î¶Ñ', country: 'Íµ≠Í∞Ä', level: 'ÎπÑÌä∏Î∞ïÏä§ Î†àÎ≤®',
          settingsTitle: 'ÏÑ§Ï†ï',
          microphone: 'ÎßàÏù¥ÌÅ¨',
          micTest: 'ÎßàÏù¥ÌÅ¨ ÌÖåÏä§Ìä∏',
          testMic: 'ÌÖåÏä§Ìä∏', stopTest: 'Ï§ëÏßÄ',
          micDetected: 'ÎßàÏù¥ÌÅ¨Í∞Ä Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§',
          micNotDetected: 'ÎßàÏù¥ÌÅ¨Í∞Ä Í∞êÏßÄÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§',
          micGood: 'ÎßàÏù¥ÌÅ¨Í∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú ÏûëÎèôÌï©ÎãàÎã§',
          micLow: 'ÎßàÏù¥ÌÅ¨ Î≥ºÎ•®Ïù¥ ÎÑàÎ¨¥ ÎÇÆÏäµÎãàÎã§',
          saveSettings: 'Ï†ÄÏû•', cancelSettings: 'Ï∑®ÏÜå',
          camera: 'Ïπ¥Î©îÎùº',
          cameraLoading: 'Ïπ¥Î©îÎùº Î°úÎî© Ï§ë...',
          cameraNotDetected: 'Ïπ¥Î©îÎùºÍ∞Ä Í∞êÏßÄÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§',
          speaker: 'Ïä§ÌîºÏª§',
          speakerLoading: 'Ïä§ÌîºÏª§ Î°úÎî© Ï§ë...',
          speakerNotDetected: 'Ïä§ÌîºÏª§Í∞Ä Í∞êÏßÄÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§',
          testSpeaker: 'Ïä§ÌîºÏª§ ÌÖåÏä§Ìä∏',
          language: 'Ïñ∏Ïñ¥',
          levelGuide:
`üèÖ Ï¥àÎ≥¥Ïûê üíß
 ‚îî Í∏∞Î≥∏ ÏÑ∏ Í∞ÄÏßÄ ÏÜåÎ¶¨Îßå / 1ÎÖÑ ÎØ∏Îßå / Î∞∞ÌãÄ Í≤ΩÌóò ÏóÜÏùå / Ï£ºÎ°ú Í¥ÄÎûåÍ∞ù

üèÖ Ï§ëÍ∏âÏûê üå±
 ‚îî Í∏∞Î≥∏Í∏∞ ÏïàÏ†ï + ÏùºÎ∂Ä ÌäπÏàò ÏÜåÎ¶¨ / 1-3ÎÖÑ / Î°úÏª¨ Î∞∞ÌãÄ Í≤ΩÌóò

üèÖ Í≥†Í∏âÏûê üî•
 ‚îî Ïó¨Îü¨ Í≥†Í∏â Í∏∞Ïà† Î≥¥Ïú† / 3-5ÎÖÑ / Ï§ëÍ∏â ÎåÄÌöå ÏûÖÏÉÅ Í≤ΩÎ†•

üèÖ ÏµúÏÉÅÏúÑ ÌîåÎ†àÏù¥Ïñ¥ üèÜ
 ‚îî ÌîÑÎ°ú ÏàòÏ§Ä / 5ÎÖÑ Ïù¥ÏÉÅ / Íµ≠ÎÇ¥Ïô∏ ÎåÄÌöå ÏÉÅÏúÑÍ∂å

‚Äª ÏúÑÏùò ÎÇ¥Ïö©ÏùÄ Îã®ÏßÄ Í∞ÄÏù¥ÎìúÎùºÏù∏ÏûÖÎãàÎã§.`,
        }
      };

      let locale = localStorage.getItem('locale') || 'en';

      const toggle      = document.getElementById('cameraToggle');
      const toggleLbl   = document.getElementById('toggleLabel');
      const startBtn    = document.getElementById('startBattle');
      const cancelBtn   = document.getElementById('cancelBattle');
      const statusEl    = document.getElementById('status');
      const logoutBtn   = document.getElementById('logoutBtn');
      const editBtn     = document.getElementById('editProfileBtn');
      const settingsBtn = document.getElementById('settingsBtn');
      const editModal   = document.getElementById('editModal');
      const settingsModal = document.getElementById('settingsModal');
      const nameInput   = document.getElementById('editName');
      const countryInput= document.getElementById('editCountry');
      const levelInput  = document.getElementById('editLevel');
      const saveBtn     = document.getElementById('saveProfileBtn');
      const cancelEdit  = document.getElementById('cancelEditBtn');
      const tooltipEl   = document.querySelector('.info-icon .tooltip');
      const loader      = document.getElementById('loader');
      
      // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£
      const micSelect   = document.getElementById('micSelect');
      const micTestBtn  = document.getElementById('micTestBtn');
      const meterBar    = document.querySelector('.meter-bar');
      const micStatus   = document.getElementById('micStatus');
      const saveSettingsBtn = document.getElementById('saveSettingsBtn');
      const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
      
      // Êñ∞„Åó„ÅÑË®≠ÂÆöÈ†ÖÁõÆ„ÅÆDOMË¶ÅÁ¥†ÂèÇÁÖß
      const cameraSelect = document.getElementById('cameraSelect');
      const speakerSelect = document.getElementById('speakerSelect');
      const speakerTestBtn = document.getElementById('speakerTestBtn');
      const settingsLangSelect = document.getElementById('settingsLangSelect');
      
      let audioContext = null;
      let audioStream = null;
      let mediaStreamSource = null;
      let dataArray = null;
      let isTesting = false;
      let animationFrame = null;
      
      // „Éá„Éê„Ç§„Çπ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÈñ¢ÈÄ£
      const micDot = document.getElementById('micDot');
      const speakerDot = document.getElementById('speakerDot');
      const micTooltip = document.getElementById('micTooltip');
      const speakerTooltip = document.getElementById('speakerTooltip');

      function applyText() {
        const t = texts[locale];
        toggleLbl.textContent      = t.toggleOn;
        startBtn.textContent       = t.start;
        cancelBtn.textContent      = t.cancel;
        statusEl.textContent       = t.statusConn;
        logoutBtn.textContent      = 'üö™ ' + t.logout;
        editBtn.textContent        = '‚úèÔ∏è ' + t.edit;
        settingsBtn.textContent    = '‚öô ' + t.settings;
        document.getElementById('nameLbl').textContent    = t.name;
        document.getElementById('countryLbl').textContent = t.country;
        document.getElementById('levelLbl').textContent   = t.level;
        tooltipEl.textContent      = t.levelGuide;
        
        // Ë®≠ÂÆöÈñ¢ÈÄ£„ÅÆ„ÉÜ„Ç≠„Çπ„Éà
        document.getElementById('settingsTitle').textContent = t.settingsTitle;
        document.getElementById('micSelectLbl').textContent = t.microphone;
        document.getElementById('micTestLbl').textContent   = t.micTest;
        micTestBtn.textContent     = t.testMic;
        
        // Êñ∞„Åó„ÅÑË®≠ÂÆöÈ†ÖÁõÆ„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàÊõ¥Êñ∞
        document.getElementById('cameraSelectLbl').textContent = t.camera;
        document.getElementById('speakerSelectLbl').textContent = t.speaker;
        document.getElementById('speakerTestBtn').textContent = t.testSpeaker;
        document.getElementById('langSelectLbl').textContent = t.language;
        
        saveSettingsBtn.textContent = t.saveSettings;
        cancelSettingsBtn.textContent = t.cancelSettings;
        
        document.documentElement.lang = locale;
        settingsLangSelect.value   = locale;
      }
      
      // Ë®ÄË™ûÈÅ∏Êäû„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÅÆÂ§âÊõ¥„Ç§„Éô„É≥„Éà
      settingsLangSelect.addEventListener('change', e => {
        locale = e.target.value;
        localStorage.setItem('locale', locale);
        applyText();
      });
      
      applyText();

      // Camera preview
      async function initPreview() {
        const vid = document.getElementById('previewVideo');
        if (localStorage.getItem('cameraOn') === 'true') {
          try {
            // ÈÅ∏Êäû„Åó„Åü„Ç´„É°„É©„Çí‰ΩøÁî®
            const selectedCameraId = localStorage.getItem('selectedCamera');
            const constraints = {
              video: selectedCameraId 
                ? { deviceId: { exact: selectedCameraId } } 
                : true,
              audio: false
            };
            
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            vid.srcObject = stream;
            toggle.checked = true;
            toggleLbl.textContent = texts[locale].toggleOn;
          } catch {
            toggle.checked = false;
            toggleLbl.textContent = texts[locale].toggleOff;
          }
        } else {
          toggle.checked = false;
          toggleLbl.textContent = texts[locale].toggleOff;
        }
      }
      toggle.addEventListener('change', async e => {
        localStorage.setItem('cameraOn', e.target.checked);
        await initPreview();
      });
      initPreview();

      // Socket logic
      const socket = io();
      socket.on('connect', () => {
        startBtn.disabled = false;
        statusEl.textContent = texts[locale].statusReady;
      });
      startBtn.addEventListener('click', () => {
        startBtn.disabled = true;
        cancelBtn.style.display = 'block';
        loader.style.display = 'flex';
        statusEl.textContent = texts[locale].statusMatch;
        socket.emit('joinBattleQueue');
      });
      cancelBtn.addEventListener('click', () => {
        socket.emit('cancelBattleQueue');
        cancelBtn.style.display = 'none';
        loader.style.display = 'none';
        startBtn.disabled = false;
        statusEl.textContent = texts[locale].statusReady;
      });
      socket.on('matched', ({ roomId }) => {
        loader.style.display = 'none';
        location.href = `/battle.html?room=${encodeURIComponent(roomId)}`;
      });
      socket.on('opponent-left', () => {
        loader.style.display = 'none';
        statusEl.textContent = texts[locale].statusLeave;
        startBtn.disabled = false;
      });

      // Edit Profile modal
      editBtn.addEventListener('click', async () => {
        saveBtn.disabled = true;
        editModal.style.display = 'flex';
        try {
          const res = await fetch('/api/user');
          if (res.ok) {
            const u = await res.json();
            nameInput.value    = u.name;
            countryInput.value = u.country;
            levelInput.value   = u.level;
          }
        } catch {}
        [nameInput, countryInput, levelInput].forEach(el =>
          el.addEventListener('input', () => {
            saveBtn.disabled = !(nameInput.value.trim() && countryInput.value && levelInput.value);
          })
        );
      });
      cancelEdit.addEventListener('click', () => {
        editModal.style.display = 'none';
      });
      saveBtn.addEventListener('click', async () => {
        const body = {
          name:    nameInput.value.trim(),
          country: countryInput.value,
          level:   levelInput.value
        };
        const r = await fetch('/api/user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (r.ok) editModal.style.display = 'none';
      });

      // Logout
      logoutBtn.addEventListener('click', () => {
        location.href = '/logout';
      });

      // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÅÆË°®Á§∫
      settingsBtn.addEventListener('click', async () => {
        settingsModal.style.display = 'flex';
        await loadAvailableMicrophones();
        await loadAvailableCameras();
        await loadAvailableSpeakers();
        
        // Ë®ÄË™ûÈÅ∏Êäû„ÅÆÂàùÊúüÂÄ§Ë®≠ÂÆö
        settingsLangSelect.value = locale;
        
        // „Éá„Éê„Ç§„Çπ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÊõ¥Êñ∞
        updateDeviceIndicators();
      });
      
      // „Çπ„Éî„Éº„Ç´„Éº„ÉÜ„Çπ„Éà„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
      speakerTestBtn.addEventListener('click', () => {
        testSpeaker();
      });
      
      cancelSettingsBtn.addEventListener('click', () => {
        stopMicTest();
        settingsModal.style.display = 'none';
      });
      
      // „Éá„Éê„Ç§„Çπ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
      async function updateDeviceIndicators() {
        try {
          // Âà©Áî®ÂèØËÉΩ„Å™„Éá„Éê„Ç§„Çπ„ÇíÂèñÂæó
          const devices = await navigator.mediaDevices.enumerateDevices();
          
          // „Éû„Ç§„ÇØ„ÅÆÁ¢∫Ë™ç
          const mics = devices.filter(device => device.kind === 'audioinput');
          const selectedMicId = localStorage.getItem('selectedMic');
          
          if (mics.length > 0) {
            micDot.classList.add('active');
            // ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Éû„Ç§„ÇØ„Åå„ÅÇ„Çå„Å∞„Åù„ÅÆÂêçÂâç„Çí„ÄÅ„Å™„Åë„Çå„Å∞ÊúÄÂàù„ÅÆ„Éû„Ç§„ÇØ„ÅÆÂêçÂâç„ÇíË°®Á§∫
            const selectedMic = mics.find(mic => mic.deviceId === selectedMicId) || mics[0];
            micTooltip.textContent = selectedMic.label || 'Default microphone';
          } else {
            micDot.classList.remove('active');
            micTooltip.textContent = texts[locale].micNotDetected || 'No microphone';
          }
          
          // „Çπ„Éî„Éº„Ç´„Éº„ÅÆÁ¢∫Ë™ç
          const speakers = devices.filter(device => device.kind === 'audiooutput');
          const selectedSpeakerId = localStorage.getItem('selectedSpeaker');
          
          if (speakers.length > 0 || 'sinkId' in HTMLMediaElement.prototype) {
            speakerDot.classList.add('active');
            
            // ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Çπ„Éî„Éº„Ç´„Éº„Åå„ÅÇ„Çå„Å∞„Åù„ÅÆÂêçÂâç„ÇíË°®Á§∫
            if (selectedSpeakerId && selectedSpeakerId !== 'default') {
              const selectedSpeaker = speakers.find(speaker => speaker.deviceId === selectedSpeakerId);
              speakerTooltip.textContent = selectedSpeaker ? selectedSpeaker.label : 'Default speaker';
            } else {
              speakerTooltip.textContent = 'Default speaker';
            }
          } else {
            speakerDot.classList.remove('active');
            speakerTooltip.textContent = texts[locale].speakerNotDetected || 'No speaker';
          }
        } catch (err) {
          console.error('„Éá„Éê„Ç§„Çπ„ÅÆÁ¢∫Ë™ç‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:', err);
          // „Ç®„É©„ÉºÊôÇ„ÅØ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„Çí„Ç™„Éï„Å´„Åô„Çã
          micDot.classList.remove('active');
          speakerDot.classList.remove('active');
        }
      }
      
      // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Éá„Éê„Ç§„Çπ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÊõ¥Êñ∞
      updateDeviceIndicators();
      
      // Ë®≠ÂÆö„Åå‰øùÂ≠ò„Åï„Çå„ÅüÊôÇ„ÇÇ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÊõ¥Êñ∞
      saveSettingsBtn.addEventListener('click', () => {
        stopMicTest();
        
        // Ë®≠ÂÆö„ÅÆ‰øùÂ≠òÂá¶ÁêÜ
        const selectedMic = micSelect.value;
        const selectedCamera = cameraSelect.value;
        const selectedSpeaker = speakerSelect.value;
        
        if (selectedMic) {
          localStorage.setItem('selectedMic', selectedMic);
        }
        
        if (selectedCamera) {
          localStorage.setItem('selectedCamera', selectedCamera);
        }
        
        if (selectedSpeaker) {
          localStorage.setItem('selectedSpeaker', selectedSpeaker);
        }
        
        // Ë®ÄË™ûË®≠ÂÆö„ÅÆ‰øùÂ≠ò
        localStorage.setItem('locale', locale);
        
        // „Ç´„É°„É©ON/OFFÁä∂ÊÖã„ÅÆÊõ¥Êñ∞Ôºà„Ç´„É°„É©„ÅÆÈÅ∏Êäû„ÅåÂ§â„Çè„Å£„ÅüÂ†¥Âêà„Å´„ÇÇÂØæÂøúÔºâ
        if (toggle.checked) {
          initPreview();
        }
        
        // „Éá„Éê„Ç§„Çπ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÊõ¥Êñ∞
        updateDeviceIndicators();
        
        settingsModal.style.display = 'none';
      });
      
      // „Éû„Ç§„ÇØ‰∏ÄË¶ß„ÅÆË™≠„ÅøËæº„Åø
      async function loadAvailableMicrophones() {
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const mics = devices.filter(device => device.kind === 'audioinput');
          
          // „Éû„Ç§„ÇØÈÅ∏ÊäûËÇ¢„Çí„ÇØ„É™„Ç¢
          micSelect.innerHTML = '';
          
          if (mics.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = texts[locale].micNotDetected;
            micSelect.appendChild(option);
            micStatus.textContent = '';
            return;
          }
          
          // ÁèæÂú®ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Éû„Ç§„ÇØ
          const selectedMicId = localStorage.getItem('selectedMic') || '';
          
          mics.forEach(mic => {
            const option = document.createElement('option');
            option.value = mic.deviceId;
            option.textContent = mic.label || `Microphone ${micSelect.options.length + 1}`;
            option.selected = mic.deviceId === selectedMicId;
            micSelect.appendChild(option);
          });
          
          micStatus.textContent = '';
          
          // „Éá„Éê„Ç§„Çπ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÊõ¥Êñ∞
          updateDeviceIndicators();
        } catch (err) {
          console.error('„Éû„Ç§„ÇØ‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', err);
          micSelect.innerHTML = `<option value="">${texts[locale].micNotDetected}</option>`;
          micStatus.textContent = '';
        }
      }
      
      // „Éû„Ç§„ÇØ„ÉÜ„Çπ„Éà
      micTestBtn.addEventListener('click', () => {
        if (isTesting) {
          stopMicTest();
        } else {
          startMicTest();
        }
      });
      
      async function startMicTest() {
        try {
          // „Ç™„Éº„Éá„Ç£„Ç™„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÂàùÊúüÂåñ
          if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }
          
          // ÈÅ∏Êäû„Åó„Åü„Éû„Ç§„ÇØ„Çí‰ΩøÁî®
          const constraints = {
            audio: {
              deviceId: micSelect.value ? { exact: micSelect.value } : undefined
            }
          };
          
          audioStream = await navigator.mediaDevices.getUserMedia(constraints);
          
          // „Ç™„Éº„Éá„Ç£„Ç™ÂàÜÊûê„ÅÆË®≠ÂÆö
          mediaStreamSource = audioContext.createMediaStreamSource(audioStream);
          audioAnalyser = audioContext.createAnalyser();
          audioAnalyser.fftSize = 256;
          
          mediaStreamSource.connect(audioAnalyser);
          
          dataArray = new Uint8Array(audioAnalyser.frequencyBinCount);
          
          // UIÊõ¥Êñ∞
          isTesting = true;
          micTestBtn.textContent = texts[locale].stopTest;
          micTestBtn.classList.add('testing');
          
          // Èü≥Èáè„É°„Éº„Çø„ÉºÊõ¥Êñ∞„É´„Éº„Éó„ÇíÈñãÂßã
          updateMeter();
          
        } catch (err) {
          console.error('„Éû„Ç§„ÇØ„ÉÜ„Çπ„Éà„ÅÆÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', err);
          micStatus.textContent = '';
        }
      }
      
      function stopMicTest() {
        if (!isTesting) return;
        
        // Èü≥Èáè„É°„Éº„Çø„ÉºÊõ¥Êñ∞„É´„Éº„Éó„ÇíÂÅúÊ≠¢
        if (animationFrame) {
          cancelAnimationFrame(animationFrame);
          animationFrame = null;
        }
        
        // „Éû„Ç§„ÇØ„Çπ„Éà„É™„Éº„É†„ÇíÂÅúÊ≠¢
        if (audioStream) {
          audioStream.getTracks().forEach(track => track.stop());
          audioStream = null;
        }
        
        // UIÊõ¥Êñ∞
        isTesting = false;
        micTestBtn.textContent = texts[locale].testMic;
        micTestBtn.classList.remove('testing');
        meterBar.style.width = '0%';
        micStatus.textContent = '';
      }
      
      function updateMeter() {
        if (!audioAnalyser || !isTesting) return;
        
        audioAnalyser.getByteFrequencyData(dataArray);
        
        // Èü≥Èáè„É¨„Éô„É´„ÅÆË®àÁÆó (Âπ≥ÂùáÂÄ§)
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
          sum += dataArray[i];
        }
        const average = sum / dataArray.length;
        
        // 0-255 „ÅÆÂÄ§„Çí 0-100% „Å´Â§âÊèõ
        const volume = Math.min(100, Math.max(0, average / 2.55));
        
        // „É°„Éº„Çø„Éº„Éê„Éº„ÅÆÊõ¥Êñ∞
        meterBar.style.width = `${volume}%`;
        
        // Èü≥Èáè„Å´Âøú„Åò„Åü„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅØË°®Á§∫„Åó„Å™„ÅÑ
        micStatus.textContent = '';
        
        // Ê¨°„ÅÆ„Éï„É¨„Éº„É†„ÅßÂÜçÂ∫¶Êõ¥Êñ∞
        animationFrame = requestAnimationFrame(updateMeter);
      }

      // „Ç´„É°„É©‰∏ÄË¶ß„ÅÆË™≠„ÅøËæº„Åø
      async function loadAvailableCameras() {
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const cameras = devices.filter(device => device.kind === 'videoinput');
          
          // „Ç´„É°„É©ÈÅ∏ÊäûËÇ¢„Çí„ÇØ„É™„Ç¢
          cameraSelect.innerHTML = '';
          
          if (cameras.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = texts[locale].cameraNotDetected;
            cameraSelect.appendChild(option);
            return;
          }
          
          // ÁèæÂú®ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Ç´„É°„É©
          const selectedCameraId = localStorage.getItem('selectedCamera') || '';
          
          cameras.forEach(camera => {
            const option = document.createElement('option');
            option.value = camera.deviceId;
            option.textContent = camera.label || `Camera ${cameraSelect.options.length + 1}`;
            option.selected = camera.deviceId === selectedCameraId;
            cameraSelect.appendChild(option);
          });
          
        } catch (err) {
          console.error('„Ç´„É°„É©‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', err);
          cameraSelect.innerHTML = `<option value="">${texts[locale].cameraNotDetected}</option>`;
        }
      }
      
      // „Çπ„Éî„Éº„Ç´„Éº‰∏ÄË¶ß„ÅÆË™≠„ÅøËæº„Åø
      async function loadAvailableSpeakers() {
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const speakers = devices.filter(device => device.kind === 'audiooutput');
          
          // „Çπ„Éî„Éº„Ç´„ÉºÈÅ∏ÊäûËÇ¢„Çí„ÇØ„É™„Ç¢
          speakerSelect.innerHTML = '';
          
          if (speakers.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = texts[locale].speakerNotDetected;
            speakerSelect.appendChild(option);
            return;
          }
          
          // ÁèæÂú®ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Çπ„Éî„Éº„Ç´„Éº
          const selectedSpeakerId = localStorage.getItem('selectedSpeaker') || '';
          
          // „Éá„Éï„Ç©„É´„Éà„Éá„Éê„Ç§„Çπ„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥
          const defaultOption = document.createElement('option');
          defaultOption.value = 'default';
          defaultOption.textContent = 'Default Speaker';
          defaultOption.selected = selectedSpeakerId === 'default' || !selectedSpeakerId;
          speakerSelect.appendChild(defaultOption);
          
          speakers.forEach(speaker => {
            const option = document.createElement('option');
            option.value = speaker.deviceId;
            option.textContent = speaker.label || `Speaker ${speakerSelect.options.length}`;
            option.selected = speaker.deviceId === selectedSpeakerId;
            speakerSelect.appendChild(option);
          });
          
          // „Éá„Éê„Ç§„Çπ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÊõ¥Êñ∞
          updateDeviceIndicators();
        } catch (err) {
          console.error('„Çπ„Éî„Éº„Ç´„Éº‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', err);
          speakerSelect.innerHTML = `<option value="">${texts[locale].speakerNotDetected}</option>`;
        }
      }
      
      // „Çπ„Éî„Éº„Ç´„Éº„ÉÜ„Çπ„Éà
      async function testSpeaker() {
        const selectedSpeaker = speakerSelect.value;
        
        // Êñ∞„Åó„ÅÑWebAudio API„Çí‰ΩøÁî®„Åó„Åü„ÉÜ„Çπ„ÉàÈü≥Â£∞
        try {
          // „Éú„Çø„É≥„Çí‰∏ÄÊôÇÁöÑ„Å´ÁÑ°ÂäπÂåñ
          speakerTestBtn.disabled = true;
          
          // Èü≥Â£∞„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
          let audioContext;
          if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }
          
          // Èü≥Â£∞„ÅÆÂá∫ÂäõÂÖà„ÇíË®≠ÂÆö
          let destination = audioContext.destination;
          
          // AudioContext„ÅÆdestination„ÇíÁâπÂÆö„ÅÆ„Éá„Éê„Ç§„Çπ„Å´Ë®≠ÂÆöÔºàÂèØËÉΩ„Å™Â†¥ÂêàÔºâ
          if (selectedSpeaker && audioContext.setSinkId) {
            try {
              await audioContext.setSinkId(selectedSpeaker);
            } catch (err) {
              console.warn('setSinkId„ÅØ„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì:', err);
            }
          }
          
          // „Ç™„Ç∑„É¨„Éº„Çø„Éº„Çí‰ΩúÊàêÔºàÈü≥„ÇíÁîüÊàêÔºâ
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          // „Çµ„Ç§„É≥Ê≥¢„Åß440HzÔºàAÈü≥Ôºâ„ÇíË®≠ÂÆö
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
          
          // Èü≥Èáè„ÇíË™øÊï¥
          gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
          
          // „Éé„Éº„Éâ„ÇíÊé•Á∂ö
          oscillator.connect(gainNode);
          gainNode.connect(destination);
          
          // Èü≥„ÇíÂÜçÁîüÔºà0.5ÁßíÈñìÔºâ
          oscillator.start();
          oscillator.stop(audioContext.currentTime + 0.5);
          
          // ÂÜçÁîüÂÆå‰∫ÜÊôÇ„Å´„Éú„Çø„É≥„ÇíÂÜçÊúâÂäπÂåñ
          setTimeout(() => {
            speakerTestBtn.disabled = false;
          }, 600);
          
          // „ÇÇ„ÅóOscillator„Åå‰Ωø„Åà„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
          oscillator.onended = () => {
            speakerTestBtn.disabled = false;
          };
        } catch (err) {
          console.error('WebAudio API„Å´„Çà„Çã„ÉÜ„Çπ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇAudioË¶ÅÁ¥†„Åß„ÅÆ„ÉÜ„Çπ„Éà„ÇíË©¶„Åø„Åæ„Åô:', err);
          
          // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÂæìÊù•„ÅÆAudioË¶ÅÁ¥†„Çí‰Ωø„ÅÜÊñπÊ≥ï
          try {
            const audio = new Audio();
            
            // „Éì„Éº„ÉóÈü≥„ÅÆBase64„Ç®„É≥„Ç≥„Éº„Éâ„Åï„Çå„Åü„Éá„Éº„Çø
            audio.src = 'data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAA1N3aXRjaCBQbHVzIMKpIE5DSCBTb2Z0d2FyZQBUSVQyAAAABgAAAzIyMzUAVFNTRQAAAA8AAANMYXZmNTcuODMuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAATEFNRTMuMTAwVVVVVVVVVVVVVUxBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQsRbAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQMSkAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV';
            
            // ÈÅ∏Êäû„Åó„Åü„Çπ„Éî„Éº„Ç´„Éº„ÅßÂÜçÁîüÔºàÂèØËÉΩ„Å™Â†¥ÂêàÔºâ
            if (selectedSpeaker && audio.setSinkId) {
              try {
                await audio.setSinkId(selectedSpeaker);
              } catch (err) {
                console.warn('setSinkId„ÅØ„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì:', err);
              }
            }
            
            // ÂÜçÁîü
            audio.play();
            
            // ÂÜçÁîüÂÆå‰∫ÜÊôÇ„Å´„Éú„Çø„É≥„ÇíÂÜçÊúâÂäπÂåñ
            audio.onended = () => {
              speakerTestBtn.disabled = false;
            };
            
            // 3ÁßíÂæå„Å´Âº∑Âà∂ÁöÑ„Å´„Éú„Çø„É≥„ÇíÂÜçÊúâÂäπÂåñÔºà„Ç™„Éº„Éá„Ç£„Ç™„ÅåÁµÇ‰∫Ü„Åó„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÅÆ‰øùÈô∫Ôºâ
            setTimeout(() => {
              speakerTestBtn.disabled = false;
            }, 3000);
          } catch (audioErr) {
            console.error('AudioË¶ÅÁ¥†„Åß„ÅÆ„ÉÜ„Çπ„Éà„Å´„ÇÇÂ§±Êïó„Åó„Åæ„Åó„Åü:', audioErr);
            speakerTestBtn.disabled = false;
          }
        }
      }
    });
  </script>
</body>
</html>
