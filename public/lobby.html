<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BeatNexus â€“ Lobby</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <style>
    body {
      margin: 0;
      color: var(--text-1);
      font-family: 'Inter', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #0E0E0E;
      overflow-x: hidden;
    }
    
    /* â”€â”€â”€â”€â”€ èƒŒæ™¯ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ã‚¯ â”€â”€â”€â”€â”€ */
    .watermark {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-15deg);
      font-family: 'Russo One', 'Arial Black', sans-serif;
      font-size: 22vw;
      line-height: 1;
      color: #08F;
      opacity: .05;
      pointer-events: none;
      user-select: none;
      white-space: nowrap;
      z-index: -3;
    }
    
    /* â”€â”€â”€â”€â”€ èƒŒæ™¯ã¼ã‹ã—å‹•ç”» â”€â”€â”€â”€â”€ */
    .wave-bg {
      position: fixed;
      inset: 0;
      z-index: -2;
      overflow: hidden;
    }
    .wave-bg::before {
      content: "";
      position: absolute;
      inset: -50%;
      background: url('js/sample-battle.mp4') center/cover no-repeat;
      filter: blur(60px) opacity(.35);
      animation: spin 22s linear infinite;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    .container {
      position: relative;
      width: 90vw;
      max-width: 450px;
      background: rgba(255,255,255,0.09);
      background: linear-gradient(135deg, 
                  rgba(255,255,255,0.15) 0%, 
                  rgba(255,255,255,0.08) 40%, 
                  rgba(255,255,255,0.06) 100%);
      backdrop-filter: blur(16px);
      border-radius: var(--radius);
      padding: 1.2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35),
                  inset 0 1px 1px rgba(255,255,255,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.6rem;
      border: 1px solid rgba(255,255,255,0.18);
      border-top: 1px solid rgba(255,255,255,0.35);
      border-bottom: 1px solid rgba(0,0,0,0.1);
      z-index: 1;
      transition: transform 0.3s, box-shadow 0.3s;
      overflow: hidden;
    }
    
    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 130%;
      height: 150%;
      background: linear-gradient(135deg, rgba(255,255,255,0.18) 0%, transparent 100%);
      transform: translateX(-30%) translateY(-50%) rotate(-15deg);
      pointer-events: none;
    }
    
    .container:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.45),
                  inset 0 1px 1px rgba(255,255,255,0.4);
    }
    
    /* ã“ã“ã‹ã‚‰æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    #userActions {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.3rem;
    }
    
    /* ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ãƒœã‚¿ãƒ³ï¼ˆEdit Profile, Settingsï¼‰ */
    #editProfileBtn, #settingsBtn {
      width: 100% !important;
      padding: .8rem !important;
      font-size: 1rem !important;
      font-weight: 600 !important;
      border: none !important;
      border-radius: var(--radius) !important;
      cursor: pointer !important;
      background: #2a2a2a !important;
      color: #fff !important;
      box-shadow: 0 0 4px rgba(85, 221, 224, 0.2), 0 4px 8px rgba(0,0,0,0.2) !important;
      border: 1px solid rgba(85, 221, 224, 0.15) !important;
      transition: transform .2s, background-color .2s, box-shadow .2s !important;
    }
    
    #editProfileBtn:hover, #settingsBtn:hover {
      transform: translateY(-2px) !important;
      background: #323232 !important;
      box-shadow: 0 0 8px rgba(85, 221, 224, 0.3), 0 6px 12px rgba(0,0,0,0.3) !important;
      border-color: rgba(85, 221, 224, 0.25) !important;
    }
    
    /* Logout ãƒœã‚¿ãƒ³ï¼ˆå±é™ºãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ */
    #logoutBtn {
      width: 100% !important;
      padding: .8rem !important;
      font-size: 1rem !important;
      font-weight: 600 !important;
      border: none !important;
      border-radius: var(--radius) !important;
      cursor: pointer !important;
      background: rgba(220, 53, 53, 0.15) !important;
      color: #fff !important;
      border: 1px solid rgba(220, 53, 53, 0.3) !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 0.5rem !important;
      transition: transform .2s, background-color .2s, box-shadow .2s !important;
    }
    
    #logoutBtn:hover {
      transform: translateY(-2px) !important;
      background: rgba(220, 53, 53, 0.25) !important;
      box-shadow: 0 0 8px rgba(220, 53, 53, 0.3), 0 6px 12px rgba(0,0,0,0.3) !important;
    }
    /* ã“ã“ã¾ã§æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    
    h1 {
      font-family: 'Russo One', sans-serif;
      font-size: 1.6rem;
      margin: 0;
      color: var(--accent);
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    #previewWrap {
      width: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      align-items: center;
      margin-bottom: 0.2rem;
    }
    #previewVideo {
      width: 100%;
      max-width: 320px;
      aspect-ratio: 16/9;
      border-radius: var(--radius);
      background: #000;
      object-fit: cover;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
      border: 2px solid rgba(255,255,255,0.1);
    }
    
    /* ãƒ‡ãƒã‚¤ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ */
    #deviceStatus {
      display: flex;
      gap: 0.6rem;
      margin-top: 0.5rem;
      justify-content: center;
    }
    .device-indicator {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      background: rgba(0,0,0,0.3);
      padding: 0.4rem 0.6rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      position: relative;
      cursor: help;
    }
    .indicator-dot {
      width: 0.8rem;
      height: 0.8rem;
      border-radius: 50%;
      background: #DC3535;
      transition: background-color 0.3s ease;
    }
    .indicator-dot.active {
      background: #4CD964;
    }
    .device-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(0.5rem);
      background: rgba(30, 30, 30, 0.9);
      color: #fff;
      padding: 0.5rem 0.8rem;
      border-radius: var(--radius);
      font-size: 0.75rem;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      pointer-events: none;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .device-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(30, 30, 30, 0.9);
    }
    .device-indicator:hover .device-tooltip {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }
    
    /* ã‚«ãƒ¡ãƒ©ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å³ä¸Šã«é…ç½® */
    #cameraToggleWrap {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(0,0,0,0.6);
      border-radius: 30px;
      padding: 5px 10px;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆï¼ˆiPadï¼‰è¡¨ç¤ºç”¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
    @media (min-width: 768px) and (max-width: 1024px) {
      #previewWrap {
        align-items: center;
      }
      #previewVideo {
        width: 100%;
        max-width: 600px;
        aspect-ratio: 16/9;
        height: auto;
      }
      /* ã‚«ãƒ¡ãƒ©ãƒˆã‚°ãƒ«ã‚’å‹•ç”»ã®ä¸‹ã«é…ç½® */
      #cameraToggleWrap {
        position: static;
        margin-top: 12px;
        justify-content: center;
        width: auto;
      }
      /* ãƒ‡ãƒã‚¤ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ä½ç½®ã‚‚èª¿æ•´ */
      #deviceStatus {
        margin-top: 12px;
      }
    }
    
    #toggleLabel {
      font-weight: 600;
      font-size: 0.8rem;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }
    .switch { --circle-dim:1.2em; position: relative; display: inline-block; width: 3em; height: 1.5em; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      inset: 0;
      background: rgba(220, 53, 53, 0.3);
      border-radius: 30px;
      transition: .3s;
      backdrop-filter: blur(4px);
    }
    .slider-card {
      position: absolute;
      bottom: .15em;
      left: .15em;
      width: var(--circle-dim);
      height: var(--circle-dim);
      background: #DC3535;
      border-radius: 50%;
      transition: .3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .switch input:checked ~ .slider-card { transform: translateX(1.5em); background: #4CD964; }
    .switch input:checked ~ .slider { background: rgba(76, 217, 100, 0.3); }
    #controls {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: .5rem;
    }
    #controls button {
      width: 100%;
      padding: .7rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      background: var(--accent);
      color: #000;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform .2s, background-color .2s;
    }
    #controls button:disabled {
      opacity: .6;
      cursor: not-allowed;
      background-color: #505050;
      color: #aaaaaa;
      box-shadow: none;
    }
    #controls button:not(:disabled):hover {
      transform: translateY(-2px);
      background-color: var(--accent-dark);
    }
    #cancelBattle { 
      background: rgba(220, 53, 53, 0.8) !important;
      color: white !important;
    }
    
    #cancelBattle:hover {
      background: rgba(220, 53, 53, 1) !important;
      transform: translateY(-2px);
    }

    .earth-loader {
      --watercolor: #4aa4e0;
      --landcolor: #6dbf4b;
      display: none;
      width: 2.5rem;
      height: 2.5rem;
      background-color: var(--watercolor);
      position: relative;
      overflow: hidden;
      border-radius: 50%;
      border: .15em solid white;
      box-shadow: inset 0 .4em rgba(255,255,255,0.25), inset 0 -.4em rgba(0,0,0,0.25);
      align-items: center;
      justify-content: center;
      margin: 0.2rem 0;
    }
    .earth-loader svg { position: absolute; width: 2rem; height: auto; }
    .earth-loader svg:nth-child(1) { bottom: -0.8rem; animation: round1 5s infinite linear .6s; }
    .earth-loader svg:nth-child(2) { top: -1.2rem; animation: round1 5s infinite linear; }
    .earth-loader svg:nth-child(3) { top: -1rem; animation: round2 5s infinite linear; }
    .earth-loader svg:nth-child(4) { bottom: -0.9rem; animation: round2 5s infinite linear .6s; }
    @keyframes round1 { 0%{left:-.8rem;}30%{left:-2rem;opacity:1;}31%{opacity:0;}35%{left:3rem;}45%{opacity:1;}100%{left:-.8rem;} }
    @keyframes round2 { 0%{left:1rem;}75%{left:-3rem;opacity:1;}76%{opacity:0;}80%{opacity:1;}100%{left:1rem;} }

    .status {
      font-size: .8rem;
      color: var(--text-2);
      text-align: center;
      height: 1rem;
      margin: 0.2rem 0;
    }
    
    /* ä»¥å‰ã®è¨­å®šï¼ˆä¸‹ç·šä»˜ãï¼‰ã‚’å‰Šé™¤ */
    #editProfileBtn {
      background: transparent;
      border: none;
      color: var(--accent);
      cursor: pointer;
      transition: color 0.2s, transform 0.2s;
      text-decoration: none;
    }
    
    #editProfileBtn:hover {
      color: var(--accent);
      transform: translateY(-1px);
    }
    
    #logoutBtn, #editProfileBtn {
      background: transparent;
      border: none;
      color: var(--text-2);
      text-decoration: none;
      cursor: pointer;
      padding: 0.5rem 1rem;
      transition: color 0.2s, transform 0.2s;
    }
    #logoutBtn:hover, #editProfileBtn:hover {
      color: var(--text-1);
      transform: translateY(-1px);
    }
    #editProfileBtn {
      color: var(--accent);
      margin-top: 0.5rem;
      text-decoration: none;
      border: 1px solid var(--accent);
      border-radius: var(--radius);
    }
    #editProfileBtn:hover {
      background-color: rgba(85, 221, 224, 0.1);
    }

    /* Modal */
    #editModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #editModal .card {
      background: rgba(255,255,255,0.09);
      background: linear-gradient(135deg, 
                  rgba(255,255,255,0.15) 0%, 
                  rgba(255,255,255,0.08) 40%, 
                  rgba(255,255,255,0.06) 100%);
      backdrop-filter: blur(16px);
      padding: 2rem;
      border-radius: var(--radius);
      width: 90vw;
      max-width: 480px;
      color: var(--text-1);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      border: 1px solid rgba(255,255,255,0.18);
      border-top: 1px solid rgba(255,255,255,0.35);
      border-bottom: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35),
                  inset 0 1px 1px rgba(255,255,255,0.3);
      position: relative;
      overflow: hidden;
    }
    
    #editModal .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 130%;
      height: 200%;
      background: linear-gradient(135deg, rgba(255,255,255,0.18) 0%, transparent 100%);
      transform: translateX(-30%) translateY(-60%) rotate(-15deg);
      pointer-events: none;
    }
    
    #editModal h2 {
      margin-top: 0;
      font-family: 'Russo One', sans-serif;
      color: var(--accent);
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      text-align: center;
    }
    #editModal label {
      font-weight: 600;
      margin-bottom: .3rem;
      font-size: .95rem;
    }
    #editModal input,
    #editModal select {
      width: 100%;
      padding: .75rem 1rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius);
      background: rgba(0,0,0,0.2);
      color: var(--text-1);
      font-size: 1rem;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }
    #editModal input:focus,
    #editModal select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(85, 221, 224, 0.3);
    }
    #saveProfileBtn,
    #cancelEditBtn {
      width: 100%;
      padding: .8rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: transform .2s, background-color .2s;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    #saveProfileBtn {
      background: var(--accent);
      color: #000;
    }
    #saveProfileBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      background: var(--accent-dark);
    }
    #saveProfileBtn:disabled {
      opacity: .5;
      cursor: not-allowed;
    }
    #cancelEditBtn {
      background: var(--bg-2);
      color: var(--text-1);
      border: 1px solid rgba(255,255,255,0.1);
    }
    #cancelEditBtn:hover {
      transform: translateY(-2px);
      background: rgba(255,255,255,0.1);
    }
    
    .level-selection {
      display: flex;
      align-items: center;
    }

    /* Tooltip for level guidance */
    .info-icon {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: 0.5rem;
      cursor: pointer;
      width: 1.6rem;
      height: 1.6rem;
      background: var(--accent);
      color: #000;
      border-radius: 50%;
      font-size: 1rem;
    }
    .info-icon .tooltip {
      position: absolute;
      left: calc(100% + 0.5rem);
      top: 50%;
      transform: translateY(-50%) translateX(-0.5rem);
      background: var(--bg-2);
      color: var(--text-1);
      padding: 0.8rem;
      border-radius: var(--radius);
      white-space: pre-wrap;
      font-size: 0.85rem;
      line-height: 1.4;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 100;
      pointer-events: none;
      min-width: 240px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .info-icon .tooltip::before {
      content: '';
      position: absolute;
      left: -0.5rem;
      top: 50%;
      transform: translateY(-50%);
      border: 0.5rem solid transparent;
      border-right-color: var(--bg-2);
    }
    .info-icon:hover .tooltip {
      opacity: 1;
      visibility: visible;
      transform: translateY(-50%) translateX(0);
    }

    /* Mobile styles */
    @media (max-width: 767px) {
      .container {
        padding: 1rem;
        width: 95%;
        gap: 0.5rem;
      }
      
      h1 {
        font-size: 1.4rem;
        margin-bottom: 0.3rem;
      }
      
      #previewVideo {
        max-width: 100%;
      }
      
      #controls button {
        padding: 0.6rem;
      }
      
      #controls {
        gap: 0.4rem;
      }
      
      .status {
        margin: 0;
      }
      
      #userActions {
        gap: 0.4rem;
      }
      
      #userActions button {
        padding: 0.6rem;
      }
      
      .info-icon .tooltip {
        left: 50%;
        top: 100%;
        transform: translateX(-50%) translateY(-0.5rem);
        width: 90vw;
        max-width: 300px;
      }
      
      .info-icon .tooltip::before {
        left: 50%;
        top: -0.5rem;
        transform: translateX(-50%);
        border-color: transparent;
        border-bottom-color: var(--bg-2);
      }
      
      .info-icon:hover .tooltip {
        transform: translateX(-50%) translateY(0);
      }
      
      #editModal .card {
        padding: 1.5rem;
      }
    }

    /* PCç”¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    @media (min-width: 992px) {
      .container {
        max-width: 80%;
        width: 900px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
          "header header"
          "video controls"
          "buttons buttons";
        column-gap: 1.5rem;
        row-gap: 0.8rem;
        padding: 1.5rem;
      }
      
      h1 {
        grid-area: header;
        text-align: center;
        margin-bottom: 1rem;
      }
      
      #previewWrap {
        grid-area: video;
        width: 100%;
      }
      
      #controls {
        grid-area: controls;
        align-self: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: .5rem;
      }
      
      #cameraToggleWrap {
        align-self: flex-start;
        margin-bottom: 1rem;
      }
      
      /* PCãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
      #userActions {
        grid-area: buttons;
        flex-direction: row;
        justify-content: center;
        gap: 0.8rem;
        margin-top: 0.8rem;
      }
      
      #userActions button {
        width: auto !important;
        min-width: 150px !important;
      }
      
      #previewVideo {
        width: 100%;
        max-width: none;
      }
    }

    #userActions {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }
    
    #userActions button {
      width: 100%;
      padding: .8rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      background: var(--bg-2);
      color: var(--text-1);
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform .2s, background-color .2s;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    #userActions button:hover {
      transform: translateY(-2px);
      background: rgba(255,255,255,0.1);
    }

    /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
    #settingsModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #settingsModal .card {
      background: rgba(255,255,255,0.09);
      background: linear-gradient(135deg, 
                  rgba(255,255,255,0.15) 0%, 
                  rgba(255,255,255,0.08) 40%, 
                  rgba(255,255,255,0.06) 100%);
      backdrop-filter: blur(16px);
      padding: 2rem;
      border-radius: var(--radius);
      width: 90vw;
      max-width: 480px;
      color: var(--text-1);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      border: 1px solid rgba(255,255,255,0.18);
      border-top: 1px solid rgba(255,255,255,0.35);
      border-bottom: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35),
                  inset 0 1px 1px rgba(255,255,255,0.3);
      position: relative;
      overflow: hidden;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    #settingsModal .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 130%;
      height: 200%;
      background: linear-gradient(135deg, rgba(255,255,255,0.18) 0%, transparent 100%);
      transform: translateX(-30%) translateY(-60%) rotate(-15deg);
      pointer-events: none;
    }
    
    #settingsModal h2 {
      margin-top: 0;
      font-family: 'Russo One', sans-serif;
      color: var(--accent);
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      text-align: center;
    }
    #settingsModal label {
      font-weight: 600;
      margin-bottom: .3rem;
      font-size: .95rem;
    }
    #settingsModal select {
      width: 100%;
      padding: .75rem 1rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius);
      background: rgba(0,0,0,0.2);
      color: var(--text-1);
      font-size: 1rem;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }
    #settingsModal select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(85, 221, 224, 0.3);
    }
    
    /* ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆé–¢é€£ */
    #micTestContainer {
      margin-bottom: 1.5rem;
    }
    .mic-test-display {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    .volume-meter {
      flex: 1;
      height: 24px;
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.05);
    }
    .meter-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, #4CD964, #55dde0);
      border-radius: 12px;
      transition: width 0.05s ease;
    }
    #micTestBtn {
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    #micTestBtn:hover {
      background: var(--accent-dark);
      transform: translateY(-2px);
    }
    #micTestBtn.testing {
      background: #DC3535;
    }
    .mic-status {
      font-size: 0.9rem;
      color: var(--text-2);
      margin-top: 0.5rem;
      text-align: center;
      min-height: 1.2rem;
    }
    
    /* ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–¢é€£ï¼ˆæ–°è¦è¿½åŠ ï¼‰ */
    #cameraPreviewContainer {
      width: 100%;
      margin: 0.5rem 0 1.5rem;
      border-radius: var(--radius);
      overflow: hidden;
      position: relative;
    }
    
    #settingsCameraPreview {
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      object-fit: cover;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒ†ã‚¹ãƒˆé–¢é€£ï¼ˆæ–°è¦è¿½åŠ ï¼‰ */
    #speakerTestContainer {
      margin: 0.5rem 0 1.5rem;
    }
    
    #speakerTestBtn {
      width: 100%;
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    #speakerTestBtn:hover {
      background: var(--accent-dark);
      transform: translateY(-2px);
    }
    
    #speakerTestBtn:active {
      transform: scale(0.95);
    }
    
    /* è¨€èªé¸æŠé–¢é€£ï¼ˆæ–°è¦è¿½åŠ ï¼‰ */
    #settingsLangSelect {
      margin-bottom: 1.5rem;
    }
    
    #saveSettingsBtn,
    #cancelSettingsBtn {
      width: 100%;
      padding: .8rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: transform .2s, background-color .2s;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    #saveSettingsBtn {
      background: var(--accent);
      color: #000;
    }
    #saveSettingsBtn:hover {
      transform: translateY(-2px);
      background: var(--accent-dark);
    }
    #cancelSettingsBtn {
      background: var(--bg-2);
      color: var(--text-1);
      border: 1px solid rgba(255,255,255,0.1);
    }
    #cancelSettingsBtn:hover {
      transform: translateY(-2px);
      background: rgba(255,255,255,0.1);
    }

    /* ã‚¹ãƒãƒ›å‘ã‘ã«å°‘ã—èª¿æ•´ */
    @media (max-width: 767px) {
      #settingsModal .card {
        max-height: 85vh;
        padding-right: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ã‚¯ -->
  <div class="watermark">BeatNexus</div>

  <!-- èƒŒæ™¯ã¼ã‹ã— -->
  <div class="wave-bg"></div>

  <div class="container">
    <h1>ğŸ¤ BeatNexus</h1>

    <div id="previewWrap">
      <video id="previewVideo" autoplay muted playsinline></video>
      <div id="cameraToggleWrap">
        <label class="switch">
          <input type="checkbox" id="cameraToggle">
          <span class="slider"></span>
          <span class="slider-card"></span>
        </label>
        <span id="toggleLabel">Camera On</span>
      </div>
      <div id="deviceStatus">
        <div class="device-indicator" id="micIndicator">
          <span class="indicator-dot" id="micDot"></span>
          <span>ğŸ¤</span>
          <div class="device-tooltip" id="micTooltip">No microphone</div>
        </div>
        <div class="device-indicator" id="speakerIndicator">
          <span class="indicator-dot" id="speakerDot"></span>
          <span>ğŸ”Š</span>
          <div class="device-tooltip" id="speakerTooltip">No speaker</div>
        </div>
      </div>
    </div>

    <div id="controls">
      <div class="earth-loader" id="loader">
        <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="var(--landcolor)"/></svg>
        <svg viewBox="0 0 100 100"><circle cx="30" cy="30" r="15" fill="var(--watercolor)"/></svg>
        <svg viewBox="0 0 100 100"><circle cx="70" cy="70" r="20" fill="var(--landcolor)"/></svg>
        <svg viewBox="0 0 100 100"><circle cx="50" cy="20" r="10" fill="var(--watercolor)"/></svg>
      </div>
      <p id="status" class="status">Connecting to serverâ€¦</p>
      <button id="startBattle" disabled>ğŸš€ Start Battle</button>
      <button id="cancelBattle" style="display:none">âŒ Cancel</button>
    </div>

    <div id="userActions">
      <button id="editProfileBtn">âœï¸ Edit Profile</button>
      <button id="settingsBtn">âš™ Settings</button>
      <button id="logoutBtn">ğŸšª Logout</button>
    </div>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="settingsModal">
    <div class="card">
      <h2 id="settingsTitle">Settings</h2>

      <!-- ãƒã‚¤ã‚¯è¨­å®š -->
      <label id="micSelectLbl">Microphone</label>
      <select id="micSelect">
        <option value="">Loading microphones...</option>
      </select>

      <div id="micTestContainer">
        <label id="micTestLbl">Microphone Test</label>
        <div class="mic-test-display">
          <div class="volume-meter">
            <div class="meter-bar"></div>
          </div>
          <button id="micTestBtn">Test</button>
        </div>
        <div class="mic-status" id="micStatus"></div>
      </div>

      <!-- ã‚«ãƒ¡ãƒ©è¨­å®šï¼ˆæ–°è¦è¿½åŠ ï¼‰ -->
      <label id="cameraSelectLbl">Camera</label>
      <select id="cameraSelect">
        <option value="">Loading cameras...</option>
      </select>

      <!-- å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹è¨­å®šï¼ˆæ–°è¦è¿½åŠ ï¼‰ -->
      <label id="speakerSelectLbl">Speaker</label>
      <select id="speakerSelect">
        <option value="">Loading speakers...</option>
      </select>

      <div id="speakerTestContainer">
        <button id="speakerTestBtn">Test Speaker</button>
      </div>

      <!-- è¨€èªè¨­å®šï¼ˆæ–°è¦è¿½åŠ ï¼‰ -->
      <label id="langSelectLbl">Language</label>
      <select id="settingsLangSelect">
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="es">EspaÃ±ol</option>
        <option value="fr">FranÃ§ais</option>
        <option value="zh">ä¸­æ–‡</option>
        <option value="ko">í•œêµ­ì–´</option>
      </select>

      <button id="saveSettingsBtn">Save</button>
      <button id="cancelSettingsBtn">Cancel</button>
    </div>
  </div>

  <div id="editModal">
    <div class="card">
      <h2>Profile</h2>

      <label id="nameLbl">Name</label>
      <input type="text" id="editName">

      <label id="countryLbl">Country</label>
      <select id="editCountry">
        <option value="">--</option>
        <option value="JP">ğŸ‡¯ğŸ‡µ Japan</option>
        <option value="US">ğŸ‡ºğŸ‡¸ United States</option>
        <option value="KR">ğŸ‡°ğŸ‡· Korea</option>
        <option value="IN">ğŸ‡®ğŸ‡³ India</option>
        <option value="FR">ğŸ‡«ğŸ‡· France</option>
        <option value="DE">ğŸ‡©ğŸ‡ª Germany</option>
        <option value="BR">ğŸ‡§ğŸ‡· Brazil</option>
        <option value="PH">ğŸ‡µğŸ‡­ Philippines</option>
        <option value="TH">ğŸ‡¹ğŸ‡­ Thailand</option>
        <option value="GB">ğŸ‡¬ğŸ‡§ United Kingdom</option>
      </select>

      <label id="levelLbl">Beatbox Level</label>
      <div class="level-selection">
        <select id="editLevel">
          <option value="">--</option>
          <option value="beginner">ğŸ’§ Beginner</option>
          <option value="middle">ğŸŒ± Middle-class</option>
          <option value="advanced">ğŸ”¥ Advanced</option>
          <option value="top">ğŸ† Top Player</option>
        </select>
        <span class="info-icon">â„¹ï¸
          <span class="tooltip"></span>
        </span>
      </div>

      <button id="saveProfileBtn" disabled>Save</button>
      <button id="cancelEditBtn">Cancel</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const texts = {
        en: {
          toggleOn: 'Camera On', toggleOff: 'Camera Off',
          start: 'ğŸš€ Start Battle', cancel: 'âŒ Cancel',
          statusConn: 'Connecting...', statusReady: '',
          statusMatch: 'Matchingâ€¦', statusLeave: 'Opponent left.',
          logout: 'Logout', edit: 'Edit Profile', settings: 'Settings',
          name: 'Name', country: 'Country', level: 'Beatbox Level',
          settingsTitle: 'Settings',
          microphone: 'Microphone',
          micTest: 'Microphone Test',
          testMic: 'Test', stopTest: 'Stop',
          micDetected: 'Microphone detected',
          micNotDetected: 'No microphone detected',
          micGood: 'Microphone is working well',
          micLow: 'Microphone volume too low',
          saveSettings: 'Save', cancelSettings: 'Cancel',
          camera: 'Camera',
          cameraLoading: 'Loading cameras...',
          cameraNotDetected: 'No camera detected',
          speaker: 'Speaker',
          speakerLoading: 'Loading speakers...',
          speakerNotDetected: 'No speaker detected',
          testSpeaker: 'Test Speaker',
          language: 'Language',
          levelGuide:
`ğŸ… Beginner ğŸ’§
 â”” only basic three sounds / <1 yr / no battle experience / mostly spectator

ğŸ… Middle-class ğŸŒ±
 â”” basics stable + some special sounds / 1â€“3 yrs / local battles

ğŸ… Advanced ğŸ”¥
 â”” multiple advanced techniques / 3â€“5 yrs / mid-level contest placements

ğŸ… Top Player ğŸ†
 â”” pro-level / 5+ yrs / national & international titles

â€» The above are only guidelines.`,
        },
        ja: {
          toggleOn: 'ã‚«ãƒ¡ãƒ©ON', toggleOff: 'ã‚«ãƒ¡ãƒ©OFF',
          start: 'ğŸš€ å¯¾æˆ¦ã‚¹ã‚¿ãƒ¼ãƒˆ', cancel: 'âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
          statusConn: 'æ¥ç¶šä¸­...', statusReady: '',
          statusMatch: 'ãƒãƒƒãƒãƒ³ã‚°ä¸­â€¦', statusLeave: 'ç›¸æ‰‹ãŒåˆ‡æ–­ã—ã¾ã—ãŸã€‚',
          logout: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ', edit: 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†', settings: 'è¨­å®š',
          name: 'åå‰', country: 'å›½ç±', level: 'ãƒ¬ãƒ™ãƒ«',
          settingsTitle: 'è¨­å®š',
          microphone: 'ãƒã‚¤ã‚¯',
          micTest: 'ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆ',
          testMic: 'ãƒ†ã‚¹ãƒˆ', stopTest: 'åœæ­¢',
          micDetected: 'ãƒã‚¤ã‚¯ã‚’æ¤œå‡ºã—ã¾ã—ãŸ',
          micNotDetected: 'ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
          micGood: 'ãƒã‚¤ã‚¯ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™',
          micLow: 'éŸ³é‡ãŒå°ã•ã™ãã¾ã™',
          saveSettings: 'ä¿å­˜', cancelSettings: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
          camera: 'ã‚«ãƒ¡ãƒ©',
          cameraLoading: 'ã‚«ãƒ¡ãƒ©ã‚’èª­ã¿è¾¼ã¿ä¸­...',
          cameraNotDetected: 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
          speaker: 'ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼',
          speakerLoading: 'ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...',
          speakerNotDetected: 'ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
          testSpeaker: 'ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒ†ã‚¹ãƒˆ',
          language: 'è¨€èª',
          levelGuide:
`ğŸ… ãƒ“ã‚®ãƒŠãƒ¼ ğŸ’§  
 â”” åŸºç¤3éŸ³ãŒã‚„ã£ã¨ / 1å¹´æœªæº€ / ãƒãƒˆãƒ«æœªçµŒé¨“ / è¦³æˆ¦ãƒ¡ã‚¤ãƒ³

ğŸ… ãƒŸãƒ‰ãƒ«ã‚¯ãƒ©ã‚¹ ğŸŒ±  
 â”” åŸºç¤å®‰å®šï¼‹ç‰¹æ®ŠéŸ³å°‘ã— / 1â€“3å¹´ / ãƒ­ãƒ¼ã‚«ãƒ«å¤§ä¼šçµŒé¨“

ğŸ… ã‚¢ãƒ‰ãƒãƒ³ã‚¹ ğŸ”¥  
 â”” ä¸Šç´šãƒ†ã‚¯ãƒ‹ãƒƒã‚¯è¤‡æ•° / 3â€“5å¹´ / ä¸­è¦æ¨¡å¤§ä¼šå…¥è³

ğŸ… ãƒˆãƒƒãƒ—ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ğŸ†  
 â”” ãƒ—ãƒ­ç´š / 5å¹´ä»¥ä¸Š / å›½å†…å¤–å¤§ä¼šä¸Šä½å¸¸é€£

â€» ä¸Šè¨˜ã®å†…å®¹ã¯ã‚ãã¾ã§ç›®å®‰ã§ã™ã€‚`
        },
        es: {
          toggleOn: 'CÃ¡mara Activada', toggleOff: 'CÃ¡mara Desactivada',
          start: 'ğŸš€ Comenzar Batalla', cancel: 'âŒ Cancelar',
          statusConn: 'Conectando...', statusReady: '',
          statusMatch: 'Buscando rivalâ€¦', statusLeave: 'El oponente se ha ido.',
          logout: 'Cerrar sesiÃ³n', edit: 'Editar Perfil', settings: 'ConfiguraciÃ³n',
          name: 'Nombre', country: 'PaÃ­s', level: 'Nivel de Beatbox',
          settingsTitle: 'ConfiguraciÃ³n',
          microphone: 'MicrÃ³fono',
          micTest: 'Prueba de MicrÃ³fono',
          testMic: 'Probar', stopTest: 'Parar',
          micDetected: 'MicrÃ³fono detectado',
          micNotDetected: 'No se detectÃ³ ningÃºn micrÃ³fono',
          micGood: 'El micrÃ³fono funciona bien',
          micLow: 'Volumen del micrÃ³fono demasiado bajo',
          saveSettings: 'Guardar', cancelSettings: 'Cancelar',
          camera: 'CÃ¡mara',
          cameraLoading: 'Cargando cÃ¡maras...',
          cameraNotDetected: 'No se detectÃ³ ninguna cÃ¡mara',
          speaker: 'Altavoz',
          speakerLoading: 'Cargando altavoces...',
          speakerNotDetected: 'No se detectÃ³ ningÃºn altavoz',
          testSpeaker: 'Probar Altavoz',
          language: 'Idioma',
          levelGuide:
`ğŸ… Principiante ğŸ’§
 â”” solo tres sonidos bÃ¡sicos / <1 aÃ±o / sin experiencia en batallas / principalmente espectador

ğŸ… Clase media ğŸŒ±
 â”” bÃ¡sicos estables + algunos sonidos especiales / 1-3 aÃ±os / batallas locales

ğŸ… Avanzado ğŸ”¥
 â”” mÃºltiples tÃ©cnicas avanzadas / 3-5 aÃ±os / clasificaciones en concursos de nivel medio

ğŸ… Jugador Top ğŸ†
 â”” nivel profesional / 5+ aÃ±os / tÃ­tulos nacionales e internacionales

â€» Lo anterior son solo pautas.`,
        },
        fr: {
          toggleOn: 'CamÃ©ra ActivÃ©e', toggleOff: 'CamÃ©ra DÃ©sactivÃ©e',
          start: 'ğŸš€ Commencer le Combat', cancel: 'âŒ Annuler',
          statusConn: 'Connexion...', statusReady: '',
          statusMatch: 'Recherche d\'adversaireâ€¦', statusLeave: 'L\'adversaire est parti.',
          logout: 'DÃ©connexion', edit: 'Modifier le Profil', settings: 'ParamÃ¨tres',
          name: 'Nom', country: 'Pays', level: 'Niveau de Beatbox',
          settingsTitle: 'ParamÃ¨tres',
          microphone: 'Microphone',
          micTest: 'Test de Microphone',
          testMic: 'Tester', stopTest: 'ArrÃªter',
          micDetected: 'Microphone dÃ©tectÃ©',
          micNotDetected: 'Aucun microphone dÃ©tectÃ©',
          micGood: 'Le microphone fonctionne bien',
          micLow: 'Volume du microphone trop bas',
          saveSettings: 'Enregistrer', cancelSettings: 'Annuler',
          camera: 'CamÃ©ra',
          cameraLoading: 'Chargement des camÃ©ras...',
          cameraNotDetected: 'Aucune camÃ©ra dÃ©tectÃ©e',
          speaker: 'Haut-parleur',
          speakerLoading: 'Chargement des haut-parleurs...',
          speakerNotDetected: 'Aucun haut-parleur dÃ©tectÃ©',
          testSpeaker: 'Tester Haut-parleur',
          language: 'Langue',
          levelGuide:
`ğŸ… DÃ©butant ğŸ’§
 â”” seulement trois sons basiques / <1 an / pas d'expÃ©rience de bataille / principalement spectateur

ğŸ… Classe moyenne ğŸŒ±
 â”” bases stables + quelques sons spÃ©ciaux / 1-3 ans / batailles locales

ğŸ… AvancÃ© ğŸ”¥
 â”” plusieurs techniques avancÃ©es / 3-5 ans / placements dans des concours de niveau intermÃ©diaire

ğŸ… Joueur de haut niveau ğŸ†
 â”” niveau pro / 5+ ans / titres nationaux et internationaux

â€» Ce qui prÃ©cÃ¨de n'est qu'un guide.`,
        },
        zh: {
          toggleOn: 'å¼€å¯æ‘„åƒå¤´', toggleOff: 'å…³é—­æ‘„åƒå¤´',
          start: 'ğŸš€ å¼€å§‹å¯¹æˆ˜', cancel: 'âŒ å–æ¶ˆ',
          statusConn: 'è¿æ¥ä¸­...', statusReady: '',
          statusMatch: 'åŒ¹é…ä¸­â€¦', statusLeave: 'å¯¹æ‰‹å·²ç¦»å¼€ã€‚',
          logout: 'é€€å‡ºç™»å½•', edit: 'ç¼–è¾‘ä¸ªäººèµ„æ–™', settings: 'è®¾ç½®',
          name: 'å§“å', country: 'å›½å®¶', level: 'Beatboxæ°´å¹³',
          settingsTitle: 'è®¾ç½®',
          microphone: 'éº¦å…‹é£',
          micTest: 'éº¦å…‹é£æµ‹è¯•',
          testMic: 'æµ‹è¯•', stopTest: 'åœæ­¢',
          micDetected: 'å·²æ£€æµ‹åˆ°éº¦å…‹é£',
          micNotDetected: 'æœªæ£€æµ‹åˆ°éº¦å…‹é£',
          micGood: 'éº¦å…‹é£å·¥ä½œæ­£å¸¸',
          micLow: 'éº¦å…‹é£éŸ³é‡è¿‡ä½',
          saveSettings: 'ä¿å­˜', cancelSettings: 'å–æ¶ˆ',
          camera: 'æ‘„åƒå¤´',
          cameraLoading: 'æ­£åœ¨åŠ è½½æ‘„åƒå¤´...',
          cameraNotDetected: 'æœªæ£€æµ‹åˆ°æ‘„åƒå¤´',
          speaker: 'æ‰¬å£°å™¨',
          speakerLoading: 'æ­£åœ¨åŠ è½½æ‰¬å£°å™¨...',
          speakerNotDetected: 'æœªæ£€æµ‹åˆ°æ‰¬å£°å™¨',
          testSpeaker: 'æµ‹è¯•æ‰¬å£°å™¨',
          language: 'è¯­è¨€',
          levelGuide:
`ğŸ… åˆå­¦è€… ğŸ’§
 â”” ä»…æŒæ¡ä¸‰ç§åŸºæœ¬éŸ³ / ä¸åˆ°1å¹´ / æ— æ¯”èµ›ç»éªŒ / ä¸»è¦æ˜¯è§‚ä¼—

ğŸ… ä¸­çº§é€‰æ‰‹ ğŸŒ±
 â”” åŸºæœ¬åŠŸç¨³å®š+ä¸€äº›ç‰¹æ®ŠéŸ³ / 1-3å¹´ / å‚åŠ è¿‡åœ°æ–¹æ¯”èµ›

ğŸ… é«˜çº§é€‰æ‰‹ ğŸ”¥
 â”” æŒæ¡å¤šç§é«˜çº§æŠ€å·§ / 3-5å¹´ / ä¸­å‹æ¯”èµ›è·å¥–ç»å†

ğŸ… é¡¶å°–é€‰æ‰‹ ğŸ†
 â”” ä¸“ä¸šçº§åˆ« / 5å¹´ä»¥ä¸Š / å›½å†…å¤–æ¯”èµ›å† å†›

â€» ä»¥ä¸Šä»…ä¸ºå‚è€ƒæ ‡å‡†ã€‚`,
        },
        ko: {
          toggleOn: 'ì¹´ë©”ë¼ ì¼œê¸°', toggleOff: 'ì¹´ë©”ë¼ ë„ê¸°',
          start: 'ğŸš€ ë°°í‹€ ì‹œì‘', cancel: 'âŒ ì·¨ì†Œ',
          statusConn: 'ì—°ê²° ì¤‘...', statusReady: '',
          statusMatch: 'ë§¤ì¹­ ì¤‘â€¦', statusLeave: 'ìƒëŒ€ë°©ì´ ë‚˜ê°”ìŠµë‹ˆë‹¤.',
          logout: 'ë¡œê·¸ì•„ì›ƒ', edit: 'í”„ë¡œí•„ í¸ì§‘', settings: 'ì„¤ì •',
          name: 'ì´ë¦„', country: 'êµ­ê°€', level: 'ë¹„íŠ¸ë°•ìŠ¤ ë ˆë²¨',
          settingsTitle: 'ì„¤ì •',
          microphone: 'ë§ˆì´í¬',
          micTest: 'ë§ˆì´í¬ í…ŒìŠ¤íŠ¸',
          testMic: 'í…ŒìŠ¤íŠ¸', stopTest: 'ì¤‘ì§€',
          micDetected: 'ë§ˆì´í¬ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤',
          micNotDetected: 'ë§ˆì´í¬ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤',
          micGood: 'ë§ˆì´í¬ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤',
          micLow: 'ë§ˆì´í¬ ë³¼ë¥¨ì´ ë„ˆë¬´ ë‚®ìŠµë‹ˆë‹¤',
          saveSettings: 'ì €ì¥', cancelSettings: 'ì·¨ì†Œ',
          camera: 'ì¹´ë©”ë¼',
          cameraLoading: 'ì¹´ë©”ë¼ ë¡œë”© ì¤‘...',
          cameraNotDetected: 'ì¹´ë©”ë¼ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤',
          speaker: 'ìŠ¤í”¼ì»¤',
          speakerLoading: 'ìŠ¤í”¼ì»¤ ë¡œë”© ì¤‘...',
          speakerNotDetected: 'ìŠ¤í”¼ì»¤ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤',
          testSpeaker: 'ìŠ¤í”¼ì»¤ í…ŒìŠ¤íŠ¸',
          language: 'ì–¸ì–´',
          levelGuide:
`ğŸ… ì´ˆë³´ì ğŸ’§
 â”” ê¸°ë³¸ ì„¸ ê°€ì§€ ì†Œë¦¬ë§Œ / 1ë…„ ë¯¸ë§Œ / ë°°í‹€ ê²½í—˜ ì—†ìŒ / ì£¼ë¡œ ê´€ëŒê°

ğŸ… ì¤‘ê¸‰ì ğŸŒ±
 â”” ê¸°ë³¸ê¸° ì•ˆì • + ì¼ë¶€ íŠ¹ìˆ˜ ì†Œë¦¬ / 1-3ë…„ / ë¡œì»¬ ë°°í‹€ ê²½í—˜

ğŸ… ê³ ê¸‰ì ğŸ”¥
 â”” ì—¬ëŸ¬ ê³ ê¸‰ ê¸°ìˆ  ë³´ìœ  / 3-5ë…„ / ì¤‘ê¸‰ ëŒ€íšŒ ì…ìƒ ê²½ë ¥

ğŸ… ìµœìƒìœ„ í”Œë ˆì´ì–´ ğŸ†
 â”” í”„ë¡œ ìˆ˜ì¤€ / 5ë…„ ì´ìƒ / êµ­ë‚´ì™¸ ëŒ€íšŒ ìƒìœ„ê¶Œ

â€» ìœ„ì˜ ë‚´ìš©ì€ ë‹¨ì§€ ê°€ì´ë“œë¼ì¸ì…ë‹ˆë‹¤.`,
        }
      };

      let locale = localStorage.getItem('locale') || 'en';

      const toggle      = document.getElementById('cameraToggle');
      const toggleLbl   = document.getElementById('toggleLabel');
      const startBtn    = document.getElementById('startBattle');
      const cancelBtn   = document.getElementById('cancelBattle');
      const statusEl    = document.getElementById('status');
      const logoutBtn   = document.getElementById('logoutBtn');
      const editBtn     = document.getElementById('editProfileBtn');
      const settingsBtn = document.getElementById('settingsBtn');
      const editModal   = document.getElementById('editModal');
      const settingsModal = document.getElementById('settingsModal');
      const nameInput   = document.getElementById('editName');
      const countryInput= document.getElementById('editCountry');
      const levelInput  = document.getElementById('editLevel');
      const saveBtn     = document.getElementById('saveProfileBtn');
      const cancelEdit  = document.getElementById('cancelEditBtn');
      const tooltipEl   = document.querySelector('.info-icon .tooltip');
      const loader      = document.getElementById('loader');
      
      // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
      const micSelect   = document.getElementById('micSelect');
      const micTestBtn  = document.getElementById('micTestBtn');
      const meterBar    = document.querySelector('.meter-bar');
      const micStatus   = document.getElementById('micStatus');
      const saveSettingsBtn = document.getElementById('saveSettingsBtn');
      const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
      
      // æ–°ã—ã„è¨­å®šé …ç›®ã®DOMè¦ç´ å‚ç…§
      const cameraSelect = document.getElementById('cameraSelect');
      const speakerSelect = document.getElementById('speakerSelect');
      const speakerTestBtn = document.getElementById('speakerTestBtn');
      const settingsLangSelect = document.getElementById('settingsLangSelect');
      
      let audioContext = null;
      let audioStream = null;
      let mediaStreamSource = null;
      let dataArray = null;
      let isTesting = false;
      let animationFrame = null;
      
      // ãƒ‡ãƒã‚¤ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼é–¢é€£
      const micDot = document.getElementById('micDot');
      const speakerDot = document.getElementById('speakerDot');
      const micTooltip = document.getElementById('micTooltip');
      const speakerTooltip = document.getElementById('speakerTooltip');

      function applyText() {
        const t = texts[locale];
        toggleLbl.textContent      = t.toggleOn;
        startBtn.textContent       = t.start;
        cancelBtn.textContent      = t.cancel;
        statusEl.textContent       = t.statusConn;
        logoutBtn.textContent      = 'ğŸšª ' + t.logout;
        editBtn.textContent        = 'âœï¸ ' + t.edit;
        settingsBtn.textContent    = 'âš™ ' + t.settings;
        document.getElementById('nameLbl').textContent    = t.name;
        document.getElementById('countryLbl').textContent = t.country;
        document.getElementById('levelLbl').textContent   = t.level;
        tooltipEl.textContent      = t.levelGuide;
        
        // è¨­å®šé–¢é€£ã®ãƒ†ã‚­ã‚¹ãƒˆ
        document.getElementById('settingsTitle').textContent = t.settingsTitle;
        document.getElementById('micSelectLbl').textContent = t.microphone;
        document.getElementById('micTestLbl').textContent   = t.micTest;
        micTestBtn.textContent     = t.testMic;
        
        // æ–°ã—ã„è¨­å®šé …ç›®ã®ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
        document.getElementById('cameraSelectLbl').textContent = t.camera;
        document.getElementById('speakerSelectLbl').textContent = t.speaker;
        document.getElementById('speakerTestBtn').textContent = t.testSpeaker;
        document.getElementById('langSelectLbl').textContent = t.language;
        
        saveSettingsBtn.textContent = t.saveSettings;
        cancelSettingsBtn.textContent = t.cancelSettings;
        
        document.documentElement.lang = locale;
        settingsLangSelect.value   = locale;
      }
      
      // è¨€èªé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
      settingsLangSelect.addEventListener('change', e => {
        locale = e.target.value;
        localStorage.setItem('locale', locale);
        applyText();
      });
      
      applyText();

      // Camera preview
      async function initPreview() {
        const vid = document.getElementById('previewVideo');
        if (localStorage.getItem('cameraOn') === 'true') {
          try {
            // é¸æŠã—ãŸã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨
            const selectedCameraId = localStorage.getItem('selectedCamera');
            const constraints = {
              video: selectedCameraId 
                ? { deviceId: { exact: selectedCameraId } } 
                : true,
              audio: false
            };
            
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            vid.srcObject = stream;
            toggle.checked = true;
            toggleLbl.textContent = texts[locale].toggleOn;
          } catch {
            toggle.checked = false;
            toggleLbl.textContent = texts[locale].toggleOff;
          }
        } else {
          toggle.checked = false;
          toggleLbl.textContent = texts[locale].toggleOff;
        }
      }
      toggle.addEventListener('change', async e => {
        localStorage.setItem('cameraOn', e.target.checked);
        await initPreview();
      });
      initPreview();

      // Socket logic
      const socket = io();
      socket.on('connect', () => {
        startBtn.disabled = false;
        statusEl.textContent = texts[locale].statusReady;
      });
      startBtn.addEventListener('click', () => {
        startBtn.disabled = true;
        cancelBtn.style.display = 'block';
        loader.style.display = 'flex';
        statusEl.textContent = texts[locale].statusMatch;
        socket.emit('joinBattleQueue');
      });
      cancelBtn.addEventListener('click', () => {
        socket.emit('cancelBattleQueue');
        cancelBtn.style.display = 'none';
        loader.style.display = 'none';
        startBtn.disabled = false;
        statusEl.textContent = texts[locale].statusReady;
      });
      socket.on('matched', ({ roomId }) => {
        loader.style.display = 'none';
        location.href = `/battle.html?room=${encodeURIComponent(roomId)}`;
      });
      socket.on('opponent-left', () => {
        loader.style.display = 'none';
        statusEl.textContent = texts[locale].statusLeave;
        startBtn.disabled = false;
      });

      // Edit Profile modal
      editBtn.addEventListener('click', async () => {
        saveBtn.disabled = true;
        editModal.style.display = 'flex';
        try {
          const res = await fetch('/api/user');
          if (res.ok) {
            const u = await res.json();
            nameInput.value    = u.name;
            countryInput.value = u.country;
            levelInput.value   = u.level;
          }
        } catch {}
        [nameInput, countryInput, levelInput].forEach(el =>
          el.addEventListener('input', () => {
            saveBtn.disabled = !(nameInput.value.trim() && countryInput.value && levelInput.value);
          })
        );
      });
      cancelEdit.addEventListener('click', () => {
        editModal.style.display = 'none';
      });
      saveBtn.addEventListener('click', async () => {
        const body = {
          name:    nameInput.value.trim(),
          country: countryInput.value,
          level:   levelInput.value
        };
        const r = await fetch('/api/user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (r.ok) editModal.style.display = 'none';
      });

      // Logout
      logoutBtn.addEventListener('click', () => {
        location.href = '/logout';
      });

      // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
      settingsBtn.addEventListener('click', async () => {
        settingsModal.style.display = 'flex';
        await loadAvailableMicrophones();
        await loadAvailableCameras();
        await loadAvailableSpeakers();
        
        // è¨€èªé¸æŠã®åˆæœŸå€¤è¨­å®š
        settingsLangSelect.value = locale;
        
        // ãƒ‡ãƒã‚¤ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
        updateDeviceIndicators();
      });
      
      // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      speakerTestBtn.addEventListener('click', () => {
        testSpeaker();
      });
      
      cancelSettingsBtn.addEventListener('click', () => {
        stopMicTest();
        settingsModal.style.display = 'none';
      });
      
      // ãƒ‡ãƒã‚¤ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
      async function updateDeviceIndicators() {
        try {
          // åˆ©ç”¨å¯èƒ½ãªãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—
          const devices = await navigator.mediaDevices.enumerateDevices();
          
          // ãƒã‚¤ã‚¯ã®ç¢ºèª
          const mics = devices.filter(device => device.kind === 'audioinput');
          const selectedMicId = localStorage.getItem('selectedMic');
          
          if (mics.length > 0) {
            micDot.classList.add('active');
            // é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒã‚¤ã‚¯ãŒã‚ã‚Œã°ãã®åå‰ã‚’ã€ãªã‘ã‚Œã°æœ€åˆã®ãƒã‚¤ã‚¯ã®åå‰ã‚’è¡¨ç¤º
            const selectedMic = mics.find(mic => mic.deviceId === selectedMicId) || mics[0];
            micTooltip.textContent = selectedMic.label || 'Default microphone';
          } else {
            micDot.classList.remove('active');
            micTooltip.textContent = texts[locale].micNotDetected || 'No microphone';
          }
          
          // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã®ç¢ºèª
          const speakers = devices.filter(device => device.kind === 'audiooutput');
          const selectedSpeakerId = localStorage.getItem('selectedSpeaker');
          
          if (speakers.length > 0 || 'sinkId' in HTMLMediaElement.prototype) {
            speakerDot.classList.add('active');
            
            // é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãŒã‚ã‚Œã°ãã®åå‰ã‚’è¡¨ç¤º
            if (selectedSpeakerId && selectedSpeakerId !== 'default') {
              const selectedSpeaker = speakers.find(speaker => speaker.deviceId === selectedSpeakerId);
              speakerTooltip.textContent = selectedSpeaker ? selectedSpeaker.label : 'Default speaker';
            } else {
              speakerTooltip.textContent = 'Default speaker';
            }
          } else {
            speakerDot.classList.remove('active');
            speakerTooltip.textContent = texts[locale].speakerNotDetected || 'No speaker';
          }
        } catch (err) {
          console.error('ãƒ‡ãƒã‚¤ã‚¹ã®ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', err);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’ã‚ªãƒ•ã«ã™ã‚‹
          micDot.classList.remove('active');
          speakerDot.classList.remove('active');
        }
      }
      
      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒã‚¤ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
      updateDeviceIndicators();
      
      // è¨­å®šãŒä¿å­˜ã•ã‚ŒãŸæ™‚ã‚‚ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
      saveSettingsBtn.addEventListener('click', () => {
        stopMicTest();
        
        // è¨­å®šã®ä¿å­˜å‡¦ç†
        const selectedMic = micSelect.value;
        const selectedCamera = cameraSelect.value;
        const selectedSpeaker = speakerSelect.value;
        
        if (selectedMic) {
          localStorage.setItem('selectedMic', selectedMic);
        }
        
        if (selectedCamera) {
          localStorage.setItem('selectedCamera', selectedCamera);
        }
        
        if (selectedSpeaker) {
          localStorage.setItem('selectedSpeaker', selectedSpeaker);
        }
        
        // è¨€èªè¨­å®šã®ä¿å­˜
        localStorage.setItem('locale', locale);
        
        // ã‚«ãƒ¡ãƒ©ON/OFFçŠ¶æ…‹ã®æ›´æ–°ï¼ˆã‚«ãƒ¡ãƒ©ã®é¸æŠãŒå¤‰ã‚ã£ãŸå ´åˆã«ã‚‚å¯¾å¿œï¼‰
        if (toggle.checked) {
          initPreview();
        }
        
        // ãƒ‡ãƒã‚¤ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
        updateDeviceIndicators();
        
        settingsModal.style.display = 'none';
      });
      
      // ãƒã‚¤ã‚¯ä¸€è¦§ã®èª­ã¿è¾¼ã¿
      async function loadAvailableMicrophones() {
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const mics = devices.filter(device => device.kind === 'audioinput');
          
          // ãƒã‚¤ã‚¯é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
          micSelect.innerHTML = '';
          
          if (mics.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = texts[locale].micNotDetected;
            micSelect.appendChild(option);
            micStatus.textContent = '';
            return;
          }
          
          // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒã‚¤ã‚¯
          const selectedMicId = localStorage.getItem('selectedMic') || '';
          
          mics.forEach(mic => {
            const option = document.createElement('option');
            option.value = mic.deviceId;
            option.textContent = mic.label || `Microphone ${micSelect.options.length + 1}`;
            option.selected = mic.deviceId === selectedMicId;
            micSelect.appendChild(option);
          });
          
          micStatus.textContent = '';
          
          // ãƒ‡ãƒã‚¤ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
          updateDeviceIndicators();
        } catch (err) {
          console.error('ãƒã‚¤ã‚¯ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
          micSelect.innerHTML = `<option value="">${texts[locale].micNotDetected}</option>`;
          micStatus.textContent = '';
        }
      }
      
      // ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆ
      micTestBtn.addEventListener('click', () => {
        if (isTesting) {
          stopMicTest();
        } else {
          startMicTest();
        }
      });
      
      async function startMicTest() {
        try {
          // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆæœŸåŒ–
          if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }
          
          // é¸æŠã—ãŸãƒã‚¤ã‚¯ã‚’ä½¿ç”¨
          const constraints = {
            audio: {
              deviceId: micSelect.value ? { exact: micSelect.value } : undefined
            }
          };
          
          audioStream = await navigator.mediaDevices.getUserMedia(constraints);
          
          // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªåˆ†æã®è¨­å®š
          mediaStreamSource = audioContext.createMediaStreamSource(audioStream);
          audioAnalyser = audioContext.createAnalyser();
          audioAnalyser.fftSize = 256;
          
          mediaStreamSource.connect(audioAnalyser);
          
          dataArray = new Uint8Array(audioAnalyser.frequencyBinCount);
          
          // UIæ›´æ–°
          isTesting = true;
          micTestBtn.textContent = texts[locale].stopTest;
          micTestBtn.classList.add('testing');
          
          // éŸ³é‡ãƒ¡ãƒ¼ã‚¿ãƒ¼æ›´æ–°ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
          updateMeter();
          
        } catch (err) {
          console.error('ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
          micStatus.textContent = '';
        }
      }
      
      function stopMicTest() {
        if (!isTesting) return;
        
        // éŸ³é‡ãƒ¡ãƒ¼ã‚¿ãƒ¼æ›´æ–°ãƒ«ãƒ¼ãƒ—ã‚’åœæ­¢
        if (animationFrame) {
          cancelAnimationFrame(animationFrame);
          animationFrame = null;
        }
        
        // ãƒã‚¤ã‚¯ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
        if (audioStream) {
          audioStream.getTracks().forEach(track => track.stop());
          audioStream = null;
        }
        
        // UIæ›´æ–°
        isTesting = false;
        micTestBtn.textContent = texts[locale].testMic;
        micTestBtn.classList.remove('testing');
        meterBar.style.width = '0%';
        micStatus.textContent = '';
      }
      
      function updateMeter() {
        if (!audioAnalyser || !isTesting) return;
        
        audioAnalyser.getByteFrequencyData(dataArray);
        
        // éŸ³é‡ãƒ¬ãƒ™ãƒ«ã®è¨ˆç®— (å¹³å‡å€¤)
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
          sum += dataArray[i];
        }
        const average = sum / dataArray.length;
        
        // 0-255 ã®å€¤ã‚’ 0-100% ã«å¤‰æ›
        const volume = Math.min(100, Math.max(0, average / 2.55));
        
        // ãƒ¡ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ã®æ›´æ–°
        meterBar.style.width = `${volume}%`;
        
        // éŸ³é‡ã«å¿œã˜ãŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯è¡¨ç¤ºã—ãªã„
        micStatus.textContent = '';
        
        // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§å†åº¦æ›´æ–°
        animationFrame = requestAnimationFrame(updateMeter);
      }

      // ã‚«ãƒ¡ãƒ©ä¸€è¦§ã®èª­ã¿è¾¼ã¿
      async function loadAvailableCameras() {
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const cameras = devices.filter(device => device.kind === 'videoinput');
          
          // ã‚«ãƒ¡ãƒ©é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
          cameraSelect.innerHTML = '';
          
          if (cameras.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = texts[locale].cameraNotDetected;
            cameraSelect.appendChild(option);
            return;
          }
          
          // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ¡ãƒ©
          const selectedCameraId = localStorage.getItem('selectedCamera') || '';
          
          cameras.forEach(camera => {
            const option = document.createElement('option');
            option.value = camera.deviceId;
            option.textContent = camera.label || `Camera ${cameraSelect.options.length + 1}`;
            option.selected = camera.deviceId === selectedCameraId;
            cameraSelect.appendChild(option);
          });
          
        } catch (err) {
          console.error('ã‚«ãƒ¡ãƒ©ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
          cameraSelect.innerHTML = `<option value="">${texts[locale].cameraNotDetected}</option>`;
        }
      }
      
      // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ä¸€è¦§ã®èª­ã¿è¾¼ã¿
      async function loadAvailableSpeakers() {
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const speakers = devices.filter(device => device.kind === 'audiooutput');
          
          // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
          speakerSelect.innerHTML = '';
          
          if (speakers.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = texts[locale].speakerNotDetected;
            speakerSelect.appendChild(option);
            return;
          }
          
          // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼
          const selectedSpeakerId = localStorage.getItem('selectedSpeaker') || '';
          
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒã‚¤ã‚¹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
          const defaultOption = document.createElement('option');
          defaultOption.value = 'default';
          defaultOption.textContent = 'Default Speaker';
          defaultOption.selected = selectedSpeakerId === 'default' || !selectedSpeakerId;
          speakerSelect.appendChild(defaultOption);
          
          speakers.forEach(speaker => {
            const option = document.createElement('option');
            option.value = speaker.deviceId;
            option.textContent = speaker.label || `Speaker ${speakerSelect.options.length}`;
            option.selected = speaker.deviceId === selectedSpeakerId;
            speakerSelect.appendChild(option);
          });
          
          // ãƒ‡ãƒã‚¤ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
          updateDeviceIndicators();
        } catch (err) {
          console.error('ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
          speakerSelect.innerHTML = `<option value="">${texts[locale].speakerNotDetected}</option>`;
        }
      }
      
      // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒ†ã‚¹ãƒˆ
      async function testSpeaker() {
        const selectedSpeaker = speakerSelect.value;
        
        // æ–°ã—ã„WebAudio APIã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚¹ãƒˆéŸ³å£°
        try {
          // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
          speakerTestBtn.disabled = true;
          
          // éŸ³å£°ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          let audioContext;
          if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }
          
          // éŸ³å£°ã®å‡ºåŠ›å…ˆã‚’è¨­å®š
          let destination = audioContext.destination;
          
          // AudioContextã®destinationã‚’ç‰¹å®šã®ãƒ‡ãƒã‚¤ã‚¹ã«è¨­å®šï¼ˆå¯èƒ½ãªå ´åˆï¼‰
          if (selectedSpeaker && audioContext.setSinkId) {
            try {
              await audioContext.setSinkId(selectedSpeaker);
            } catch (err) {
              console.warn('setSinkIdã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“:', err);
            }
          }
          
          // ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½œæˆï¼ˆéŸ³ã‚’ç”Ÿæˆï¼‰
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          // ã‚µã‚¤ãƒ³æ³¢ã§440Hzï¼ˆAéŸ³ï¼‰ã‚’è¨­å®š
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
          
          // éŸ³é‡ã‚’èª¿æ•´
          gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
          
          // ãƒãƒ¼ãƒ‰ã‚’æ¥ç¶š
          oscillator.connect(gainNode);
          gainNode.connect(destination);
          
          // éŸ³ã‚’å†ç”Ÿï¼ˆ0.5ç§’é–“ï¼‰
          oscillator.start();
          oscillator.stop(audioContext.currentTime + 0.5);
          
          // å†ç”Ÿå®Œäº†æ™‚ã«ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
          setTimeout(() => {
            speakerTestBtn.disabled = false;
          }, 600);
          
          // ã‚‚ã—OscillatorãŒä½¿ãˆãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          oscillator.onended = () => {
            speakerTestBtn.disabled = false;
          };
        } catch (err) {
          console.error('WebAudio APIã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚Audioè¦ç´ ã§ã®ãƒ†ã‚¹ãƒˆã‚’è©¦ã¿ã¾ã™:', err);
          
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®Audioè¦ç´ ã‚’ä½¿ã†æ–¹æ³•
          try {
            const audio = new Audio();
            
            // ãƒ“ãƒ¼ãƒ—éŸ³ã®Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
            audio.src = 'data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAA1N3aXRjaCBQbHVzIMKpIE5DSCBTb2Z0d2FyZQBUSVQyAAAABgAAAzIyMzUAVFNTRQAAAA8AAANMYXZmNTcuODMuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAATEFNRTMuMTAwVVVVVVVVVVVVVUxBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQsRbAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQMSkAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV';
            
            // é¸æŠã—ãŸã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã§å†ç”Ÿï¼ˆå¯èƒ½ãªå ´åˆï¼‰
            if (selectedSpeaker && audio.setSinkId) {
              try {
                await audio.setSinkId(selectedSpeaker);
              } catch (err) {
                console.warn('setSinkIdã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“:', err);
              }
            }
            
            // å†ç”Ÿ
            audio.play();
            
            // å†ç”Ÿå®Œäº†æ™‚ã«ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
            audio.onended = () => {
              speakerTestBtn.disabled = false;
            };
            
            // 3ç§’å¾Œã«å¼·åˆ¶çš„ã«ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–ï¼ˆã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãŒçµ‚äº†ã—ãªã‹ã£ãŸå ´åˆã®ä¿é™ºï¼‰
            setTimeout(() => {
              speakerTestBtn.disabled = false;
            }, 3000);
          } catch (audioErr) {
            console.error('Audioè¦ç´ ã§ã®ãƒ†ã‚¹ãƒˆã«ã‚‚å¤±æ•—ã—ã¾ã—ãŸ:', audioErr);
            speakerTestBtn.disabled = false;
          }
        }
      }
    });
  </script>
</body>
</html>
